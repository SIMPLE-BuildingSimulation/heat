<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Source of the Rust file `src/surface.rs`."><meta name="keywords" content="rust, rustlang, rust-lang"><title>surface.rs - source</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../../SourceSerif4-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../FiraSans-Regular.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../FiraSans-Medium.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../SourceCodePro-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../SourceSerif4-Bold.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../SourceCodePro-Semibold.ttf.woff2"><link rel="stylesheet" href="../../normalize.css"><link rel="stylesheet" href="../../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" href="../../ayu.css" disabled><link rel="stylesheet" href="../../dark.css" disabled><link rel="stylesheet" href="../../light.css" id="themeStyle"><script id="default-settings" ></script><script src="../../storage.js"></script><script defer src="../../source-script.js"></script><script defer src="../../source-files.js"></script><script defer src="../../main.js"></script><noscript><link rel="stylesheet" href="../../noscript.css"></noscript><link rel="alternate icon" type="image/png" href="../../favicon-16x16.png"><link rel="alternate icon" type="image/png" href="../../favicon-32x32.png"><link rel="icon" type="image/svg+xml" href="../../favicon.svg"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.9.0/dist/katex.min.css" integrity="sha384-TEMocfGvRuD1rIAacqrknm5BQZ7W7uWitoih+jMNFXQIbNl16bO8OZmylH/Vi/Ei" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/katex@0.9.0/dist/katex.min.js" integrity="sha384-jmxIlussZWB7qCuB+PgKG1uLjjxbVVIayPJwi6cG6Zb4YKq0JIw+OMnkkEC7kYCq" crossorigin="anonymous"></script>
<script>
  "use strict";
  document.addEventListener("DOMContentLoaded", function () {
      var maths = document.getElementsByClassName("language-math");
      for (var i=0; i<maths.length; i++) {
          var el = maths[i];
          katex.render(el.innerText, el, {displayMode: true});
      }

      var codes = document.getElementsByTagName("code");
      for (i=0; i<codes.length; i++) {
          el = codes[i];
          if (el.classList.contains("language-math")) continue;
          if (el.classList.contains("language-inline-math")) {
              katex.render(el.innerText, el);
              continue;
          }

          var parent = el.parentNode;
          if (parent.nodeName.toLowerCase() === "pre") continue;
          // TODO: Can this be done with DOM manipulation rather than string manipulation?
          // https://stackoverflow.com/q/48438067/3019990
          var inlineMath = "$" + el.outerHTML + "$";
          if (parent.innerHTML.indexOf(inlineMath) !== -1) {
              el.classList.add("language-inline-math");
              parent.innerHTML = parent.innerHTML.replace("$" + el.outerHTML + "$", el.outerHTML);
              i--;
          }
      }
  });
</script>

</head><body class="rustdoc source"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="sidebar-logo" href="../../heat/index.html"><div class="logo-container"><img class="rust-logo" src="../../rust-logo.svg" alt="logo"></div></a><h2 class="location"></h2></nav><nav class="sidebar"><a class="sidebar-logo" href="../../heat/index.html"><div class="logo-container"><img class="rust-logo" src="../../rust-logo.svg" alt="logo"></div></a></nav><main><div class="width-limiter"><div class="sub-container"><a class="sub-logo-container" href="../../heat/index.html"><img class="rust-logo" src="../../rust-logo.svg" alt="logo"></a><nav class="sub"><form class="search-form"><div class="search-container"><span></span><input class="search-input" name="search" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><div id="help-button" title="help" tabindex="-1"><button type="button">?</button></div><div id="settings-menu" tabindex="-1"><a href="../../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../../wheel.svg"></a></div></div></form></nav></div><section id="main-content" class="content"><div class="example-wrap"><pre class="line-numbers"><span id="1">1</span>
<span id="2">2</span>
<span id="3">3</span>
<span id="4">4</span>
<span id="5">5</span>
<span id="6">6</span>
<span id="7">7</span>
<span id="8">8</span>
<span id="9">9</span>
<span id="10">10</span>
<span id="11">11</span>
<span id="12">12</span>
<span id="13">13</span>
<span id="14">14</span>
<span id="15">15</span>
<span id="16">16</span>
<span id="17">17</span>
<span id="18">18</span>
<span id="19">19</span>
<span id="20">20</span>
<span id="21">21</span>
<span id="22">22</span>
<span id="23">23</span>
<span id="24">24</span>
<span id="25">25</span>
<span id="26">26</span>
<span id="27">27</span>
<span id="28">28</span>
<span id="29">29</span>
<span id="30">30</span>
<span id="31">31</span>
<span id="32">32</span>
<span id="33">33</span>
<span id="34">34</span>
<span id="35">35</span>
<span id="36">36</span>
<span id="37">37</span>
<span id="38">38</span>
<span id="39">39</span>
<span id="40">40</span>
<span id="41">41</span>
<span id="42">42</span>
<span id="43">43</span>
<span id="44">44</span>
<span id="45">45</span>
<span id="46">46</span>
<span id="47">47</span>
<span id="48">48</span>
<span id="49">49</span>
<span id="50">50</span>
<span id="51">51</span>
<span id="52">52</span>
<span id="53">53</span>
<span id="54">54</span>
<span id="55">55</span>
<span id="56">56</span>
<span id="57">57</span>
<span id="58">58</span>
<span id="59">59</span>
<span id="60">60</span>
<span id="61">61</span>
<span id="62">62</span>
<span id="63">63</span>
<span id="64">64</span>
<span id="65">65</span>
<span id="66">66</span>
<span id="67">67</span>
<span id="68">68</span>
<span id="69">69</span>
<span id="70">70</span>
<span id="71">71</span>
<span id="72">72</span>
<span id="73">73</span>
<span id="74">74</span>
<span id="75">75</span>
<span id="76">76</span>
<span id="77">77</span>
<span id="78">78</span>
<span id="79">79</span>
<span id="80">80</span>
<span id="81">81</span>
<span id="82">82</span>
<span id="83">83</span>
<span id="84">84</span>
<span id="85">85</span>
<span id="86">86</span>
<span id="87">87</span>
<span id="88">88</span>
<span id="89">89</span>
<span id="90">90</span>
<span id="91">91</span>
<span id="92">92</span>
<span id="93">93</span>
<span id="94">94</span>
<span id="95">95</span>
<span id="96">96</span>
<span id="97">97</span>
<span id="98">98</span>
<span id="99">99</span>
<span id="100">100</span>
<span id="101">101</span>
<span id="102">102</span>
<span id="103">103</span>
<span id="104">104</span>
<span id="105">105</span>
<span id="106">106</span>
<span id="107">107</span>
<span id="108">108</span>
<span id="109">109</span>
<span id="110">110</span>
<span id="111">111</span>
<span id="112">112</span>
<span id="113">113</span>
<span id="114">114</span>
<span id="115">115</span>
<span id="116">116</span>
<span id="117">117</span>
<span id="118">118</span>
<span id="119">119</span>
<span id="120">120</span>
<span id="121">121</span>
<span id="122">122</span>
<span id="123">123</span>
<span id="124">124</span>
<span id="125">125</span>
<span id="126">126</span>
<span id="127">127</span>
<span id="128">128</span>
<span id="129">129</span>
<span id="130">130</span>
<span id="131">131</span>
<span id="132">132</span>
<span id="133">133</span>
<span id="134">134</span>
<span id="135">135</span>
<span id="136">136</span>
<span id="137">137</span>
<span id="138">138</span>
<span id="139">139</span>
<span id="140">140</span>
<span id="141">141</span>
<span id="142">142</span>
<span id="143">143</span>
<span id="144">144</span>
<span id="145">145</span>
<span id="146">146</span>
<span id="147">147</span>
<span id="148">148</span>
<span id="149">149</span>
<span id="150">150</span>
<span id="151">151</span>
<span id="152">152</span>
<span id="153">153</span>
<span id="154">154</span>
<span id="155">155</span>
<span id="156">156</span>
<span id="157">157</span>
<span id="158">158</span>
<span id="159">159</span>
<span id="160">160</span>
<span id="161">161</span>
<span id="162">162</span>
<span id="163">163</span>
<span id="164">164</span>
<span id="165">165</span>
<span id="166">166</span>
<span id="167">167</span>
<span id="168">168</span>
<span id="169">169</span>
<span id="170">170</span>
<span id="171">171</span>
<span id="172">172</span>
<span id="173">173</span>
<span id="174">174</span>
<span id="175">175</span>
<span id="176">176</span>
<span id="177">177</span>
<span id="178">178</span>
<span id="179">179</span>
<span id="180">180</span>
<span id="181">181</span>
<span id="182">182</span>
<span id="183">183</span>
<span id="184">184</span>
<span id="185">185</span>
<span id="186">186</span>
<span id="187">187</span>
<span id="188">188</span>
<span id="189">189</span>
<span id="190">190</span>
<span id="191">191</span>
<span id="192">192</span>
<span id="193">193</span>
<span id="194">194</span>
<span id="195">195</span>
<span id="196">196</span>
<span id="197">197</span>
<span id="198">198</span>
<span id="199">199</span>
<span id="200">200</span>
<span id="201">201</span>
<span id="202">202</span>
<span id="203">203</span>
<span id="204">204</span>
<span id="205">205</span>
<span id="206">206</span>
<span id="207">207</span>
<span id="208">208</span>
<span id="209">209</span>
<span id="210">210</span>
<span id="211">211</span>
<span id="212">212</span>
<span id="213">213</span>
<span id="214">214</span>
<span id="215">215</span>
<span id="216">216</span>
<span id="217">217</span>
<span id="218">218</span>
<span id="219">219</span>
<span id="220">220</span>
<span id="221">221</span>
<span id="222">222</span>
<span id="223">223</span>
<span id="224">224</span>
<span id="225">225</span>
<span id="226">226</span>
<span id="227">227</span>
<span id="228">228</span>
<span id="229">229</span>
<span id="230">230</span>
<span id="231">231</span>
<span id="232">232</span>
<span id="233">233</span>
<span id="234">234</span>
<span id="235">235</span>
<span id="236">236</span>
<span id="237">237</span>
<span id="238">238</span>
<span id="239">239</span>
<span id="240">240</span>
<span id="241">241</span>
<span id="242">242</span>
<span id="243">243</span>
<span id="244">244</span>
<span id="245">245</span>
<span id="246">246</span>
<span id="247">247</span>
<span id="248">248</span>
<span id="249">249</span>
<span id="250">250</span>
<span id="251">251</span>
<span id="252">252</span>
<span id="253">253</span>
<span id="254">254</span>
<span id="255">255</span>
<span id="256">256</span>
<span id="257">257</span>
<span id="258">258</span>
<span id="259">259</span>
<span id="260">260</span>
<span id="261">261</span>
<span id="262">262</span>
<span id="263">263</span>
<span id="264">264</span>
<span id="265">265</span>
<span id="266">266</span>
<span id="267">267</span>
<span id="268">268</span>
<span id="269">269</span>
<span id="270">270</span>
<span id="271">271</span>
<span id="272">272</span>
<span id="273">273</span>
<span id="274">274</span>
<span id="275">275</span>
<span id="276">276</span>
<span id="277">277</span>
<span id="278">278</span>
<span id="279">279</span>
<span id="280">280</span>
<span id="281">281</span>
<span id="282">282</span>
<span id="283">283</span>
<span id="284">284</span>
<span id="285">285</span>
<span id="286">286</span>
<span id="287">287</span>
<span id="288">288</span>
<span id="289">289</span>
<span id="290">290</span>
<span id="291">291</span>
<span id="292">292</span>
<span id="293">293</span>
<span id="294">294</span>
<span id="295">295</span>
<span id="296">296</span>
<span id="297">297</span>
<span id="298">298</span>
<span id="299">299</span>
<span id="300">300</span>
<span id="301">301</span>
<span id="302">302</span>
<span id="303">303</span>
<span id="304">304</span>
<span id="305">305</span>
<span id="306">306</span>
<span id="307">307</span>
<span id="308">308</span>
<span id="309">309</span>
<span id="310">310</span>
<span id="311">311</span>
<span id="312">312</span>
<span id="313">313</span>
<span id="314">314</span>
<span id="315">315</span>
<span id="316">316</span>
<span id="317">317</span>
<span id="318">318</span>
<span id="319">319</span>
<span id="320">320</span>
<span id="321">321</span>
<span id="322">322</span>
<span id="323">323</span>
<span id="324">324</span>
<span id="325">325</span>
<span id="326">326</span>
<span id="327">327</span>
<span id="328">328</span>
<span id="329">329</span>
<span id="330">330</span>
<span id="331">331</span>
<span id="332">332</span>
<span id="333">333</span>
<span id="334">334</span>
<span id="335">335</span>
<span id="336">336</span>
<span id="337">337</span>
<span id="338">338</span>
<span id="339">339</span>
<span id="340">340</span>
<span id="341">341</span>
<span id="342">342</span>
<span id="343">343</span>
<span id="344">344</span>
<span id="345">345</span>
<span id="346">346</span>
<span id="347">347</span>
<span id="348">348</span>
<span id="349">349</span>
<span id="350">350</span>
<span id="351">351</span>
<span id="352">352</span>
<span id="353">353</span>
<span id="354">354</span>
<span id="355">355</span>
<span id="356">356</span>
<span id="357">357</span>
<span id="358">358</span>
<span id="359">359</span>
<span id="360">360</span>
<span id="361">361</span>
<span id="362">362</span>
<span id="363">363</span>
<span id="364">364</span>
<span id="365">365</span>
<span id="366">366</span>
<span id="367">367</span>
<span id="368">368</span>
<span id="369">369</span>
<span id="370">370</span>
<span id="371">371</span>
<span id="372">372</span>
<span id="373">373</span>
<span id="374">374</span>
<span id="375">375</span>
<span id="376">376</span>
<span id="377">377</span>
<span id="378">378</span>
<span id="379">379</span>
<span id="380">380</span>
<span id="381">381</span>
<span id="382">382</span>
<span id="383">383</span>
<span id="384">384</span>
<span id="385">385</span>
<span id="386">386</span>
<span id="387">387</span>
<span id="388">388</span>
<span id="389">389</span>
<span id="390">390</span>
<span id="391">391</span>
<span id="392">392</span>
<span id="393">393</span>
<span id="394">394</span>
<span id="395">395</span>
<span id="396">396</span>
<span id="397">397</span>
<span id="398">398</span>
<span id="399">399</span>
<span id="400">400</span>
<span id="401">401</span>
<span id="402">402</span>
<span id="403">403</span>
<span id="404">404</span>
<span id="405">405</span>
<span id="406">406</span>
<span id="407">407</span>
<span id="408">408</span>
<span id="409">409</span>
<span id="410">410</span>
<span id="411">411</span>
<span id="412">412</span>
<span id="413">413</span>
<span id="414">414</span>
<span id="415">415</span>
<span id="416">416</span>
<span id="417">417</span>
<span id="418">418</span>
<span id="419">419</span>
<span id="420">420</span>
<span id="421">421</span>
<span id="422">422</span>
<span id="423">423</span>
<span id="424">424</span>
<span id="425">425</span>
<span id="426">426</span>
<span id="427">427</span>
<span id="428">428</span>
<span id="429">429</span>
<span id="430">430</span>
<span id="431">431</span>
<span id="432">432</span>
<span id="433">433</span>
<span id="434">434</span>
<span id="435">435</span>
<span id="436">436</span>
<span id="437">437</span>
<span id="438">438</span>
<span id="439">439</span>
<span id="440">440</span>
<span id="441">441</span>
<span id="442">442</span>
<span id="443">443</span>
<span id="444">444</span>
<span id="445">445</span>
<span id="446">446</span>
<span id="447">447</span>
<span id="448">448</span>
<span id="449">449</span>
<span id="450">450</span>
<span id="451">451</span>
<span id="452">452</span>
<span id="453">453</span>
<span id="454">454</span>
<span id="455">455</span>
<span id="456">456</span>
<span id="457">457</span>
<span id="458">458</span>
<span id="459">459</span>
<span id="460">460</span>
<span id="461">461</span>
<span id="462">462</span>
<span id="463">463</span>
<span id="464">464</span>
<span id="465">465</span>
<span id="466">466</span>
<span id="467">467</span>
<span id="468">468</span>
<span id="469">469</span>
<span id="470">470</span>
<span id="471">471</span>
<span id="472">472</span>
<span id="473">473</span>
<span id="474">474</span>
<span id="475">475</span>
<span id="476">476</span>
<span id="477">477</span>
<span id="478">478</span>
<span id="479">479</span>
<span id="480">480</span>
<span id="481">481</span>
<span id="482">482</span>
<span id="483">483</span>
<span id="484">484</span>
<span id="485">485</span>
<span id="486">486</span>
<span id="487">487</span>
<span id="488">488</span>
<span id="489">489</span>
<span id="490">490</span>
<span id="491">491</span>
<span id="492">492</span>
<span id="493">493</span>
<span id="494">494</span>
<span id="495">495</span>
<span id="496">496</span>
<span id="497">497</span>
<span id="498">498</span>
<span id="499">499</span>
<span id="500">500</span>
<span id="501">501</span>
<span id="502">502</span>
<span id="503">503</span>
<span id="504">504</span>
<span id="505">505</span>
<span id="506">506</span>
<span id="507">507</span>
<span id="508">508</span>
<span id="509">509</span>
<span id="510">510</span>
<span id="511">511</span>
<span id="512">512</span>
<span id="513">513</span>
<span id="514">514</span>
<span id="515">515</span>
<span id="516">516</span>
<span id="517">517</span>
<span id="518">518</span>
<span id="519">519</span>
<span id="520">520</span>
<span id="521">521</span>
<span id="522">522</span>
<span id="523">523</span>
<span id="524">524</span>
<span id="525">525</span>
<span id="526">526</span>
<span id="527">527</span>
<span id="528">528</span>
<span id="529">529</span>
<span id="530">530</span>
<span id="531">531</span>
<span id="532">532</span>
<span id="533">533</span>
<span id="534">534</span>
<span id="535">535</span>
<span id="536">536</span>
<span id="537">537</span>
<span id="538">538</span>
<span id="539">539</span>
<span id="540">540</span>
<span id="541">541</span>
<span id="542">542</span>
<span id="543">543</span>
<span id="544">544</span>
<span id="545">545</span>
<span id="546">546</span>
<span id="547">547</span>
<span id="548">548</span>
<span id="549">549</span>
<span id="550">550</span>
<span id="551">551</span>
<span id="552">552</span>
<span id="553">553</span>
<span id="554">554</span>
<span id="555">555</span>
<span id="556">556</span>
<span id="557">557</span>
<span id="558">558</span>
<span id="559">559</span>
<span id="560">560</span>
<span id="561">561</span>
<span id="562">562</span>
<span id="563">563</span>
<span id="564">564</span>
<span id="565">565</span>
<span id="566">566</span>
<span id="567">567</span>
<span id="568">568</span>
<span id="569">569</span>
<span id="570">570</span>
<span id="571">571</span>
<span id="572">572</span>
<span id="573">573</span>
<span id="574">574</span>
<span id="575">575</span>
<span id="576">576</span>
<span id="577">577</span>
<span id="578">578</span>
<span id="579">579</span>
<span id="580">580</span>
<span id="581">581</span>
<span id="582">582</span>
<span id="583">583</span>
<span id="584">584</span>
<span id="585">585</span>
<span id="586">586</span>
<span id="587">587</span>
<span id="588">588</span>
<span id="589">589</span>
<span id="590">590</span>
<span id="591">591</span>
<span id="592">592</span>
<span id="593">593</span>
<span id="594">594</span>
<span id="595">595</span>
<span id="596">596</span>
<span id="597">597</span>
<span id="598">598</span>
<span id="599">599</span>
<span id="600">600</span>
<span id="601">601</span>
<span id="602">602</span>
<span id="603">603</span>
<span id="604">604</span>
<span id="605">605</span>
<span id="606">606</span>
<span id="607">607</span>
<span id="608">608</span>
<span id="609">609</span>
<span id="610">610</span>
<span id="611">611</span>
<span id="612">612</span>
<span id="613">613</span>
<span id="614">614</span>
<span id="615">615</span>
<span id="616">616</span>
<span id="617">617</span>
<span id="618">618</span>
<span id="619">619</span>
<span id="620">620</span>
<span id="621">621</span>
<span id="622">622</span>
<span id="623">623</span>
<span id="624">624</span>
<span id="625">625</span>
<span id="626">626</span>
<span id="627">627</span>
<span id="628">628</span>
<span id="629">629</span>
<span id="630">630</span>
<span id="631">631</span>
<span id="632">632</span>
<span id="633">633</span>
<span id="634">634</span>
<span id="635">635</span>
<span id="636">636</span>
<span id="637">637</span>
<span id="638">638</span>
<span id="639">639</span>
<span id="640">640</span>
<span id="641">641</span>
<span id="642">642</span>
<span id="643">643</span>
<span id="644">644</span>
<span id="645">645</span>
<span id="646">646</span>
<span id="647">647</span>
<span id="648">648</span>
<span id="649">649</span>
<span id="650">650</span>
<span id="651">651</span>
<span id="652">652</span>
<span id="653">653</span>
<span id="654">654</span>
<span id="655">655</span>
<span id="656">656</span>
<span id="657">657</span>
<span id="658">658</span>
<span id="659">659</span>
<span id="660">660</span>
<span id="661">661</span>
<span id="662">662</span>
<span id="663">663</span>
<span id="664">664</span>
<span id="665">665</span>
<span id="666">666</span>
<span id="667">667</span>
<span id="668">668</span>
<span id="669">669</span>
<span id="670">670</span>
<span id="671">671</span>
<span id="672">672</span>
<span id="673">673</span>
<span id="674">674</span>
<span id="675">675</span>
<span id="676">676</span>
<span id="677">677</span>
<span id="678">678</span>
<span id="679">679</span>
<span id="680">680</span>
<span id="681">681</span>
<span id="682">682</span>
<span id="683">683</span>
<span id="684">684</span>
<span id="685">685</span>
<span id="686">686</span>
<span id="687">687</span>
<span id="688">688</span>
<span id="689">689</span>
<span id="690">690</span>
<span id="691">691</span>
<span id="692">692</span>
<span id="693">693</span>
<span id="694">694</span>
<span id="695">695</span>
<span id="696">696</span>
<span id="697">697</span>
<span id="698">698</span>
<span id="699">699</span>
<span id="700">700</span>
<span id="701">701</span>
<span id="702">702</span>
<span id="703">703</span>
<span id="704">704</span>
<span id="705">705</span>
<span id="706">706</span>
<span id="707">707</span>
<span id="708">708</span>
<span id="709">709</span>
<span id="710">710</span>
<span id="711">711</span>
<span id="712">712</span>
<span id="713">713</span>
<span id="714">714</span>
<span id="715">715</span>
<span id="716">716</span>
<span id="717">717</span>
<span id="718">718</span>
<span id="719">719</span>
<span id="720">720</span>
<span id="721">721</span>
<span id="722">722</span>
<span id="723">723</span>
<span id="724">724</span>
<span id="725">725</span>
<span id="726">726</span>
<span id="727">727</span>
<span id="728">728</span>
<span id="729">729</span>
<span id="730">730</span>
<span id="731">731</span>
<span id="732">732</span>
<span id="733">733</span>
<span id="734">734</span>
<span id="735">735</span>
<span id="736">736</span>
<span id="737">737</span>
<span id="738">738</span>
<span id="739">739</span>
<span id="740">740</span>
<span id="741">741</span>
<span id="742">742</span>
<span id="743">743</span>
<span id="744">744</span>
<span id="745">745</span>
<span id="746">746</span>
<span id="747">747</span>
<span id="748">748</span>
<span id="749">749</span>
<span id="750">750</span>
<span id="751">751</span>
<span id="752">752</span>
<span id="753">753</span>
<span id="754">754</span>
<span id="755">755</span>
<span id="756">756</span>
<span id="757">757</span>
<span id="758">758</span>
<span id="759">759</span>
<span id="760">760</span>
<span id="761">761</span>
<span id="762">762</span>
<span id="763">763</span>
<span id="764">764</span>
<span id="765">765</span>
<span id="766">766</span>
<span id="767">767</span>
<span id="768">768</span>
<span id="769">769</span>
<span id="770">770</span>
<span id="771">771</span>
<span id="772">772</span>
<span id="773">773</span>
<span id="774">774</span>
<span id="775">775</span>
<span id="776">776</span>
<span id="777">777</span>
<span id="778">778</span>
<span id="779">779</span>
<span id="780">780</span>
<span id="781">781</span>
<span id="782">782</span>
<span id="783">783</span>
<span id="784">784</span>
<span id="785">785</span>
<span id="786">786</span>
<span id="787">787</span>
<span id="788">788</span>
<span id="789">789</span>
<span id="790">790</span>
<span id="791">791</span>
<span id="792">792</span>
<span id="793">793</span>
<span id="794">794</span>
<span id="795">795</span>
<span id="796">796</span>
<span id="797">797</span>
<span id="798">798</span>
<span id="799">799</span>
<span id="800">800</span>
<span id="801">801</span>
<span id="802">802</span>
<span id="803">803</span>
<span id="804">804</span>
<span id="805">805</span>
<span id="806">806</span>
<span id="807">807</span>
<span id="808">808</span>
<span id="809">809</span>
<span id="810">810</span>
<span id="811">811</span>
<span id="812">812</span>
<span id="813">813</span>
<span id="814">814</span>
<span id="815">815</span>
<span id="816">816</span>
<span id="817">817</span>
<span id="818">818</span>
<span id="819">819</span>
<span id="820">820</span>
<span id="821">821</span>
<span id="822">822</span>
<span id="823">823</span>
<span id="824">824</span>
<span id="825">825</span>
<span id="826">826</span>
<span id="827">827</span>
<span id="828">828</span>
<span id="829">829</span>
<span id="830">830</span>
<span id="831">831</span>
<span id="832">832</span>
<span id="833">833</span>
<span id="834">834</span>
<span id="835">835</span>
<span id="836">836</span>
<span id="837">837</span>
<span id="838">838</span>
<span id="839">839</span>
<span id="840">840</span>
<span id="841">841</span>
<span id="842">842</span>
<span id="843">843</span>
<span id="844">844</span>
<span id="845">845</span>
<span id="846">846</span>
<span id="847">847</span>
<span id="848">848</span>
<span id="849">849</span>
<span id="850">850</span>
<span id="851">851</span>
<span id="852">852</span>
<span id="853">853</span>
<span id="854">854</span>
<span id="855">855</span>
<span id="856">856</span>
<span id="857">857</span>
<span id="858">858</span>
<span id="859">859</span>
<span id="860">860</span>
<span id="861">861</span>
<span id="862">862</span>
<span id="863">863</span>
<span id="864">864</span>
<span id="865">865</span>
<span id="866">866</span>
<span id="867">867</span>
<span id="868">868</span>
<span id="869">869</span>
<span id="870">870</span>
<span id="871">871</span>
<span id="872">872</span>
<span id="873">873</span>
<span id="874">874</span>
<span id="875">875</span>
<span id="876">876</span>
<span id="877">877</span>
<span id="878">878</span>
<span id="879">879</span>
<span id="880">880</span>
<span id="881">881</span>
<span id="882">882</span>
<span id="883">883</span>
<span id="884">884</span>
<span id="885">885</span>
<span id="886">886</span>
<span id="887">887</span>
<span id="888">888</span>
<span id="889">889</span>
<span id="890">890</span>
<span id="891">891</span>
<span id="892">892</span>
<span id="893">893</span>
<span id="894">894</span>
<span id="895">895</span>
<span id="896">896</span>
<span id="897">897</span>
<span id="898">898</span>
<span id="899">899</span>
<span id="900">900</span>
<span id="901">901</span>
<span id="902">902</span>
<span id="903">903</span>
<span id="904">904</span>
<span id="905">905</span>
<span id="906">906</span>
<span id="907">907</span>
<span id="908">908</span>
<span id="909">909</span>
<span id="910">910</span>
<span id="911">911</span>
<span id="912">912</span>
<span id="913">913</span>
<span id="914">914</span>
<span id="915">915</span>
<span id="916">916</span>
<span id="917">917</span>
<span id="918">918</span>
<span id="919">919</span>
<span id="920">920</span>
<span id="921">921</span>
<span id="922">922</span>
<span id="923">923</span>
<span id="924">924</span>
<span id="925">925</span>
<span id="926">926</span>
<span id="927">927</span>
<span id="928">928</span>
<span id="929">929</span>
<span id="930">930</span>
<span id="931">931</span>
<span id="932">932</span>
<span id="933">933</span>
<span id="934">934</span>
<span id="935">935</span>
<span id="936">936</span>
<span id="937">937</span>
<span id="938">938</span>
<span id="939">939</span>
<span id="940">940</span>
<span id="941">941</span>
<span id="942">942</span>
<span id="943">943</span>
<span id="944">944</span>
<span id="945">945</span>
<span id="946">946</span>
<span id="947">947</span>
<span id="948">948</span>
<span id="949">949</span>
<span id="950">950</span>
<span id="951">951</span>
<span id="952">952</span>
<span id="953">953</span>
<span id="954">954</span>
<span id="955">955</span>
<span id="956">956</span>
<span id="957">957</span>
<span id="958">958</span>
<span id="959">959</span>
<span id="960">960</span>
<span id="961">961</span>
<span id="962">962</span>
<span id="963">963</span>
<span id="964">964</span>
<span id="965">965</span>
<span id="966">966</span>
<span id="967">967</span>
<span id="968">968</span>
<span id="969">969</span>
<span id="970">970</span>
<span id="971">971</span>
<span id="972">972</span>
<span id="973">973</span>
<span id="974">974</span>
<span id="975">975</span>
<span id="976">976</span>
<span id="977">977</span>
<span id="978">978</span>
<span id="979">979</span>
<span id="980">980</span>
<span id="981">981</span>
<span id="982">982</span>
<span id="983">983</span>
<span id="984">984</span>
<span id="985">985</span>
<span id="986">986</span>
<span id="987">987</span>
<span id="988">988</span>
<span id="989">989</span>
<span id="990">990</span>
<span id="991">991</span>
<span id="992">992</span>
<span id="993">993</span>
<span id="994">994</span>
<span id="995">995</span>
<span id="996">996</span>
<span id="997">997</span>
<span id="998">998</span>
<span id="999">999</span>
<span id="1000">1000</span>
<span id="1001">1001</span>
<span id="1002">1002</span>
<span id="1003">1003</span>
<span id="1004">1004</span>
<span id="1005">1005</span>
<span id="1006">1006</span>
<span id="1007">1007</span>
<span id="1008">1008</span>
<span id="1009">1009</span>
<span id="1010">1010</span>
<span id="1011">1011</span>
<span id="1012">1012</span>
<span id="1013">1013</span>
<span id="1014">1014</span>
<span id="1015">1015</span>
<span id="1016">1016</span>
<span id="1017">1017</span>
<span id="1018">1018</span>
<span id="1019">1019</span>
<span id="1020">1020</span>
<span id="1021">1021</span>
<span id="1022">1022</span>
<span id="1023">1023</span>
<span id="1024">1024</span>
<span id="1025">1025</span>
<span id="1026">1026</span>
<span id="1027">1027</span>
<span id="1028">1028</span>
<span id="1029">1029</span>
<span id="1030">1030</span>
<span id="1031">1031</span>
<span id="1032">1032</span>
<span id="1033">1033</span>
<span id="1034">1034</span>
<span id="1035">1035</span>
<span id="1036">1036</span>
<span id="1037">1037</span>
<span id="1038">1038</span>
<span id="1039">1039</span>
<span id="1040">1040</span>
<span id="1041">1041</span>
<span id="1042">1042</span>
<span id="1043">1043</span>
<span id="1044">1044</span>
<span id="1045">1045</span>
<span id="1046">1046</span>
<span id="1047">1047</span>
<span id="1048">1048</span>
<span id="1049">1049</span>
<span id="1050">1050</span>
<span id="1051">1051</span>
<span id="1052">1052</span>
<span id="1053">1053</span>
<span id="1054">1054</span>
<span id="1055">1055</span>
<span id="1056">1056</span>
<span id="1057">1057</span>
<span id="1058">1058</span>
<span id="1059">1059</span>
<span id="1060">1060</span>
<span id="1061">1061</span>
<span id="1062">1062</span>
<span id="1063">1063</span>
<span id="1064">1064</span>
<span id="1065">1065</span>
<span id="1066">1066</span>
<span id="1067">1067</span>
<span id="1068">1068</span>
<span id="1069">1069</span>
<span id="1070">1070</span>
<span id="1071">1071</span>
<span id="1072">1072</span>
<span id="1073">1073</span>
<span id="1074">1074</span>
<span id="1075">1075</span>
<span id="1076">1076</span>
<span id="1077">1077</span>
<span id="1078">1078</span>
<span id="1079">1079</span>
<span id="1080">1080</span>
<span id="1081">1081</span>
<span id="1082">1082</span>
<span id="1083">1083</span>
<span id="1084">1084</span>
<span id="1085">1085</span>
<span id="1086">1086</span>
<span id="1087">1087</span>
<span id="1088">1088</span>
<span id="1089">1089</span>
<span id="1090">1090</span>
<span id="1091">1091</span>
<span id="1092">1092</span>
<span id="1093">1093</span>
<span id="1094">1094</span>
<span id="1095">1095</span>
<span id="1096">1096</span>
<span id="1097">1097</span>
<span id="1098">1098</span>
<span id="1099">1099</span>
<span id="1100">1100</span>
<span id="1101">1101</span>
<span id="1102">1102</span>
<span id="1103">1103</span>
<span id="1104">1104</span>
<span id="1105">1105</span>
<span id="1106">1106</span>
<span id="1107">1107</span>
<span id="1108">1108</span>
<span id="1109">1109</span>
<span id="1110">1110</span>
<span id="1111">1111</span>
<span id="1112">1112</span>
<span id="1113">1113</span>
<span id="1114">1114</span>
<span id="1115">1115</span>
<span id="1116">1116</span>
<span id="1117">1117</span>
<span id="1118">1118</span>
<span id="1119">1119</span>
<span id="1120">1120</span>
<span id="1121">1121</span>
<span id="1122">1122</span>
<span id="1123">1123</span>
<span id="1124">1124</span>
<span id="1125">1125</span>
<span id="1126">1126</span>
<span id="1127">1127</span>
<span id="1128">1128</span>
<span id="1129">1129</span>
<span id="1130">1130</span>
<span id="1131">1131</span>
<span id="1132">1132</span>
<span id="1133">1133</span>
<span id="1134">1134</span>
<span id="1135">1135</span>
<span id="1136">1136</span>
<span id="1137">1137</span>
<span id="1138">1138</span>
<span id="1139">1139</span>
<span id="1140">1140</span>
<span id="1141">1141</span>
<span id="1142">1142</span>
<span id="1143">1143</span>
<span id="1144">1144</span>
<span id="1145">1145</span>
<span id="1146">1146</span>
<span id="1147">1147</span>
<span id="1148">1148</span>
<span id="1149">1149</span>
<span id="1150">1150</span>
<span id="1151">1151</span>
<span id="1152">1152</span>
<span id="1153">1153</span>
<span id="1154">1154</span>
<span id="1155">1155</span>
<span id="1156">1156</span>
<span id="1157">1157</span>
<span id="1158">1158</span>
<span id="1159">1159</span>
<span id="1160">1160</span>
<span id="1161">1161</span>
<span id="1162">1162</span>
<span id="1163">1163</span>
<span id="1164">1164</span>
<span id="1165">1165</span>
<span id="1166">1166</span>
<span id="1167">1167</span>
<span id="1168">1168</span>
<span id="1169">1169</span>
<span id="1170">1170</span>
<span id="1171">1171</span>
<span id="1172">1172</span>
<span id="1173">1173</span>
<span id="1174">1174</span>
<span id="1175">1175</span>
<span id="1176">1176</span>
<span id="1177">1177</span>
<span id="1178">1178</span>
<span id="1179">1179</span>
<span id="1180">1180</span>
<span id="1181">1181</span>
<span id="1182">1182</span>
<span id="1183">1183</span>
<span id="1184">1184</span>
<span id="1185">1185</span>
<span id="1186">1186</span>
<span id="1187">1187</span>
<span id="1188">1188</span>
<span id="1189">1189</span>
<span id="1190">1190</span>
<span id="1191">1191</span>
<span id="1192">1192</span>
<span id="1193">1193</span>
<span id="1194">1194</span>
<span id="1195">1195</span>
<span id="1196">1196</span>
<span id="1197">1197</span>
<span id="1198">1198</span>
<span id="1199">1199</span>
<span id="1200">1200</span>
<span id="1201">1201</span>
<span id="1202">1202</span>
<span id="1203">1203</span>
<span id="1204">1204</span>
<span id="1205">1205</span>
<span id="1206">1206</span>
<span id="1207">1207</span>
<span id="1208">1208</span>
<span id="1209">1209</span>
<span id="1210">1210</span>
<span id="1211">1211</span>
<span id="1212">1212</span>
<span id="1213">1213</span>
<span id="1214">1214</span>
<span id="1215">1215</span>
<span id="1216">1216</span>
<span id="1217">1217</span>
<span id="1218">1218</span>
<span id="1219">1219</span>
<span id="1220">1220</span>
<span id="1221">1221</span>
<span id="1222">1222</span>
<span id="1223">1223</span>
<span id="1224">1224</span>
<span id="1225">1225</span>
<span id="1226">1226</span>
<span id="1227">1227</span>
<span id="1228">1228</span>
<span id="1229">1229</span>
<span id="1230">1230</span>
<span id="1231">1231</span>
<span id="1232">1232</span>
<span id="1233">1233</span>
<span id="1234">1234</span>
<span id="1235">1235</span>
<span id="1236">1236</span>
<span id="1237">1237</span>
<span id="1238">1238</span>
<span id="1239">1239</span>
<span id="1240">1240</span>
<span id="1241">1241</span>
<span id="1242">1242</span>
<span id="1243">1243</span>
<span id="1244">1244</span>
<span id="1245">1245</span>
<span id="1246">1246</span>
<span id="1247">1247</span>
<span id="1248">1248</span>
<span id="1249">1249</span>
<span id="1250">1250</span>
<span id="1251">1251</span>
<span id="1252">1252</span>
<span id="1253">1253</span>
<span id="1254">1254</span>
<span id="1255">1255</span>
<span id="1256">1256</span>
<span id="1257">1257</span>
<span id="1258">1258</span>
<span id="1259">1259</span>
<span id="1260">1260</span>
<span id="1261">1261</span>
<span id="1262">1262</span>
<span id="1263">1263</span>
<span id="1264">1264</span>
<span id="1265">1265</span>
</pre><pre class="rust"><code><span class="comment">/*
MIT License
Copyright (c) 2021 Germán Molina
Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the &quot;Software&quot;), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:
The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.
THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
*/

</span><span class="kw">use </span><span class="kw">crate</span>::convection::ConvectionParams;
<span class="kw">use </span><span class="kw">crate</span>::discretization::Discretization;
<span class="kw">use </span><span class="kw">crate</span>::glazing::Glazing;
<span class="kw">use </span><span class="kw">crate</span>::surface_trait::SurfaceTrait;
<span class="kw">use </span><span class="kw">crate</span>::Float;
<span class="kw">use </span>geometry3d::Vector3D;
<span class="kw">use </span>matrix::Matrix;
<span class="kw">use </span>simple_model::{
    Boundary, Construction, Fenestration, SimpleModel, SimulationStateHeader, Substance, Surface,
    TerrainClass,
};
<span class="kw">use </span>simple_model::{SimulationState, SiteDetails};
<span class="kw">use </span>std::rc::Rc;

<span class="doccomment">/// Calculates whether a surface is facing the wind direction
/// **wind_direction in Radians**
</span><span class="kw">pub fn </span>is_windward(wind_direction: Float, cos_tilt: Float, normal: Vector3D) -&gt; bool {
    <span class="kw">if </span>cos_tilt.abs() &lt; <span class="number">0.98 </span>{
        <span class="comment">// tilted
        </span><span class="kw">let </span>wind_direction = Vector3D::new(wind_direction.sin(), wind_direction.cos(), <span class="number">0.0</span>);
        normal * wind_direction &gt; <span class="number">0.0
    </span>} <span class="kw">else </span>{
        <span class="comment">// if it is horizontal
        </span><span class="bool-val">true
    </span>}
}

<span class="doccomment">/// Calculates a surface&#39;s wind speed modifier; that is to say, the value by which
/// the weather file wind speed needs to be multiplied in order to estimate the wind
/// speed next to the window
///
/// This is a rip off from EnergyPlus&#39; Engineering Reference, where they explain that
/// the corrected wind speed ($`V_z`$ in $`m/s`$) at a certain altitude $`z`$ in $`m`$
/// (e.g., the height of the window&#39;s centroid) can be estimated through an equation that
/// relates the measurements at the meteorological station and those in the site.
///
/// Specifically, this equation depends on the altitude
/// at which the wind speed was measured at the meteorological station ($`z_{met}`$,
/// assumed to be $`10m`$), the so-called &quot;wind speed profile boundary layer&quot; at the
/// weather station ($`\delta_{met}`$, assumed to be $`240m`$) and the &quot;wind speed profile
/// exponent&quot; at the meteorological station $`\alpha_{met}`$. Also, it depends on the
/// &quot;wind speed profile boundary layer&quot; at the site ($`\delta`$) and the &quot;wind speed profile
/// exponent&quot; $`\alpha`$.
///
/// ```math
/// V_z = \left(\frac{\delta_{met}}{z_{met}}\right)^{\alpha_{met}}\left(\frac{z}{\delta} \right)^{\alpha}
/// ```
/// The values for $`\alpha`$ and $`\delta`$ depend on the kind of terrain.
///
/// | Terrain Class | $`\alpha`$ | $`\delta`$ |
/// |---------------|------------|------------|
/// | Country       | 0.14       | 270        |
/// | Suburbs       | 0.22       | 370        |
/// | City          | 0.33       | 460        |
/// | Ocean         | 0.10       | 210        |
/// | Urban         | 0.22       | 370        |
///
/// &gt; Note: if height is Zero, then we assume the wind speed to be Zero
</span><span class="kw">pub fn </span>wind_speed_modifier(height: Float, site_details: <span class="kw-2">&amp;</span><span class="prelude-ty">Option</span>&lt;SiteDetails&gt;) -&gt; Float {
    <span class="comment">// Surface touching the ground... no wind
    </span><span class="kw">if </span>height &lt; <span class="number">1e-5 </span>{
        <span class="kw">return </span><span class="number">0.0</span>;
    }
    <span class="comment">// this bit does not change... it is assumed constant for all meterological stations

    </span><span class="kw">let </span><span class="kw-2">mut </span>alpha = <span class="number">0.0</span>;
    <span class="kw">let </span><span class="kw-2">mut </span>delta = <span class="number">0.0</span>;

    <span class="kw">if let </span><span class="prelude-val">Some</span>(details) = site_details {
        <span class="comment">// raise all surfaces, if needed
        // if let Ok(z_terrain) = details.altitude(){
        //     height += z_terrain;
        // }
        </span><span class="kw">if let </span><span class="prelude-val">Ok</span>(terrain) = details.terrain() {
            (alpha, delta) = <span class="kw">match </span>terrain {
                TerrainClass::Country =&gt; (<span class="number">0.14</span>, <span class="number">270.</span>),
                TerrainClass::Suburbs =&gt; (<span class="number">0.22</span>, <span class="number">370.</span>),
                TerrainClass::City =&gt; (<span class="number">0.33</span>, <span class="number">460.</span>),
                TerrainClass::Ocean =&gt; (<span class="number">0.10</span>, <span class="number">210.</span>),
                TerrainClass::Urban =&gt; (<span class="number">0.22</span>, <span class="number">370.</span>),
            }
        }
    } <span class="kw">else </span>{
        <span class="comment">// default to Urban
        </span>alpha = <span class="number">0.22</span>;
        delta = <span class="number">370.</span>;
    }

    (<span class="number">270. </span>/ <span class="number">10. </span><span class="kw">as </span>Float).powf(<span class="number">0.14</span>) * (height / delta).powf(alpha)
}

<span class="doccomment">/// Marches forward through time, solving the
/// Ordinary Differential Equation that governs the heat transfer in walls.
///
///
/// The equation to solve is the following:
///
/// ```math
/// \overline{C}  \dot{T} - \overline{K}  T = q
/// ```
///
/// Where $`\overline{C}`$ and $`\overline{K}`$ are matrices representing the
/// thermal mass of each node and the thermal network, respectively; and where $`T`$ and $`q`$ are
/// vectors representing the Temperature and the heat &quot;flow into&quot; each node, respectively.
/// $`\overline{C}`$ and $`\overline{K}`$ are build based on the finite difference method.
///
/// This model uses a 4th order [Runga-Kutte](https://en.wikipedia.org/wiki/Runge%E2%80%93Kutta_methods) (a.k.a., RK4)
/// to march through time. In order to do this, it is convenient to write the equation to solve
/// as follows:
///
/// ```math
/// \dot{T}  = f(t, T)
/// ```
///
/// Where
/// ```math
/// f(t,T) = \overline{C}^{-1} \overline{K}  T + \overline{C}^{-1} q
/// ```
///
/// Then, the 4th order Runge-Kutta method allows marching forward through time as follows:
/// ```math
///  T_{i+1} = T_i + \frac{k_1 + 2k_2 + 2k_3 + k_4}{6}
/// ```
/// Where $`k_1`$, $`k_2`$, $`k_3`$ and $`k_4`$ can be calculated based on the
/// timestep $`\Delta t`$ as follows:
///
/// * $`k_1 = \Delta t \times f(t,T)`$
/// * $`k_2 = \Delta t \times f(t+\frac{\Delta t}{2}, T+\frac{k_1}{2})`$
/// * $`k_3 = \Delta t \times f(t+\frac{\Delta t}{2}, T+\frac{k_2}{2})`$
/// * $`k_4 = \Delta t \times f(t+\delta t, T+k_3 )`$
</span><span class="kw">fn </span>rk4(dt: Float, c: <span class="kw-2">&amp;</span>Matrix, <span class="kw-2">mut </span>k: Matrix, <span class="kw-2">mut </span>q: Matrix, t: <span class="kw-2">&amp;mut </span>Matrix) {
    <span class="kw">let </span>(krows, kcols) = k.size();
    <span class="macro">assert_eq!</span>(
        krows, kcols,
        <span class="string">&quot;Expecting &#39;K&#39; to be a squared matrix... nrows={}, ncols={}&quot;</span>,
        krows, kcols
    );
    <span class="kw">let </span>(crows, ccols) = c.size();
    <span class="macro">assert_eq!</span>(
        crows, ccols,
        <span class="string">&quot;Expecting &#39;C&#39; to be a squared matrix... nrows={}, ncols={}&quot;</span>,
        crows, ccols
    );
    <span class="kw">let </span>(qrows, qcols) = q.size();
    <span class="macro">assert_eq!</span>(
        qrows, krows,
        <span class="string">&quot;Expecting &#39;q&#39; to be to have {} rows because K has {} rows... found {}&quot;</span>,
        krows, krows, qrows
    );
    <span class="macro">assert_eq!</span>(
        qcols, <span class="number">1</span>,
        <span class="string">&quot;expecting &#39;q&#39; to have 1 column... found {}&quot;</span>,
        qcols
    );

    <span class="comment">// Rearrenge into dT = (dt/C) * K + (dt/C)*q
    </span><span class="kw">for </span>nrow <span class="kw">in </span><span class="number">0</span>..krows {
        <span class="kw">let </span>v = dt / c.get(nrow, nrow).unwrap();
        <span class="comment">// transform k into k_prime (i.e., k * dt/C)
        </span><span class="kw">let </span>ini = <span class="kw">if </span>nrow == <span class="number">0 </span>{ <span class="number">0 </span>} <span class="kw">else </span>{ nrow - <span class="number">1 </span>};
        <span class="kw">let </span>fin = <span class="kw">if </span>nrow == krows - <span class="number">1 </span>{
            krows - <span class="number">1
        </span>} <span class="kw">else </span>{
            nrow + <span class="number">1
        </span>};
        <span class="comment">// for ncol in 0..kcols{
        </span><span class="kw">for </span>ncol <span class="kw">in </span>ini..=fin {
            k.scale_element(nrow, ncol, v).unwrap();
        }
        <span class="comment">// transfrom q into q_prime (i.e., q * dt/C)
        </span>q.scale_element(nrow, <span class="number">0</span>, v).unwrap();
    }

    <span class="comment">// get k1
    </span><span class="kw">let </span><span class="kw-2">mut </span>k1 = k.from_prod_n_diag(t, <span class="number">3</span>).unwrap(); <span class="comment">//&amp;k * &amp;*t;
    </span>k1 += <span class="kw-2">&amp;</span>q;

    <span class="comment">// returning &quot;temperatures + k1&quot; is Euler... continuing is
    // Runge–Kutta 4th order
    // *t += &amp;k1;
    // return;

    </span><span class="kw">let </span><span class="kw-2">mut </span>aux = <span class="kw-2">&amp;</span>k1 * <span class="number">0.5</span>;
    aux += t;

    <span class="comment">// k2
    </span><span class="kw">let </span><span class="kw-2">mut </span>k2 = k.from_prod_n_diag(<span class="kw-2">&amp;</span>aux, <span class="number">3</span>).unwrap(); <span class="comment">//&amp;k * &amp;aux;
    </span>k2 += <span class="kw-2">&amp;</span>q;

    <span class="comment">// k3
    </span>k2.scale_into(<span class="number">0.5</span>, <span class="kw-2">&amp;mut </span>aux).unwrap();
    aux += t;
    <span class="kw">let </span><span class="kw-2">mut </span>k3 = k.from_prod_n_diag(<span class="kw-2">&amp;</span>aux, <span class="number">3</span>).unwrap(); <span class="comment">//&amp;k * &amp;aux;
    </span>k3 += <span class="kw-2">&amp;</span>q;

    <span class="comment">// k4
    </span>aux.copy_from(<span class="kw-2">&amp;</span>k3);
    aux += t;
    <span class="kw">let </span><span class="kw-2">mut </span>k4 = k.from_prod_n_diag(<span class="kw-2">&amp;</span>aux, <span class="number">3</span>).unwrap(); <span class="comment">//&amp;k * &amp;aux;
    </span>k4 += <span class="kw-2">&amp;</span>q;

    <span class="comment">// Scale them and add them all up
    </span>k1 /= <span class="number">6.</span>;
    k2 /= <span class="number">3.</span>;
    k3 /= <span class="number">3.</span>;
    k4 /= <span class="number">6.</span>;

    <span class="comment">// Let&#39;s add it all and return
    </span><span class="kw-2">*</span>t += <span class="kw-2">&amp;</span>k1;
    <span class="kw-2">*</span>t += <span class="kw-2">&amp;</span>k2;
    <span class="kw-2">*</span>t += <span class="kw-2">&amp;</span>k3;
    <span class="kw-2">*</span>t += <span class="kw-2">&amp;</span>k4;
}

<span class="doccomment">/// This is a Surface from the point of view of our thermal solver.
/// Since this module only calculate heat transfer (and not short-wave solar
/// radiation, e.g., light), both simple_model::Fenestration and simple_model::Surface
/// are treated in the same way.
</span><span class="kw">pub struct </span>ThermalSurfaceData&lt;T: SurfaceTrait&gt; {
    <span class="doccomment">/// A reference to the element in the [`SimpleModel`] which this struct represents
    </span><span class="kw">pub </span>parent: Rc&lt;T&gt;,

    <span class="doccomment">/// The [`Discretization`] that represents this `ThermalSurfaceData`
    </span><span class="kw">pub </span>discretization: Discretization,

    <span class="doccomment">/// The back boundary
    </span><span class="kw">pub </span>front_boundary: <span class="prelude-ty">Option</span>&lt;Boundary&gt;,

    <span class="doccomment">/// The index of the space in front of this, if any
    </span><span class="kw">pub </span>front_space_index: <span class="prelude-ty">Option</span>&lt;usize&gt;,

    <span class="doccomment">/// The front boundary
    </span><span class="kw">pub </span>back_boundary: <span class="prelude-ty">Option</span>&lt;Boundary&gt;,

    <span class="doccomment">/// The index of the space at the back of this, if any
    </span><span class="kw">pub </span>back_space_index: <span class="prelude-ty">Option</span>&lt;usize&gt;,

    <span class="doccomment">/// The thermal absorbtance on the front side (from 0 to 1)
    </span><span class="kw">pub </span>front_emissivity: Float,

    <span class="doccomment">/// The thermal absorbtance on the back side (from 0 to 1)
    </span><span class="kw">pub </span>back_emissivity: Float,

    <span class="doccomment">/// The area of the Surface
    </span><span class="kw">pub </span>area: Float,

    <span class="doccomment">/// The perimeter of the surface
    </span><span class="kw">pub </span>perimeter: Float,

    <span class="doccomment">/// The normal of the surface
    </span><span class="kw">pub </span>normal: Vector3D,

    <span class="doccomment">/// The wind velocity changes with altitude. This field
    /// stores the factor with which the wind velocity of the weather
    /// file needs to be multiplied in order to estimate the wind speed
    /// at the exterior of the surface.
    </span><span class="kw">pub </span>wind_speed_modifier: Float,

    <span class="doccomment">/// The cosine of the tilt angle (normal * Vector3D(0., 0., 1.))
    </span><span class="kw">pub </span>cos_tilt: Float,

    <span class="doccomment">/// The chunks of nodes that have mass
    </span><span class="kw">pub </span>massive_chunks: Vec&lt;(usize, usize)&gt;,

    <span class="doccomment">/// The chunks of nodes that have nomass
    </span><span class="kw">pub </span>nomass_chunks: Vec&lt;(usize, usize)&gt;,

    <span class="doccomment">/// The absorbtances of each node in the system, proportional
    /// to the front incident radiation (i.e., they do not add up to 1.0)
    </span><span class="kw">pub </span>front_alphas: Matrix,

    <span class="doccomment">/// The absorbtances of each node in the system, proportional
    /// to the back incident radiation (i.e., they do not add up to 1.0)
    </span><span class="kw">pub </span>back_alphas: Matrix,

    <span class="doccomment">/// [**Only available during testing**] this allows setting a fixed convection
    /// coefficient
    </span><span class="attribute">#[cfg(debug_assertions)]
    </span><span class="kw">pub </span>front_hs: <span class="prelude-ty">Option</span>&lt;Float&gt;,

    <span class="doccomment">/// [**Only available during testing**] this allows setting a fixed convection
    /// coefficient
    </span><span class="attribute">#[cfg(debug_assertions)]
    </span><span class="kw">pub </span>back_hs: <span class="prelude-ty">Option</span>&lt;Float&gt;,
}

<span class="kw">impl</span>&lt;T: SurfaceTrait&gt; ThermalSurfaceData&lt;T&gt; {
    <span class="doccomment">/// Creates a new [`ThermalSurfaceData`]
    </span><span class="attribute">#[allow(clippy::too_many_arguments)]
    </span><span class="kw">pub fn </span>new(
        state: <span class="kw-2">&amp;mut </span>SimulationStateHeader,
        model: <span class="kw-2">&amp;</span>SimpleModel,
        site_details: <span class="kw-2">&amp;</span><span class="prelude-ty">Option</span>&lt;SiteDetails&gt;,
        ref_surface_index: usize,
        parent: <span class="kw-2">&amp;</span>Rc&lt;T&gt;,
        area: Float,
        perimeter: Float,
        height: Float,
        normal: Vector3D,
        construction: <span class="kw-2">&amp;</span>Rc&lt;Construction&gt;,
        discretization: Discretization,
    ) -&gt; <span class="prelude-ty">Result</span>&lt;ThermalSurfaceData&lt;T&gt;, String&gt; {
        <span class="comment">// Set Front and Back state
        </span>parent.add_front_convection_state(state, ref_surface_index);
        parent.add_back_convection_state(state, ref_surface_index);

        parent.add_front_convective_heatflow_state(state, ref_surface_index);
        parent.add_back_convective_heatflow_state(state, ref_surface_index);

        parent.add_front_solar_irradiance_state(state, ref_surface_index);
        parent.add_back_solar_irradiance_state(state, ref_surface_index);

        parent.add_front_ir_irradiance_state(state, ref_surface_index);
        parent.add_back_ir_irradiance_state(state, ref_surface_index);

        <span class="comment">// Add node data.
        </span><span class="kw">let </span>n_nodes = discretization.segments.len();
        parent.add_node_temperature_states(state, ref_surface_index, n_nodes);

        <span class="kw">let </span>front_substance = model.get_material_substance(<span class="kw-2">&amp;</span>construction.materials[<span class="number">0</span>])<span class="question-mark">?</span>;

        <span class="kw">let </span>back_substance =
            model.get_material_substance(construction.materials.last().unwrap())<span class="question-mark">?</span>;

        <span class="kw">const </span>DEFAULT_EM: Float = <span class="number">0.84</span>;
        <span class="kw">let </span>front_emissivity = <span class="kw">match </span><span class="kw-2">&amp;</span>front_substance {
            Substance::Normal(s) =&gt; {
                s.front_thermal_absorbtance_or(<span class="kw">crate</span>::model::MODULE_NAME, DEFAULT_EM)
            }
            <span class="kw">_ </span>=&gt; <span class="macro">panic!</span>(<span class="string">&quot;Front Emissivity not available for this particular kind of Substance&quot;</span>),
        };
        <span class="kw">let </span>back_emissivity = <span class="kw">match </span>&amp;&amp;back_substance {
            Substance::Normal(s) =&gt; {
                s.back_thermal_absorbtance_or(<span class="kw">crate</span>::model::MODULE_NAME, DEFAULT_EM)
            }
            <span class="kw">_ </span>=&gt; <span class="macro">panic!</span>(<span class="string">&quot;Front Emissivity not available for this particular kind of Substance&quot;</span>),
        };

        <span class="kw">let </span>(massive_chunks, nomass_chunks) = discretization.get_chunks();

        <span class="comment">// Calculate solar absoption
        </span><span class="kw">let </span>front_glazing = Glazing::get_front_glazing_system(construction, model)<span class="question-mark">?</span>;
        <span class="kw">let </span>back_glazing = Glazing::get_back_glazing_system(construction, model)<span class="question-mark">?</span>;
        <span class="comment">// These two are the absorbtion of each glazing layer. We need the absorption of each node
        </span><span class="kw">let </span>front_alphas_prev = Glazing::alphas(<span class="kw-2">&amp;</span>front_glazing);
        <span class="kw">if </span>front_alphas_prev.len() != <span class="number">1 </span>&amp;&amp; front_alphas_prev.len() != construction.materials.len() {
            <span class="macro">panic!</span>(<span class="string">&quot;Construction &#39;{}&#39; seems to have a mixture of transparent and opaque layers. This is not currently supported.&quot;</span>, construction.name());
        }
        <span class="kw">let </span>n_nodes = discretization.segments.len();
        <span class="kw">let </span>n_layers = construction.materials.len();

        <span class="kw">let </span><span class="kw-2">mut </span>front_alphas = Matrix::new(<span class="number">0.0</span>, n_nodes, <span class="number">1</span>);
        <span class="kw">let </span><span class="kw-2">mut </span>global_i = <span class="number">0</span>;
        <span class="kw">for </span>(alpha_i, alpha) <span class="kw">in </span>front_alphas_prev.iter().enumerate() {
            <span class="kw">let </span>layer_index = <span class="number">2 </span>* alpha_i; <span class="comment">// We need to skip cavities
            </span><span class="kw">let </span>n = <span class="kw">if </span>discretization.n_elements[layer_index] == <span class="number">0 </span>{
                <span class="number">1
            </span>} <span class="kw">else </span>{
                discretization.n_elements[layer_index]
            };
            <span class="kw">let </span>substance = model.get_material_substance(<span class="kw-2">&amp;</span>construction.materials[layer_index])<span class="question-mark">?</span>;
            <span class="kw">if let </span>Substance::Normal(sub) = <span class="kw-2">&amp;</span>substance {
                <span class="kw">let </span>tau = <span class="kw-2">*</span>sub.solar_transmittance().unwrap_or(<span class="kw-2">&amp;</span><span class="number">0.0</span>);
                <span class="kw">if </span>tau &gt; <span class="number">0.0 </span>{
                    <span class="comment">// Distribute across all the nodes
                    </span><span class="kw">for </span>local_i <span class="kw">in </span><span class="number">0</span>..=n {
                        front_alphas
                            .add_to_element(global_i + local_i, <span class="number">0</span>, <span class="kw-2">*</span>alpha / (n + <span class="number">1</span>) <span class="kw">as </span>Float)
                            .unwrap();
                    }
                } <span class="kw">else </span>{
                    <span class="comment">// Add only to the first node
                    </span>front_alphas.add_to_element(global_i, <span class="number">0</span>, <span class="kw-2">*</span>alpha).unwrap();
                }
            } <span class="kw">else </span>{
                <span class="macro">unreachable!</span>()
            }
            global_i += n + <span class="number">1</span>;
        }

        <span class="kw">let </span>back_alphas_prev = Glazing::alphas(<span class="kw-2">&amp;</span>back_glazing);
        <span class="kw">if </span>back_alphas_prev.len() != <span class="number">1 </span>&amp;&amp; back_alphas_prev.len() != construction.materials.len() {
            <span class="macro">panic!</span>(<span class="string">&quot;Construction &#39;{}&#39; seems to have a mixture of transparent and opaque layers. This is not currently supported.&quot;</span>, construction.name());
        }
        <span class="kw">let </span><span class="kw-2">mut </span>back_alphas = Matrix::new(<span class="number">0.0</span>, n_nodes, <span class="number">1</span>);
        <span class="kw">let </span><span class="kw-2">mut </span>global_i = n_nodes;
        <span class="kw">for </span>(alpha_i, alpha) <span class="kw">in </span>back_alphas_prev.iter().enumerate() {
            <span class="kw">let </span>layer_index = n_layers - <span class="number">2 </span>* alpha_i - <span class="number">1</span>; <span class="comment">// We need to skip cavities
            </span><span class="kw">let </span>n = <span class="kw">if </span>discretization.n_elements[layer_index] == <span class="number">0 </span>{
                <span class="number">1
            </span>} <span class="kw">else </span>{
                discretization.n_elements[layer_index]
            };
            <span class="kw">let </span>substance = model.get_material_substance(<span class="kw-2">&amp;</span>construction.materials[layer_index])<span class="question-mark">?</span>;
            <span class="kw">if let </span>Substance::Normal(sub) = substance {
                <span class="kw">let </span>tau = <span class="kw-2">*</span>sub.solar_transmittance().unwrap_or(<span class="kw-2">&amp;</span><span class="number">0.0</span>);
                <span class="kw">if </span>tau &gt; <span class="number">0.0 </span>{
                    <span class="comment">// Distribute across all the nodes
                    </span><span class="kw">for </span>local_i <span class="kw">in </span><span class="number">0</span>..=n {
                        <span class="kw">let </span>row = global_i - local_i - <span class="number">1</span>;
                        back_alphas
                            .add_to_element(row, <span class="number">0</span>, <span class="kw-2">*</span>alpha / (n + <span class="number">1</span>) <span class="kw">as </span>Float)
                            .unwrap();
                    }
                } <span class="kw">else </span>{
                    <span class="comment">// Add only to the last node
                    </span>back_alphas.add_to_element(global_i - <span class="number">1</span>, <span class="number">0</span>, <span class="kw-2">*</span>alpha).unwrap();
                }
            } <span class="kw">else </span>{
                <span class="macro">unreachable!</span>()
            }
            global_i -= n + <span class="number">1</span>;
        }

        <span class="kw">let </span>cos_tilt = normal * Vector3D::new(<span class="number">0.</span>, <span class="number">0.</span>, <span class="number">1.</span>);
        <span class="kw">let </span>wind_speed_modifier = wind_speed_modifier(height, site_details);

        <span class="comment">// Build resulting
        </span><span class="prelude-val">Ok</span>(ThermalSurfaceData {
            parent: parent.clone(),
            area,
            perimeter,
            normal,
            cos_tilt,
            discretization,
            front_boundary: <span class="prelude-val">None</span>,
            back_boundary: <span class="prelude-val">None</span>,
            front_space_index: <span class="prelude-val">None</span>,
            back_space_index: <span class="prelude-val">None</span>,
            front_emissivity,
            back_emissivity,
            wind_speed_modifier,
            front_alphas,
            back_alphas,
            massive_chunks,
            nomass_chunks,
            <span class="attribute">#[cfg(debug_assertions)]
            </span>front_hs: <span class="prelude-val">None</span>,
            <span class="attribute">#[cfg(debug_assertions)]
            </span>back_hs: <span class="prelude-val">None</span>,
        })
    }

    <span class="doccomment">/// Sets the front boundary
    </span><span class="kw">pub fn </span>set_front_boundary(<span class="kw-2">&amp;mut </span><span class="self">self</span>, b: <span class="kw-2">&amp;</span>Boundary, model: <span class="kw-2">&amp;</span>SimpleModel) {
        <span class="self">self</span>.front_boundary = <span class="prelude-val">Some</span>(b.clone());
        <span class="kw">if let </span>Boundary::Space { space } = b {
            <span class="kw">for </span>(i, s) <span class="kw">in </span>model.spaces.iter().enumerate() {
                <span class="kw">if </span>s.name() == space {
                    <span class="self">self</span>.front_space_index = <span class="prelude-val">Some</span>(i);
                    <span class="kw">break</span>;
                }
            }
        }
    }

    <span class="doccomment">/// Sets the back boundary
    </span><span class="kw">pub fn </span>set_back_boundary(<span class="kw-2">&amp;mut </span><span class="self">self</span>, b: <span class="kw-2">&amp;</span>Boundary, model: <span class="kw-2">&amp;</span>SimpleModel) {
        <span class="self">self</span>.back_boundary = <span class="prelude-val">Some</span>(b.clone());
        <span class="kw">if let </span>Boundary::Space { space } = b {
            <span class="kw">for </span>(i, s) <span class="kw">in </span>model.spaces.iter().enumerate() {
                <span class="kw">if </span>s.name() == space {
                    <span class="self">self</span>.back_space_index = <span class="prelude-val">Some</span>(i);
                    <span class="kw">break</span>;
                }
            }
        }
    }

    <span class="kw">fn </span>calc_border_conditions(
        <span class="kw-2">&amp;</span><span class="self">self</span>,
        state: <span class="kw-2">&amp;</span>SimulationState,
        t_front: Float,
        t_back: Float,
        wind_direction: Float,
        wind_speed: Float,
    ) -&gt; (ConvectionParams, ConvectionParams, Float, Float) {
        <span class="comment">// Calculate and set Front and Back IR Irradiance
        </span><span class="kw">let </span>ir_front = <span class="self">self</span>.parent.front_infrared_irradiance(state);
        <span class="kw">let </span>ir_back = <span class="self">self</span>.parent.back_infrared_irradiance(state);

        <span class="kw">let </span>windward = is_windward(wind_direction, <span class="self">self</span>.cos_tilt, <span class="self">self</span>.normal);

        <span class="comment">// TODO: There is something to do here if we are talking about windows
        </span><span class="kw">let </span>(front_env, front_hs) = <span class="kw">if let </span><span class="prelude-val">Some</span>(b) = <span class="kw-2">&amp;</span><span class="self">self</span>.front_boundary {
            <span class="kw">match </span><span class="kw-2">&amp;</span>b {
                Boundary::Space { .. } =&gt; {
                    <span class="kw">let </span>front_env = ConvectionParams {
                        air_temperature: t_front,
                        air_speed: <span class="number">0.0</span>,
                        rad_temperature: t_front,
                        surface_temperature: <span class="self">self</span>.parent.front_temperature(state),
                        roughness_index: <span class="number">1</span>,
                        cos_surface_tilt: <span class="self">self</span>.cos_tilt,
                    };

                    (
                        front_env,
                        front_env.get_tarp_natural_convection_coefficient(),
                    )
                }
                Boundary::AmbientTemperature { temperature } =&gt; {
                    <span class="kw">let </span>front_env = ConvectionParams {
                        air_temperature: <span class="kw-2">*</span>temperature,
                        air_speed: <span class="number">0.0</span>,
                        rad_temperature: t_front,
                        surface_temperature: <span class="self">self</span>.parent.front_temperature(state),
                        roughness_index: <span class="number">1</span>,
                        cos_surface_tilt: <span class="self">self</span>.cos_tilt,
                    };

                    (
                        front_env,
                        front_env.get_tarp_natural_convection_coefficient(),
                    )
                }
                Boundary::Ground =&gt; <span class="macro">unreachable!</span>(),
            }
        } <span class="kw">else </span>{
            <span class="kw">let </span><span class="kw-2">mut </span>front_env = ConvectionParams {
                air_temperature: t_front,
                air_speed: wind_speed * <span class="self">self</span>.wind_speed_modifier,
                rad_temperature: (ir_front / <span class="kw">crate</span>::SIGMA).powf(<span class="number">0.25</span>) - <span class="number">273.15</span>,
                surface_temperature: <span class="self">self</span>.parent.front_temperature(state),
                roughness_index: <span class="number">1</span>,
                cos_surface_tilt: <span class="self">self</span>.cos_tilt,
            };
            front_env.cos_surface_tilt = -<span class="self">self</span>.cos_tilt;
            (
                front_env,
                front_env.get_tarp_convection_coefficient(<span class="self">self</span>.area, <span class="self">self</span>.perimeter, windward),
            )
        };

        <span class="kw">let </span>(back_env, back_hs) = <span class="kw">if let </span><span class="prelude-val">Some</span>(b) = <span class="kw-2">&amp;</span><span class="self">self</span>.back_boundary {
            <span class="kw">match </span><span class="kw-2">&amp;</span>b {
                Boundary::Space { .. } =&gt; {
                    <span class="kw">let </span>back_env = ConvectionParams {
                        air_temperature: t_back,
                        air_speed: <span class="number">0.0</span>,
                        rad_temperature: t_back, <span class="comment">//self.parent.back_temperature(state),//(ir_back/crate::SIGMA).powf(0.25) - 273.15,
                        </span>surface_temperature: <span class="self">self</span>.parent.back_temperature(state),
                        roughness_index: <span class="number">1</span>,
                        cos_surface_tilt: <span class="self">self</span>.cos_tilt,
                    };
                    (back_env, back_env.get_tarp_natural_convection_coefficient())
                }
                Boundary::AmbientTemperature { temperature } =&gt; {
                    <span class="kw">let </span>front_env = ConvectionParams {
                        air_temperature: <span class="kw-2">*</span>temperature,
                        air_speed: <span class="number">0.0</span>,
                        rad_temperature: t_front,
                        surface_temperature: <span class="self">self</span>.parent.front_temperature(state),
                        roughness_index: <span class="number">1</span>,
                        cos_surface_tilt: <span class="self">self</span>.cos_tilt,
                    };

                    (
                        front_env,
                        front_env.get_tarp_natural_convection_coefficient(),
                    )
                }
                Boundary::Ground =&gt; <span class="macro">unreachable!</span>(),
            }
        } <span class="kw">else </span>{
            <span class="kw">let </span>back_env = ConvectionParams {
                air_temperature: t_back,
                air_speed: wind_speed * <span class="self">self</span>.wind_speed_modifier,
                rad_temperature: (ir_back / <span class="kw">crate</span>::SIGMA).powf(<span class="number">0.25</span>) - <span class="number">273.15</span>,
                surface_temperature: <span class="self">self</span>.parent.back_temperature(state),
                roughness_index: <span class="number">1</span>,
                cos_surface_tilt: <span class="self">self</span>.cos_tilt,
            };
            (
                back_env,
                back_env.get_tarp_convection_coefficient(<span class="self">self</span>.area, <span class="self">self</span>.perimeter, windward),
            )
        };

        <span class="macro">assert!</span>(
            !front_hs.is_nan() &amp;&amp; !back_hs.is_nan(),
            <span class="string">&quot;Found NaN convection coefficients: Front={front_hs} | back={back_hs}&quot;
        </span>);
        <span class="attribute">#[cfg(debug_assertions)]
        </span><span class="kw">return </span>(
            front_env,
            back_env,
            <span class="self">self</span>.front_hs.unwrap_or(front_hs),
            <span class="self">self</span>.back_hs.unwrap_or(back_hs),
        );
        <span class="attribute">#[cfg(not(debug_assertions))]
        </span>(front_env, back_env, front_hs, back_hs)
    }

    <span class="doccomment">/// Marches one timestep. Returns front and back heat flow    
    </span><span class="kw">pub fn </span>march(
        <span class="kw-2">&amp;</span><span class="self">self</span>,
        state: <span class="kw-2">&amp;mut </span>SimulationState,
        t_front: Float,
        t_back: Float,
        wind_direction: Float,
        wind_speed: Float,
        dt: Float,
    ) -&gt; (Float, Float) {
        <span class="kw">let </span><span class="kw-2">mut </span>temperatures = <span class="self">self</span>.parent.get_node_temperatures(state);

        <span class="kw">let </span>(rows, ..) = temperatures.size();

        <span class="comment">// Calculate and set Front and Back Solar Irradiance
        </span><span class="kw">let </span><span class="kw-2">mut </span>solar_front = <span class="self">self</span>.parent.front_solar_irradiance(state);
        <span class="kw">if </span>solar_front.is_nan() {
            solar_front = <span class="number">0.0</span>;
        }
        <span class="kw">let </span><span class="kw-2">mut </span>solar_back = <span class="self">self</span>.parent.back_solar_irradiance(state);
        <span class="kw">if </span>solar_back.is_nan() {
            solar_back = <span class="number">0.0</span>;
        }

        <span class="comment">/////////////////////
        // 1st: Calculate the solar absorption in each node
        /////////////////////
        </span><span class="kw">let </span><span class="kw-2">mut </span>q = <span class="kw-2">&amp;</span><span class="self">self</span>.front_alphas * solar_front;
        q += <span class="kw-2">&amp;</span>(<span class="kw-2">&amp;</span><span class="self">self</span>.back_alphas * solar_back);

        <span class="comment">/////////////////////
        // 2nd: Calculate the temperature in all no-mass nodes.
        // Also, the heat flow into
        /////////////////////

        </span><span class="kw">let </span>(front_env, back_env, _front_hs, _back_hs) =
            <span class="self">self</span>.calc_border_conditions(state, t_front, t_back, wind_direction, wind_speed);
        <span class="kw">let </span>front_rad_hs = <span class="number">4.
            </span>* <span class="self">self</span>.front_emissivity
            * <span class="kw">crate</span>::SIGMA
            * (<span class="number">273.15 </span>+ (front_env.rad_temperature + front_env.surface_temperature) / <span class="number">2.</span>).powi(<span class="number">3</span>);
        <span class="kw">let </span>back_rad_hs = <span class="number">4.
            </span>* <span class="self">self</span>.back_emissivity
            * <span class="kw">crate</span>::SIGMA
            * (<span class="number">273.15 </span>+ (back_env.rad_temperature + back_env.surface_temperature) / <span class="number">2.</span>).powi(<span class="number">3</span>);

        <span class="kw">for </span>(ini, fin) <span class="kw">in </span><span class="kw-2">&amp;</span><span class="self">self</span>.nomass_chunks {
            <span class="kw">let </span><span class="kw-2">mut </span>old_err = <span class="number">99999.</span>;
            <span class="kw">let </span><span class="kw-2">mut </span>count = <span class="number">0</span>;

            <span class="kw">loop </span>{
                <span class="comment">// Update convection coefficients
                </span><span class="kw">let </span>(front_env, back_env, front_hs, back_hs) =
                    <span class="self">self</span>.calc_border_conditions(state, t_front, t_back, wind_direction, wind_speed);

                <span class="kw">let </span>(k, <span class="kw-2">mut </span>local_q) = <span class="self">self</span>.discretization.get_k_q(
                    <span class="kw-2">*</span>ini,
                    <span class="kw-2">*</span>fin,
                    <span class="kw-2">&amp;</span>temperatures,
                    <span class="kw-2">&amp;</span>front_env,
                    front_hs,
                    front_rad_hs,
                    <span class="kw-2">&amp;</span>back_env,
                    back_hs,
                    back_rad_hs,
                );
                <span class="comment">// add solar gains
                </span><span class="kw">for </span>(local_i, i) <span class="kw">in </span>(<span class="kw-2">*</span>ini..<span class="kw-2">*</span>fin).into_iter().enumerate() {
                    <span class="kw">let </span>v = q.get(i, <span class="number">0</span>).unwrap();
                    local_q.add_to_element(local_i, <span class="number">0</span>, v).unwrap();
                }
                local_q <span class="kw-2">*</span>= -<span class="number">1.</span>;

                <span class="kw">let </span>temps = k.clone().mut_n_diag_gaussian(local_q.clone(), <span class="number">3</span>).unwrap(); <span class="comment">// and just like that, q is the new temperatures

                </span><span class="kw">let </span><span class="kw-2">mut </span>err = <span class="number">0.0</span>;
                <span class="kw">for </span>(local_i, i) <span class="kw">in </span>(<span class="kw-2">*</span>ini..<span class="kw-2">*</span>fin).into_iter().enumerate() {
                    <span class="kw">let </span>local_temp = temps.get(local_i, <span class="number">0</span>).unwrap();
                    <span class="kw">let </span>global_temp = temperatures.get(i, <span class="number">0</span>).unwrap();
                    err += (local_temp - global_temp).abs();
                }
                <span class="kw">if </span>err &gt; old_err {
                    <span class="attribute">#[cfg(debug_assertions)]
                    </span><span class="kw">if </span>count &gt; <span class="number">100 </span>{
                        <span class="macro">eprintln!</span>(<span class="string">&quot;Breaking after {} iterations... because BAD!&quot;</span>, count);
                    }
                    <span class="kw">break</span>;
                }

                <span class="macro">assert!</span>(
                    !err.is_nan(),
                    <span class="string">&quot;Error is NaN... \nfront_env = {:?}| back_env = {:?} \nfront_hc = {} | back_hs = {}. \nError = {}\ntemps={}\nk={}\nlocal_q={}\nq={}\nsolar_front={}, solar_back={}\nfront_alphas={}\nback_alphas={}\n&quot;</span>,
                    front_env,
                    back_env,
                    front_hs,
                    back_hs,
                    err / ((fin - ini) <span class="kw">as </span>Float),
                    temps,
                    k,
                    local_q,
                    q,
                    solar_front,
                    solar_back,
                    <span class="self">self</span>.front_alphas,
                    <span class="self">self</span>.back_alphas,
                );

                <span class="comment">// if count &gt; 10000 {
                //     eprintln!(&quot;Err is {}&quot;, err / ((fin - ini) as Float))
                // }
                </span><span class="macro">assert!</span>(
                    count &lt; <span class="number">99199000</span>,
                    <span class="string">&quot;Excessive number of iterations... \n====\t\tfront_env = {:?}\n\tback_env = {:?}\n\tfront_hc = {}\n\tback_hs = {}.\n\tError = {}\n====\n&quot;</span>,
                    front_env,
                    back_env,
                    front_hs,
                    back_hs,
                    err / ((fin - ini) <span class="kw">as </span>Float),
                );
                <span class="kw">for </span>(local_i, i) <span class="kw">in </span>(<span class="kw-2">*</span>ini..<span class="kw-2">*</span>fin).into_iter().enumerate() {
                    <span class="kw">let </span>local_temp = temps.get(local_i, <span class="number">0</span>).unwrap();
                    <span class="comment">// temperatures.set(i, 0, local_temp).unwrap();
                    </span>temperatures.add_to_element(i, <span class="number">0</span>, local_temp).unwrap();
                    temperatures.scale_element(i, <span class="number">0</span>, <span class="number">0.5</span>).unwrap();
                }

                <span class="kw">let </span>max_allowed_error = <span class="kw">if </span>count &lt; <span class="number">100 </span>{ <span class="number">0.01 </span>} <span class="kw">else </span><span class="comment">/*if count &lt; 1000*/ </span>{ <span class="number">0.5 </span>}; <span class="comment">// else { 1. };

                </span><span class="kw">if </span>err / ((fin - ini) <span class="kw">as </span>Float) &lt; max_allowed_error {
                    <span class="attribute">#[cfg(debug_assertions)]
                    </span><span class="kw">if </span>count &gt; <span class="number">100 </span>{
                        <span class="macro">dbg!</span>(<span class="string">&quot;Breaking after {} iterations... because GOOD!&quot;</span>, count);
                    }
                    <span class="kw">break</span>;
                }
                old_err = err;
                count += <span class="number">1</span>;
            }
        }

        <span class="kw">let </span>(front_env, back_env, _front_hs, _back_hs) =
            <span class="self">self</span>.calc_border_conditions(state, t_front, t_back, wind_direction, wind_speed);
        <span class="kw">let </span>front_rad_hs = <span class="number">4.
            </span>* <span class="self">self</span>.front_emissivity
            * <span class="kw">crate</span>::SIGMA
            * (<span class="number">273.15 </span>+ (front_env.rad_temperature + front_env.surface_temperature) / <span class="number">2.</span>).powi(<span class="number">3</span>);
        <span class="kw">let </span>back_rad_hs = <span class="number">4.
            </span>* <span class="self">self</span>.back_emissivity
            * <span class="kw">crate</span>::SIGMA
            * (<span class="number">273.15 </span>+ (back_env.rad_temperature + back_env.surface_temperature) / <span class="number">2.</span>).powi(<span class="number">3</span>);

        <span class="comment">/////////////////////
        // 3rd: Calculate K and C matrices for the massive walls
        /////////////////////
        </span><span class="kw">for </span>(ini, fin) <span class="kw">in </span><span class="kw-2">&amp;</span><span class="self">self</span>.massive_chunks {
            <span class="kw">let </span>c = <span class="self">self
                </span>.discretization
                .segments
                .iter()
                .skip(<span class="kw-2">*</span>ini)
                .take(fin - ini)
                .map(|(mass, <span class="kw">_</span>)| <span class="kw-2">*</span>mass)
                .collect();
            <span class="kw">let </span>c = Matrix::diag(c);
            <span class="kw">let </span>(front_env, back_env, front_hs, back_hs) =
                <span class="self">self</span>.calc_border_conditions(state, t_front, t_back, wind_direction, wind_speed);

            <span class="kw">let </span>(k, <span class="kw-2">mut </span>local_q) = <span class="self">self</span>.discretization.get_k_q(
                <span class="kw-2">*</span>ini,
                <span class="kw-2">*</span>fin,
                <span class="kw-2">&amp;</span>temperatures,
                <span class="kw-2">&amp;</span>front_env,
                front_hs,
                front_rad_hs,
                <span class="kw-2">&amp;</span>back_env,
                back_hs,
                back_rad_hs,
            );

            <span class="comment">// ... here we add solar gains
            </span><span class="kw">for </span>(local_i, global_i) <span class="kw">in </span>(<span class="kw-2">*</span>ini..<span class="kw-2">*</span>fin).into_iter().enumerate() {
                <span class="kw">let </span>v = q.get(global_i, <span class="number">0</span>).unwrap();
                local_q.add_to_element(local_i, <span class="number">0</span>, v).unwrap();
            }

            <span class="comment">/////////////////////
            // 4rd: March massive nodes
            /////////////////////
            // Use RT4 for updating temperatures of massive nodes.
            </span><span class="kw">let </span><span class="kw-2">mut </span>local_temps = Matrix::new(<span class="number">0.0</span>, fin - ini, <span class="number">1</span>);
            <span class="kw">for </span>(local_i, global_i) <span class="kw">in </span>(<span class="kw-2">*</span>ini..<span class="kw-2">*</span>fin).into_iter().enumerate() {
                <span class="kw">let </span>v = temperatures.get(global_i, <span class="number">0</span>).unwrap();
                local_temps.set(local_i, <span class="number">0</span>, v).unwrap();
            }

            rk4(dt, <span class="kw-2">&amp;</span>c, k, local_q, <span class="kw-2">&amp;mut </span>local_temps);

            <span class="kw">for </span>(local_i, global_i) <span class="kw">in </span>(<span class="kw-2">*</span>ini..<span class="kw-2">*</span>fin).into_iter().enumerate() {
                <span class="kw">let </span>v = local_temps.get(local_i, <span class="number">0</span>).unwrap();
                temperatures.set(global_i, <span class="number">0</span>, v).unwrap();
            }
        }

        <span class="comment">/////////////////////
        // 5th: Set temperatures, calc heat-flows and return
        /////////////////////
        </span><span class="self">self</span>.parent.set_node_temperatures(state, <span class="kw-2">&amp;</span>temperatures);

        <span class="comment">// Calc heat flow
        </span><span class="kw">let </span>ts_front = temperatures.get(<span class="number">0</span>, <span class="number">0</span>).unwrap();
        <span class="kw">let </span>ts_back = temperatures.get(rows - <span class="number">1</span>, <span class="number">0</span>).unwrap();
        <span class="kw">let </span>(_front_env, _back_env, front_hs, back_hs) =
            <span class="self">self</span>.calc_border_conditions(state, t_front, t_back, wind_direction, wind_speed);
        <span class="self">self</span>.parent
            .set_front_convection_coefficient(state, front_hs);
        <span class="self">self</span>.parent.set_back_convection_coefficient(state, back_hs);

        <span class="kw">let </span>flow_front = (ts_front - t_front) * front_hs;
        <span class="kw">let </span>flow_back = (ts_back - t_back) * back_hs;

        (flow_front, flow_back)
    }
}

<span class="doccomment">/// A [`ThermalSurfaceData`] whose parent is a [`Surface`]
</span><span class="kw">pub type </span>ThermalSurface = ThermalSurfaceData&lt;Surface&gt;;

<span class="doccomment">/// A [`ThermalSurfaceData`] whose parent is a [`Fenestration`]
</span><span class="kw">pub type </span>ThermalFenestration = ThermalSurfaceData&lt;Fenestration&gt;;

<span class="comment">/***********/
/* TESTING */
/***********/

</span><span class="attribute">#[cfg(test)]
</span><span class="kw">mod </span>testing {

    <span class="kw">use super</span>::<span class="kw-2">*</span>;
    <span class="kw">use </span>geometry3d::{Loop3D, Point3D, Polygon3D};

    <span class="kw">use </span>simple_model::{
        substance::Normal <span class="kw">as </span>NormalSubstance, Construction, Material, SimpleModel, Substance,
        Surface,
    };

    <span class="kw">fn </span>add_polyurethane(model: <span class="kw-2">&amp;mut </span>SimpleModel) -&gt; Substance {
        <span class="kw">let </span><span class="kw-2">mut </span>poly = NormalSubstance::new(<span class="string">&quot;polyurethane&quot;</span>.to_string());
        poly.set_density(<span class="number">17.5</span>) <span class="comment">// kg/m3... reverse engineered from paper
            </span>.set_specific_heat_capacity(<span class="number">2400.</span>) <span class="comment">// J/kg.K
            </span>.set_front_thermal_absorbtance(<span class="number">0.</span>)
            .set_back_thermal_absorbtance(<span class="number">0.</span>)
            .set_thermal_conductivity(<span class="number">0.0252</span>); <span class="comment">// W/m.K

        </span><span class="macro">assert_eq!</span>(poly.thermal_diffusivity().unwrap(), <span class="number">0.6E-6</span>);
        <span class="kw">let </span>ret = model.add_substance(poly.wrap());
        ret
    }

    <span class="kw">fn </span>add_brickwork(model: <span class="kw-2">&amp;mut </span>SimpleModel) -&gt; Substance {
        <span class="kw">let </span><span class="kw-2">mut </span>brickwork = NormalSubstance::new(<span class="string">&quot;brickwork&quot;</span>.to_string());

        brickwork
            .set_density(<span class="number">1700.</span>) <span class="comment">// kg/m3... reverse engineered from paper
            </span>.set_specific_heat_capacity(<span class="number">800.</span>) <span class="comment">// J/kg.K
            </span>.set_front_thermal_absorbtance(<span class="number">0.</span>)
            .set_back_thermal_absorbtance(<span class="number">0.</span>)
            .set_thermal_conductivity(<span class="number">0.816</span>); <span class="comment">// W/m.K

        </span><span class="macro">assert!</span>((brickwork.thermal_diffusivity().unwrap() - <span class="number">0.6E-6</span>).abs() &lt; <span class="number">0.00000001</span>);
        <span class="kw">let </span>ret = model.add_substance(brickwork.wrap());

        ret
    }

    <span class="kw">fn </span>add_material(
        model: <span class="kw-2">&amp;mut </span>SimpleModel,
        substance: Substance,
        thickness: Float,
    ) -&gt; Rc&lt;Material&gt; {
        <span class="kw">let </span>mat = Material::new(<span class="string">&quot;123123&quot;</span>.to_string(), substance.name().clone(), thickness);

        model.add_material(mat)
    }

    <span class="attribute">#[test]
    </span><span class="kw">fn </span>test_march_massive() {
        <span class="kw">let </span><span class="kw-2">mut </span>model = SimpleModel::default();

        <span class="comment">/* SUBSTANCES */
        </span><span class="kw">let </span>brickwork = add_brickwork(<span class="kw-2">&amp;mut </span>model);

        <span class="comment">/* MATERIALS */
        </span><span class="kw">let </span>m1 = add_material(<span class="kw-2">&amp;mut </span>model, brickwork, <span class="number">20. </span>/ <span class="number">1000.</span>);

        <span class="comment">/* CONSTRUCTION */
        </span><span class="kw">let </span><span class="kw-2">mut </span>c = Construction::new(<span class="string">&quot;construction&quot;</span>.to_string());
        c.materials.push(m1.name().clone());
        <span class="kw">let </span>c = model.add_construction(c);

        <span class="comment">/* GEOMETRY */
        </span><span class="kw">let </span><span class="kw-2">mut </span>the_loop = Loop3D::new();
        <span class="kw">let </span>l = <span class="number">1. </span><span class="kw">as </span>Float;
        the_loop.push(Point3D::new(-l, -l, <span class="number">0.</span>)).unwrap();
        the_loop.push(Point3D::new(l, -l, <span class="number">0.</span>)).unwrap();
        the_loop.push(Point3D::new(l, l, <span class="number">0.</span>)).unwrap();
        the_loop.push(Point3D::new(-l, l, <span class="number">0.</span>)).unwrap();
        the_loop.close().unwrap();
        <span class="kw">let </span>p = Polygon3D::new(the_loop).unwrap();

        <span class="comment">/* SURFACE */
        </span><span class="kw">let </span>s = Surface::new(<span class="string">&quot;Surface 1&quot;</span>.to_string(), p, c.name().clone());

        <span class="kw">let </span>surface = model.add_surface(s);

        <span class="comment">// FIRST TEST -- 10 degrees on each side
        </span><span class="kw">let </span>main_dt = <span class="number">300.0</span>;
        <span class="kw">let </span>max_dx = m1.thickness / <span class="number">2.0</span>;
        <span class="kw">let </span>min_dt = <span class="number">1.0</span>;
        <span class="kw">let </span>d = Discretization::new(<span class="kw-2">&amp;</span>c, <span class="kw-2">&amp;</span>model, main_dt, max_dx, min_dt, <span class="number">1.</span>, <span class="number">0.</span>).unwrap();
        <span class="kw">let </span>dt = main_dt / d.tstep_subdivision <span class="kw">as </span>Float;
        <span class="kw">let </span>normal = geometry3d::Vector3D::new(<span class="number">0.</span>, <span class="number">0.</span>, <span class="number">1.</span>);
        <span class="kw">let </span>perimeter = <span class="number">8. </span>* l;
        <span class="kw">let </span><span class="kw-2">mut </span>state_header = SimulationStateHeader::new();
        <span class="kw">let </span><span class="kw-2">mut </span>ts = ThermalSurface::new(
            <span class="kw-2">&amp;mut </span>state_header,
            <span class="kw-2">&amp;</span>model,
            <span class="kw-2">&amp;</span><span class="prelude-val">None</span>,
            <span class="number">0</span>,
            <span class="kw-2">&amp;</span>surface,
            surface.area(),
            perimeter,
            <span class="number">10.</span>,
            normal,
            <span class="kw-2">&amp;</span>c,
            d,
        )
        .unwrap();

        ts.front_hs = <span class="prelude-val">Some</span>(<span class="number">10.</span>);
        ts.back_hs = <span class="prelude-val">Some</span>(<span class="number">10.</span>);

        <span class="kw">let </span><span class="kw-2">mut </span>state = state_header.take_values().unwrap();

        <span class="comment">// TEST

        // Try marching until q_in and q_out are zero.
        </span><span class="kw">let </span><span class="kw-2">mut </span>q: Float = <span class="number">9999000009.0</span>;
        <span class="kw">let </span><span class="kw-2">mut </span>counter: usize = <span class="number">0</span>;
        <span class="kw">let </span>t_environment = <span class="number">10.</span>;
        <span class="kw">let </span>v = <span class="kw">crate</span>::SIGMA * (t_environment + <span class="number">273.15 </span><span class="kw">as </span>Float).powi(<span class="number">4</span>);
        <span class="kw">while </span>q.abs() &gt; <span class="number">0.00015 </span>{
            ts.parent.set_front_ir_irradiance(<span class="kw-2">&amp;mut </span>state, v);
            ts.parent.set_back_ir_irradiance(<span class="kw-2">&amp;mut </span>state, v);
            <span class="kw">let </span>(q_out, q_in) = ts.march(<span class="kw-2">&amp;mut </span>state, t_environment, t_environment, <span class="number">0.0</span>, <span class="number">0.0</span>, dt);

            <span class="comment">// the same amount of heat needs to leave in each direction
            // println!(&quot;q_in = {}, q_out = {} | diff = {}&quot;, q_in, q_out, (q_in - q_out).abs());
            </span><span class="macro">assert!</span>(
                (q_in - q_out).abs() &lt; <span class="number">0.5</span>, <span class="comment">//1E-5,
                </span><span class="string">&quot;diff is {} (count is {counter})&quot;</span>,
                (q_in - q_out).abs()
            );

            <span class="comment">// q_front is positive
            </span><span class="macro">assert!</span>(q_in &gt;= <span class="number">0.</span>, <span class="string">&quot;q_in = {} | c = {}&quot;</span>, q_in, counter);
            <span class="macro">assert!</span>(q_out &gt;= <span class="number">0.</span>, <span class="string">&quot;q_out = {} | c = {}&quot;</span>, q_out, counter);

            q = q_in;

            counter += <span class="number">1</span>;
            <span class="kw">if </span>counter &gt; <span class="number">9999999 </span>{
                <span class="macro">panic!</span>(<span class="string">&quot;Exceded number of iterations... q.abs() = {}&quot;</span>, q.abs())
            }
        }

        <span class="comment">// all nodes should be at 10.0 now.
        </span><span class="kw">let </span>temperatures = ts.parent.get_node_temperatures(<span class="kw-2">&amp;</span>state);
        <span class="kw">let </span>(n_nodes, ..) = temperatures.size();
        <span class="kw">for </span>i <span class="kw">in </span><span class="number">0</span>..n_nodes {
            <span class="kw">let </span>t = temperatures.get(i, <span class="number">0</span>).unwrap();
            <span class="macro">assert!</span>(
                (t - <span class="number">10.0</span>).abs() &lt; <span class="number">0.002</span>,
                <span class="string">&quot;Error found is {}&quot;</span>,
                (t - <span class="number">10.0</span>).abs()
            );
        }

        <span class="comment">// SECOND TEST -- 10 degrees in and 30 out.
        // We expect the final q to be (30-10)/R from
        // outside to inside. I.E. q_in = (30-10)/R,
        // q_out = -(30-10)/R

        // March until q converges
        </span><span class="kw">let </span><span class="kw-2">mut </span>change: Float = <span class="number">99.0</span>;
        <span class="kw">let </span><span class="kw-2">mut </span>counter: usize = <span class="number">0</span>;
        <span class="kw">let </span><span class="kw-2">mut </span>previous_q: Float = -<span class="number">125.0</span>;
        <span class="kw">let </span><span class="kw-2">mut </span>final_qfront: Float = -<span class="number">12312.</span>;
        <span class="kw">let </span><span class="kw-2">mut </span>final_qback: Float = <span class="number">123123123.</span>;
        <span class="kw">while </span>change.abs() &gt; <span class="number">1E-10 </span>{
            <span class="kw">let </span>(q_front, q_back) = ts.march(<span class="kw-2">&amp;mut </span>state, <span class="number">10.0</span>, <span class="number">30.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>, dt);

            ts.parent.set_front_ir_irradiance(
                <span class="kw-2">&amp;mut </span>state,
                <span class="kw">crate</span>::SIGMA * (<span class="number">10. </span>+ <span class="number">273.15 </span><span class="kw">as </span>Float).powi(<span class="number">4</span>),
            );
            ts.parent
                .set_back_ir_irradiance(<span class="kw-2">&amp;mut </span>state, <span class="kw">crate</span>::SIGMA * (<span class="number">30. </span>+ <span class="number">273.15 </span><span class="kw">as </span>Float).powi(<span class="number">4</span>));

            final_qfront = q_front;
            final_qback = q_back;

            change = (q_front - previous_q).abs();
            previous_q = q_front;

            counter += <span class="number">1</span>;
            <span class="kw">if </span>counter &gt; <span class="number">99999 </span>{
                <span class="macro">panic!</span>(<span class="string">&quot;Exceded number of iterations&quot;</span>)
            }
        }

        <span class="comment">// Expecting
        </span><span class="macro">assert!</span>(final_qfront &gt; <span class="number">0.0</span>);
        <span class="macro">assert!</span>(final_qback &lt; <span class="number">0.0</span>);
    }

    <span class="attribute">#[test]
    </span><span class="kw">fn </span>test_march_nomass() {
        <span class="kw">let </span><span class="kw-2">mut </span>model = SimpleModel::default();

        <span class="comment">/* SUBSTANCE */
        </span><span class="kw">let </span>polyurethane = add_polyurethane(<span class="kw-2">&amp;mut </span>model);

        <span class="comment">/* MATERIAL */
        </span><span class="kw">let </span>m1 = add_material(<span class="kw-2">&amp;mut </span>model, polyurethane, <span class="number">3. </span>/ <span class="number">1000.</span>);

        <span class="comment">/* CONSTRUCTION */
        </span><span class="kw">let </span><span class="kw-2">mut </span>c = Construction::new(<span class="string">&quot;Construction&quot;</span>);
        c.materials.push(m1.name().clone());
        c.materials.push(m1.name().clone());
        <span class="kw">let </span>c = model.add_construction(c);

        <span class="comment">/* GEOMETRY */
        </span><span class="kw">let </span><span class="kw-2">mut </span>the_loop = Loop3D::new();
        <span class="kw">let </span>l = <span class="number">1. </span><span class="kw">as </span>Float;
        the_loop.push(Point3D::new(-l, -l, <span class="number">0.</span>)).unwrap();
        the_loop.push(Point3D::new(l, -l, <span class="number">0.</span>)).unwrap();
        the_loop.push(Point3D::new(l, l, <span class="number">0.</span>)).unwrap();
        the_loop.push(Point3D::new(-l, l, <span class="number">0.</span>)).unwrap();
        the_loop.close().unwrap();
        <span class="kw">let </span>p = Polygon3D::new(the_loop).unwrap();

        <span class="comment">/* SURFACE */
        </span><span class="kw">let </span>s = Surface::new(<span class="string">&quot;WALL&quot;</span>.to_string(), p, c.name().clone());
        <span class="kw">let </span>surface = model.add_surface(s);
        <span class="kw">let </span><span class="kw-2">mut </span>state_header = SimulationStateHeader::new();

        <span class="comment">/* TEST */

        </span><span class="kw">let </span>main_dt = <span class="number">3.0</span>;
        <span class="kw">let </span>max_dx = m1.thickness / <span class="number">7.0</span>;
        <span class="kw">let </span>min_dt = <span class="number">10.0</span>;
        <span class="kw">let </span>d = Discretization::new(<span class="kw-2">&amp;</span>c, <span class="kw-2">&amp;</span>model, main_dt, max_dx, min_dt, <span class="number">1.</span>, <span class="number">0.</span>).unwrap();
        <span class="kw">let </span>dt = main_dt / d.tstep_subdivision <span class="kw">as </span>Float;

        <span class="kw">let </span>normal = geometry3d::Vector3D::new(<span class="number">0.</span>, <span class="number">0.</span>, <span class="number">1.</span>);
        <span class="kw">let </span>perimeter = <span class="number">8. </span>* l;
        <span class="kw">let </span><span class="kw-2">mut </span>ts = ThermalSurface::new(
            <span class="kw-2">&amp;mut </span>state_header,
            <span class="kw-2">&amp;</span>model,
            <span class="kw-2">&amp;</span><span class="prelude-val">None</span>,
            <span class="number">0</span>,
            <span class="kw-2">&amp;</span>surface,
            surface.area(),
            perimeter,
            <span class="number">10.</span>,
            normal,
            <span class="kw-2">&amp;</span>c,
            d,
        )
        .unwrap();
        ts.front_hs = <span class="prelude-val">Some</span>(<span class="number">10.</span>);
        ts.back_hs = <span class="prelude-val">Some</span>(<span class="number">10.</span>);
        <span class="comment">// assert!(!d.is_massive);

        </span><span class="kw">let </span><span class="kw-2">mut </span>state = state_header.take_values().unwrap();

        <span class="comment">// FIRST TEST -- 10 degrees on each side

        // Try marching until q_in and q_out are zero.

        </span><span class="kw">let </span>(q_in, q_out) = ts.march(<span class="kw-2">&amp;mut </span>state, <span class="number">10.0</span>, <span class="number">10.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>, dt);

        <span class="comment">// this should show instantaneous update. So,
        </span><span class="kw">let </span>temperatures = ts.parent.get_node_temperatures(<span class="kw-2">&amp;</span>state);
        <span class="kw">let </span>(nnodes, ..) = temperatures.size();
        <span class="macro">println!</span>(<span class="string">&quot; T == {}&quot;</span>, <span class="kw-2">&amp;</span>temperatures);
        <span class="macro">assert!</span>(
            (temperatures.get(<span class="number">0</span>, <span class="number">0</span>).unwrap() - <span class="number">10.0</span>).abs() &lt; <span class="number">0.2</span>,
            <span class="string">&quot;T = {}&quot;</span>,
            temperatures.get(<span class="number">0</span>, <span class="number">0</span>).unwrap()
        );
        <span class="macro">assert!</span>(
            (temperatures.get(nnodes - <span class="number">1</span>, <span class="number">0</span>).unwrap() - <span class="number">10.0</span>).abs() &lt; <span class="number">0.2</span>,
            <span class="string">&quot;T = {}&quot;</span>,
            temperatures.get(nnodes - <span class="number">1</span>, <span class="number">0</span>).unwrap()
        );
        <span class="macro">assert!</span>(q_in.abs() &lt; <span class="number">0.07</span>, <span class="string">&quot;q_in is {}&quot;</span>, q_in);
        <span class="macro">assert!</span>(q_out.abs() &lt; <span class="number">0.07</span>);
    }

    <span class="attribute">#[test]
    </span><span class="kw">fn </span>test_march_nomass_2() {
        <span class="kw">let </span><span class="kw-2">mut </span>model = SimpleModel::default();

        <span class="comment">/* SUBSTANCE */
        </span><span class="kw">let </span>polyurethane = add_polyurethane(<span class="kw-2">&amp;mut </span>model);

        <span class="comment">/* MATERIAL */
        </span><span class="kw">let </span>m1 = add_material(<span class="kw-2">&amp;mut </span>model, polyurethane, <span class="number">3. </span>/ <span class="number">1000.</span>);

        <span class="comment">/* CONSTRUCTION */
        </span><span class="kw">let </span><span class="kw-2">mut </span>c = Construction::new(<span class="string">&quot;Construction&quot;</span>.to_string());
        c.materials.push(m1.name().clone());
        c.materials.push(m1.name().clone());
        <span class="kw">let </span>c = model.add_construction(c);

        <span class="comment">/* GEOMETRY */
        </span><span class="kw">let </span><span class="kw-2">mut </span>the_loop = Loop3D::new();
        <span class="kw">let </span>l = <span class="number">1. </span><span class="kw">as </span>Float;
        the_loop.push(Point3D::new(-l, -l, <span class="number">0.</span>)).unwrap();
        the_loop.push(Point3D::new(l, -l, <span class="number">0.</span>)).unwrap();
        the_loop.push(Point3D::new(l, l, <span class="number">0.</span>)).unwrap();
        the_loop.push(Point3D::new(-l, l, <span class="number">0.</span>)).unwrap();
        the_loop.close().unwrap();
        <span class="kw">let </span>p = Polygon3D::new(the_loop).unwrap();

        <span class="comment">/* SURFACE */
        </span><span class="kw">let </span>s = Surface::new(<span class="string">&quot;WALL&quot;</span>.to_string(), p, c.name().clone());

        <span class="kw">let </span>surface = model.add_surface(s);
        <span class="kw">let </span><span class="kw-2">mut </span>state_header = SimulationStateHeader::new();

        <span class="comment">/* TEST */

        </span><span class="kw">let </span>main_dt = <span class="number">3.0</span>;
        <span class="kw">let </span>max_dx = m1.thickness / <span class="number">7.0</span>;
        <span class="kw">let </span>min_dt = <span class="number">10.0</span>;
        <span class="kw">let </span>d = Discretization::new(<span class="kw-2">&amp;</span>c, <span class="kw-2">&amp;</span>model, main_dt, max_dx, min_dt, <span class="number">1.</span>, <span class="number">0.</span>).unwrap();
        <span class="kw">let </span>dt = main_dt / d.tstep_subdivision <span class="kw">as </span>Float;

        <span class="kw">let </span>normal = geometry3d::Vector3D::new(<span class="number">0.</span>, <span class="number">0.</span>, <span class="number">1.</span>);
        <span class="kw">let </span>perimeter = <span class="number">8. </span>* l;
        <span class="kw">let </span><span class="kw-2">mut </span>ts = ThermalSurface::new(
            <span class="kw-2">&amp;mut </span>state_header,
            <span class="kw-2">&amp;</span>model,
            <span class="kw-2">&amp;</span><span class="prelude-val">None</span>,
            <span class="number">0</span>,
            <span class="kw-2">&amp;</span>surface,
            surface.area(),
            perimeter,
            <span class="number">10.</span>,
            normal,
            <span class="kw-2">&amp;</span>c,
            d,
        )
        .unwrap();
        ts.front_hs = <span class="prelude-val">Some</span>(<span class="number">10.</span>);
        ts.back_hs = <span class="prelude-val">Some</span>(<span class="number">10.</span>);
        <span class="comment">// assert!(!d.is_massive);

        </span><span class="kw">let </span><span class="kw-2">mut </span>state = state_header.take_values().unwrap();

        <span class="comment">// SECOND TEST -- 10 degrees in and 30 out.
        // We expect the final q to be (30-10)/R from
        // outside to inside. I.E. q_in = (30-10)/R,
        // q_out = -(30-10)/R

        </span><span class="kw">let </span>t_front = <span class="number">10.0</span>;
        <span class="kw">let </span>t_back = <span class="number">30.0</span>;
        <span class="kw">let </span>(q_front, q_back) = ts.march(<span class="kw-2">&amp;mut </span>state, t_front, t_back, <span class="number">0.0</span>, <span class="number">0.0</span>, dt);

        <span class="comment">// Expecting
        </span><span class="kw">let </span>temperatures = ts.parent.get_node_temperatures(<span class="kw-2">&amp;</span>state);

        <span class="macro">println!</span>(<span class="string">&quot; T == {}&quot;</span>, <span class="kw-2">&amp;</span>temperatures);

        <span class="macro">assert!</span>(q_front &gt; <span class="number">0.0</span>, <span class="string">&quot;q_in = {}&quot;</span>, q_front);
        <span class="macro">assert!</span>(q_back &lt; <span class="number">0.0</span>, <span class="string">&quot;q_out = {}&quot;</span>, q_back);

        <span class="kw">let </span>full_qfront = q_front;
        <span class="kw">let </span>full_qback = q_back;

        <span class="macro">assert!</span>(
            (full_qfront + full_qback).abs() &lt; <span class="number">0.08</span>,
            <span class="string">&quot;q_front = {} | q_back = {} | delta = {}&quot;</span>,
            full_qfront,
            full_qback,
            (full_qfront + full_qback).abs()
        );
    }

    <span class="attribute">#[test]
    </span><span class="kw">fn </span>test_rk4() {
        <span class="comment">// Setup
        </span><span class="kw">let </span>c = Matrix::from_data(<span class="number">2</span>, <span class="number">2</span>, <span class="macro">vec!</span>[<span class="number">1.</span>, <span class="number">0.</span>, <span class="number">0.</span>, <span class="number">1.</span>]);
        <span class="kw">let </span>k = Matrix::from_data(<span class="number">2</span>, <span class="number">2</span>, <span class="macro">vec!</span>[<span class="number">1.</span>, -<span class="number">3.</span>, <span class="number">4.</span>, -<span class="number">6.</span>]);
        <span class="kw">let </span>q = Matrix::from_data(<span class="number">2</span>, <span class="number">1</span>, <span class="macro">vec!</span>[<span class="number">0.</span>, <span class="number">0.</span>]);

        <span class="comment">// This system has a transient solution equals to c1*[0.75 1]&#39;* e^(-3t) + c2*[1 1]&#39; * e^(-2t)...

        // Find initial conditions so that C1 and C2 are 1.
        </span><span class="kw">let </span><span class="kw-2">mut </span>temperatures = Matrix::from_data(<span class="number">2</span>, <span class="number">1</span>, <span class="macro">vec!</span>[<span class="number">0.75 </span>+ <span class="number">1.</span>, <span class="number">2.</span>]);

        <span class="kw">let </span>temp_a_fn = |time: Float| <span class="number">0.75 </span>* (-<span class="number">3. </span>* time).exp() + (-<span class="number">2. </span>* time).exp();
        <span class="kw">let </span>temp_b_fn = |time: Float| (-<span class="number">3. </span>* time).exp() + (-<span class="number">2. </span>* time).exp();

        <span class="kw">let </span><span class="kw-2">mut </span>time = <span class="number">0.0</span>;
        <span class="kw">loop </span>{
            <span class="kw">let </span>temp_a = temperatures.get(<span class="number">0</span>, <span class="number">0</span>).unwrap();
            <span class="kw">let </span>exp_temp_a = temp_a_fn(time);
            <span class="kw">let </span>diff_a = (temp_a - exp_temp_a).abs();

            <span class="kw">let </span>temp_b = temperatures.get(<span class="number">1</span>, <span class="number">0</span>).unwrap();
            <span class="kw">let </span>exp_temp_b = temp_b_fn(time);
            <span class="kw">let </span>diff_b = (temp_b - exp_temp_b).abs();
            <span class="kw">const </span>SMOL: Float = <span class="number">1e-8</span>;
            <span class="macro">assert!</span>(
                diff_a &lt; SMOL,
                <span class="string">&quot;temp_a = {} | exp_temp_a = {}, diff = {}&quot;</span>,
                temp_a,
                exp_temp_a,
                diff_a
            );
            <span class="macro">assert!</span>(
                diff_b &lt; SMOL,
                <span class="string">&quot;temp_b = {} | exp_temp_b = {}, diff = {}&quot;</span>,
                temp_b,
                exp_temp_b,
                diff_b
            );

            rk4(<span class="number">0.01</span>, <span class="kw-2">&amp;</span>c, k.clone(), q.clone(), <span class="kw-2">&amp;mut </span>temperatures);

            time += <span class="number">0.01</span>;

            <span class="kw">if </span>time &gt; <span class="number">100. </span>{
                <span class="kw">break</span>;
            }
        }
    }
}
</code></pre></div>
</section></div></main><div id="rustdoc-vars" data-root-path="../../" data-current-crate="heat" data-themes="ayu,dark,light" data-resource-suffix="" data-rustdoc-version="1.65.0 (897e37553 2022-11-02)" ></div></body></html>