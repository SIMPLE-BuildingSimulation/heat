<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Source of the Rust file `src/discretization.rs`."><meta name="keywords" content="rust, rustlang, rust-lang"><title>discretization.rs - source</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../../SourceSerif4-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../FiraSans-Regular.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../FiraSans-Medium.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../SourceCodePro-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../SourceSerif4-Bold.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../SourceCodePro-Semibold.ttf.woff2"><link rel="stylesheet" href="../../normalize.css"><link rel="stylesheet" href="../../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" href="../../ayu.css" disabled><link rel="stylesheet" href="../../dark.css" disabled><link rel="stylesheet" href="../../light.css" id="themeStyle"><script id="default-settings" ></script><script src="../../storage.js"></script><script defer src="../../source-script.js"></script><script defer src="../../source-files.js"></script><script defer src="../../main.js"></script><noscript><link rel="stylesheet" href="../../noscript.css"></noscript><link rel="alternate icon" type="image/png" href="../../favicon-16x16.png"><link rel="alternate icon" type="image/png" href="../../favicon-32x32.png"><link rel="icon" type="image/svg+xml" href="../../favicon.svg"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.9.0/dist/katex.min.css" integrity="sha384-TEMocfGvRuD1rIAacqrknm5BQZ7W7uWitoih+jMNFXQIbNl16bO8OZmylH/Vi/Ei" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/katex@0.9.0/dist/katex.min.js" integrity="sha384-jmxIlussZWB7qCuB+PgKG1uLjjxbVVIayPJwi6cG6Zb4YKq0JIw+OMnkkEC7kYCq" crossorigin="anonymous"></script>
<script>
  "use strict";
  document.addEventListener("DOMContentLoaded", function () {
      var maths = document.getElementsByClassName("language-math");
      for (var i=0; i<maths.length; i++) {
          var el = maths[i];
          katex.render(el.innerText, el, {displayMode: true});
      }

      var codes = document.getElementsByTagName("code");
      for (i=0; i<codes.length; i++) {
          el = codes[i];
          if (el.classList.contains("language-math")) continue;
          if (el.classList.contains("language-inline-math")) {
              katex.render(el.innerText, el);
              continue;
          }

          var parent = el.parentNode;
          if (parent.nodeName.toLowerCase() === "pre") continue;
          // TODO: Can this be done with DOM manipulation rather than string manipulation?
          // https://stackoverflow.com/q/48438067/3019990
          var inlineMath = "$" + el.outerHTML + "$";
          if (parent.innerHTML.indexOf(inlineMath) !== -1) {
              el.classList.add("language-inline-math");
              parent.innerHTML = parent.innerHTML.replace("$" + el.outerHTML + "$", el.outerHTML);
              i--;
          }
      }
  });
</script>

</head><body class="rustdoc source"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="sidebar-logo" href="../../heat/index.html"><div class="logo-container"><img class="rust-logo" src="../../rust-logo.svg" alt="logo"></div></a><h2 class="location"></h2></nav><nav class="sidebar"><a class="sidebar-logo" href="../../heat/index.html"><div class="logo-container"><img class="rust-logo" src="../../rust-logo.svg" alt="logo"></div></a></nav><main><div class="width-limiter"><div class="sub-container"><a class="sub-logo-container" href="../../heat/index.html"><img class="rust-logo" src="../../rust-logo.svg" alt="logo"></a><nav class="sub"><form class="search-form"><div class="search-container"><span></span><input class="search-input" name="search" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><div id="help-button" title="help" tabindex="-1"><button type="button">?</button></div><div id="settings-menu" tabindex="-1"><a href="../../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../../wheel.svg"></a></div></div></form></nav></div><section id="main-content" class="content"><div class="example-wrap"><pre class="line-numbers"><span id="1">1</span>
<span id="2">2</span>
<span id="3">3</span>
<span id="4">4</span>
<span id="5">5</span>
<span id="6">6</span>
<span id="7">7</span>
<span id="8">8</span>
<span id="9">9</span>
<span id="10">10</span>
<span id="11">11</span>
<span id="12">12</span>
<span id="13">13</span>
<span id="14">14</span>
<span id="15">15</span>
<span id="16">16</span>
<span id="17">17</span>
<span id="18">18</span>
<span id="19">19</span>
<span id="20">20</span>
<span id="21">21</span>
<span id="22">22</span>
<span id="23">23</span>
<span id="24">24</span>
<span id="25">25</span>
<span id="26">26</span>
<span id="27">27</span>
<span id="28">28</span>
<span id="29">29</span>
<span id="30">30</span>
<span id="31">31</span>
<span id="32">32</span>
<span id="33">33</span>
<span id="34">34</span>
<span id="35">35</span>
<span id="36">36</span>
<span id="37">37</span>
<span id="38">38</span>
<span id="39">39</span>
<span id="40">40</span>
<span id="41">41</span>
<span id="42">42</span>
<span id="43">43</span>
<span id="44">44</span>
<span id="45">45</span>
<span id="46">46</span>
<span id="47">47</span>
<span id="48">48</span>
<span id="49">49</span>
<span id="50">50</span>
<span id="51">51</span>
<span id="52">52</span>
<span id="53">53</span>
<span id="54">54</span>
<span id="55">55</span>
<span id="56">56</span>
<span id="57">57</span>
<span id="58">58</span>
<span id="59">59</span>
<span id="60">60</span>
<span id="61">61</span>
<span id="62">62</span>
<span id="63">63</span>
<span id="64">64</span>
<span id="65">65</span>
<span id="66">66</span>
<span id="67">67</span>
<span id="68">68</span>
<span id="69">69</span>
<span id="70">70</span>
<span id="71">71</span>
<span id="72">72</span>
<span id="73">73</span>
<span id="74">74</span>
<span id="75">75</span>
<span id="76">76</span>
<span id="77">77</span>
<span id="78">78</span>
<span id="79">79</span>
<span id="80">80</span>
<span id="81">81</span>
<span id="82">82</span>
<span id="83">83</span>
<span id="84">84</span>
<span id="85">85</span>
<span id="86">86</span>
<span id="87">87</span>
<span id="88">88</span>
<span id="89">89</span>
<span id="90">90</span>
<span id="91">91</span>
<span id="92">92</span>
<span id="93">93</span>
<span id="94">94</span>
<span id="95">95</span>
<span id="96">96</span>
<span id="97">97</span>
<span id="98">98</span>
<span id="99">99</span>
<span id="100">100</span>
<span id="101">101</span>
<span id="102">102</span>
<span id="103">103</span>
<span id="104">104</span>
<span id="105">105</span>
<span id="106">106</span>
<span id="107">107</span>
<span id="108">108</span>
<span id="109">109</span>
<span id="110">110</span>
<span id="111">111</span>
<span id="112">112</span>
<span id="113">113</span>
<span id="114">114</span>
<span id="115">115</span>
<span id="116">116</span>
<span id="117">117</span>
<span id="118">118</span>
<span id="119">119</span>
<span id="120">120</span>
<span id="121">121</span>
<span id="122">122</span>
<span id="123">123</span>
<span id="124">124</span>
<span id="125">125</span>
<span id="126">126</span>
<span id="127">127</span>
<span id="128">128</span>
<span id="129">129</span>
<span id="130">130</span>
<span id="131">131</span>
<span id="132">132</span>
<span id="133">133</span>
<span id="134">134</span>
<span id="135">135</span>
<span id="136">136</span>
<span id="137">137</span>
<span id="138">138</span>
<span id="139">139</span>
<span id="140">140</span>
<span id="141">141</span>
<span id="142">142</span>
<span id="143">143</span>
<span id="144">144</span>
<span id="145">145</span>
<span id="146">146</span>
<span id="147">147</span>
<span id="148">148</span>
<span id="149">149</span>
<span id="150">150</span>
<span id="151">151</span>
<span id="152">152</span>
<span id="153">153</span>
<span id="154">154</span>
<span id="155">155</span>
<span id="156">156</span>
<span id="157">157</span>
<span id="158">158</span>
<span id="159">159</span>
<span id="160">160</span>
<span id="161">161</span>
<span id="162">162</span>
<span id="163">163</span>
<span id="164">164</span>
<span id="165">165</span>
<span id="166">166</span>
<span id="167">167</span>
<span id="168">168</span>
<span id="169">169</span>
<span id="170">170</span>
<span id="171">171</span>
<span id="172">172</span>
<span id="173">173</span>
<span id="174">174</span>
<span id="175">175</span>
<span id="176">176</span>
<span id="177">177</span>
<span id="178">178</span>
<span id="179">179</span>
<span id="180">180</span>
<span id="181">181</span>
<span id="182">182</span>
<span id="183">183</span>
<span id="184">184</span>
<span id="185">185</span>
<span id="186">186</span>
<span id="187">187</span>
<span id="188">188</span>
<span id="189">189</span>
<span id="190">190</span>
<span id="191">191</span>
<span id="192">192</span>
<span id="193">193</span>
<span id="194">194</span>
<span id="195">195</span>
<span id="196">196</span>
<span id="197">197</span>
<span id="198">198</span>
<span id="199">199</span>
<span id="200">200</span>
<span id="201">201</span>
<span id="202">202</span>
<span id="203">203</span>
<span id="204">204</span>
<span id="205">205</span>
<span id="206">206</span>
<span id="207">207</span>
<span id="208">208</span>
<span id="209">209</span>
<span id="210">210</span>
<span id="211">211</span>
<span id="212">212</span>
<span id="213">213</span>
<span id="214">214</span>
<span id="215">215</span>
<span id="216">216</span>
<span id="217">217</span>
<span id="218">218</span>
<span id="219">219</span>
<span id="220">220</span>
<span id="221">221</span>
<span id="222">222</span>
<span id="223">223</span>
<span id="224">224</span>
<span id="225">225</span>
<span id="226">226</span>
<span id="227">227</span>
<span id="228">228</span>
<span id="229">229</span>
<span id="230">230</span>
<span id="231">231</span>
<span id="232">232</span>
<span id="233">233</span>
<span id="234">234</span>
<span id="235">235</span>
<span id="236">236</span>
<span id="237">237</span>
<span id="238">238</span>
<span id="239">239</span>
<span id="240">240</span>
<span id="241">241</span>
<span id="242">242</span>
<span id="243">243</span>
<span id="244">244</span>
<span id="245">245</span>
<span id="246">246</span>
<span id="247">247</span>
<span id="248">248</span>
<span id="249">249</span>
<span id="250">250</span>
<span id="251">251</span>
<span id="252">252</span>
<span id="253">253</span>
<span id="254">254</span>
<span id="255">255</span>
<span id="256">256</span>
<span id="257">257</span>
<span id="258">258</span>
<span id="259">259</span>
<span id="260">260</span>
<span id="261">261</span>
<span id="262">262</span>
<span id="263">263</span>
<span id="264">264</span>
<span id="265">265</span>
<span id="266">266</span>
<span id="267">267</span>
<span id="268">268</span>
<span id="269">269</span>
<span id="270">270</span>
<span id="271">271</span>
<span id="272">272</span>
<span id="273">273</span>
<span id="274">274</span>
<span id="275">275</span>
<span id="276">276</span>
<span id="277">277</span>
<span id="278">278</span>
<span id="279">279</span>
<span id="280">280</span>
<span id="281">281</span>
<span id="282">282</span>
<span id="283">283</span>
<span id="284">284</span>
<span id="285">285</span>
<span id="286">286</span>
<span id="287">287</span>
<span id="288">288</span>
<span id="289">289</span>
<span id="290">290</span>
<span id="291">291</span>
<span id="292">292</span>
<span id="293">293</span>
<span id="294">294</span>
<span id="295">295</span>
<span id="296">296</span>
<span id="297">297</span>
<span id="298">298</span>
<span id="299">299</span>
<span id="300">300</span>
<span id="301">301</span>
<span id="302">302</span>
<span id="303">303</span>
<span id="304">304</span>
<span id="305">305</span>
<span id="306">306</span>
<span id="307">307</span>
<span id="308">308</span>
<span id="309">309</span>
<span id="310">310</span>
<span id="311">311</span>
<span id="312">312</span>
<span id="313">313</span>
<span id="314">314</span>
<span id="315">315</span>
<span id="316">316</span>
<span id="317">317</span>
<span id="318">318</span>
<span id="319">319</span>
<span id="320">320</span>
<span id="321">321</span>
<span id="322">322</span>
<span id="323">323</span>
<span id="324">324</span>
<span id="325">325</span>
<span id="326">326</span>
<span id="327">327</span>
<span id="328">328</span>
<span id="329">329</span>
<span id="330">330</span>
<span id="331">331</span>
<span id="332">332</span>
<span id="333">333</span>
<span id="334">334</span>
<span id="335">335</span>
<span id="336">336</span>
<span id="337">337</span>
<span id="338">338</span>
<span id="339">339</span>
<span id="340">340</span>
<span id="341">341</span>
<span id="342">342</span>
<span id="343">343</span>
<span id="344">344</span>
<span id="345">345</span>
<span id="346">346</span>
<span id="347">347</span>
<span id="348">348</span>
<span id="349">349</span>
<span id="350">350</span>
<span id="351">351</span>
<span id="352">352</span>
<span id="353">353</span>
<span id="354">354</span>
<span id="355">355</span>
<span id="356">356</span>
<span id="357">357</span>
<span id="358">358</span>
<span id="359">359</span>
<span id="360">360</span>
<span id="361">361</span>
<span id="362">362</span>
<span id="363">363</span>
<span id="364">364</span>
<span id="365">365</span>
<span id="366">366</span>
<span id="367">367</span>
<span id="368">368</span>
<span id="369">369</span>
<span id="370">370</span>
<span id="371">371</span>
<span id="372">372</span>
<span id="373">373</span>
<span id="374">374</span>
<span id="375">375</span>
<span id="376">376</span>
<span id="377">377</span>
<span id="378">378</span>
<span id="379">379</span>
<span id="380">380</span>
<span id="381">381</span>
<span id="382">382</span>
<span id="383">383</span>
<span id="384">384</span>
<span id="385">385</span>
<span id="386">386</span>
<span id="387">387</span>
<span id="388">388</span>
<span id="389">389</span>
<span id="390">390</span>
<span id="391">391</span>
<span id="392">392</span>
<span id="393">393</span>
<span id="394">394</span>
<span id="395">395</span>
<span id="396">396</span>
<span id="397">397</span>
<span id="398">398</span>
<span id="399">399</span>
<span id="400">400</span>
<span id="401">401</span>
<span id="402">402</span>
<span id="403">403</span>
<span id="404">404</span>
<span id="405">405</span>
<span id="406">406</span>
<span id="407">407</span>
<span id="408">408</span>
<span id="409">409</span>
<span id="410">410</span>
<span id="411">411</span>
<span id="412">412</span>
<span id="413">413</span>
<span id="414">414</span>
<span id="415">415</span>
<span id="416">416</span>
<span id="417">417</span>
<span id="418">418</span>
<span id="419">419</span>
<span id="420">420</span>
<span id="421">421</span>
<span id="422">422</span>
<span id="423">423</span>
<span id="424">424</span>
<span id="425">425</span>
<span id="426">426</span>
<span id="427">427</span>
<span id="428">428</span>
<span id="429">429</span>
<span id="430">430</span>
<span id="431">431</span>
<span id="432">432</span>
<span id="433">433</span>
<span id="434">434</span>
<span id="435">435</span>
<span id="436">436</span>
<span id="437">437</span>
<span id="438">438</span>
<span id="439">439</span>
<span id="440">440</span>
<span id="441">441</span>
<span id="442">442</span>
<span id="443">443</span>
<span id="444">444</span>
<span id="445">445</span>
<span id="446">446</span>
<span id="447">447</span>
<span id="448">448</span>
<span id="449">449</span>
<span id="450">450</span>
<span id="451">451</span>
<span id="452">452</span>
<span id="453">453</span>
<span id="454">454</span>
<span id="455">455</span>
<span id="456">456</span>
<span id="457">457</span>
<span id="458">458</span>
<span id="459">459</span>
<span id="460">460</span>
<span id="461">461</span>
<span id="462">462</span>
<span id="463">463</span>
<span id="464">464</span>
<span id="465">465</span>
<span id="466">466</span>
<span id="467">467</span>
<span id="468">468</span>
<span id="469">469</span>
<span id="470">470</span>
<span id="471">471</span>
<span id="472">472</span>
<span id="473">473</span>
<span id="474">474</span>
<span id="475">475</span>
<span id="476">476</span>
<span id="477">477</span>
<span id="478">478</span>
<span id="479">479</span>
<span id="480">480</span>
<span id="481">481</span>
<span id="482">482</span>
<span id="483">483</span>
<span id="484">484</span>
<span id="485">485</span>
<span id="486">486</span>
<span id="487">487</span>
<span id="488">488</span>
<span id="489">489</span>
<span id="490">490</span>
<span id="491">491</span>
<span id="492">492</span>
<span id="493">493</span>
<span id="494">494</span>
<span id="495">495</span>
<span id="496">496</span>
<span id="497">497</span>
<span id="498">498</span>
<span id="499">499</span>
<span id="500">500</span>
<span id="501">501</span>
<span id="502">502</span>
<span id="503">503</span>
<span id="504">504</span>
<span id="505">505</span>
<span id="506">506</span>
<span id="507">507</span>
<span id="508">508</span>
<span id="509">509</span>
<span id="510">510</span>
<span id="511">511</span>
<span id="512">512</span>
<span id="513">513</span>
<span id="514">514</span>
<span id="515">515</span>
<span id="516">516</span>
<span id="517">517</span>
<span id="518">518</span>
<span id="519">519</span>
<span id="520">520</span>
<span id="521">521</span>
<span id="522">522</span>
<span id="523">523</span>
<span id="524">524</span>
<span id="525">525</span>
<span id="526">526</span>
<span id="527">527</span>
<span id="528">528</span>
<span id="529">529</span>
<span id="530">530</span>
<span id="531">531</span>
<span id="532">532</span>
<span id="533">533</span>
<span id="534">534</span>
<span id="535">535</span>
<span id="536">536</span>
<span id="537">537</span>
<span id="538">538</span>
<span id="539">539</span>
<span id="540">540</span>
<span id="541">541</span>
<span id="542">542</span>
<span id="543">543</span>
<span id="544">544</span>
<span id="545">545</span>
<span id="546">546</span>
<span id="547">547</span>
<span id="548">548</span>
<span id="549">549</span>
<span id="550">550</span>
<span id="551">551</span>
<span id="552">552</span>
<span id="553">553</span>
<span id="554">554</span>
<span id="555">555</span>
<span id="556">556</span>
<span id="557">557</span>
<span id="558">558</span>
<span id="559">559</span>
<span id="560">560</span>
<span id="561">561</span>
<span id="562">562</span>
<span id="563">563</span>
<span id="564">564</span>
<span id="565">565</span>
<span id="566">566</span>
<span id="567">567</span>
<span id="568">568</span>
<span id="569">569</span>
<span id="570">570</span>
<span id="571">571</span>
<span id="572">572</span>
<span id="573">573</span>
<span id="574">574</span>
<span id="575">575</span>
<span id="576">576</span>
<span id="577">577</span>
<span id="578">578</span>
<span id="579">579</span>
<span id="580">580</span>
<span id="581">581</span>
<span id="582">582</span>
<span id="583">583</span>
<span id="584">584</span>
<span id="585">585</span>
<span id="586">586</span>
<span id="587">587</span>
<span id="588">588</span>
<span id="589">589</span>
<span id="590">590</span>
<span id="591">591</span>
<span id="592">592</span>
<span id="593">593</span>
<span id="594">594</span>
<span id="595">595</span>
<span id="596">596</span>
<span id="597">597</span>
<span id="598">598</span>
<span id="599">599</span>
<span id="600">600</span>
<span id="601">601</span>
<span id="602">602</span>
<span id="603">603</span>
<span id="604">604</span>
<span id="605">605</span>
<span id="606">606</span>
<span id="607">607</span>
<span id="608">608</span>
<span id="609">609</span>
<span id="610">610</span>
<span id="611">611</span>
<span id="612">612</span>
<span id="613">613</span>
<span id="614">614</span>
<span id="615">615</span>
<span id="616">616</span>
<span id="617">617</span>
<span id="618">618</span>
<span id="619">619</span>
<span id="620">620</span>
<span id="621">621</span>
<span id="622">622</span>
<span id="623">623</span>
<span id="624">624</span>
<span id="625">625</span>
<span id="626">626</span>
<span id="627">627</span>
<span id="628">628</span>
<span id="629">629</span>
<span id="630">630</span>
<span id="631">631</span>
<span id="632">632</span>
<span id="633">633</span>
<span id="634">634</span>
<span id="635">635</span>
<span id="636">636</span>
<span id="637">637</span>
<span id="638">638</span>
<span id="639">639</span>
<span id="640">640</span>
<span id="641">641</span>
<span id="642">642</span>
<span id="643">643</span>
<span id="644">644</span>
<span id="645">645</span>
<span id="646">646</span>
<span id="647">647</span>
<span id="648">648</span>
<span id="649">649</span>
<span id="650">650</span>
<span id="651">651</span>
<span id="652">652</span>
<span id="653">653</span>
<span id="654">654</span>
<span id="655">655</span>
<span id="656">656</span>
<span id="657">657</span>
<span id="658">658</span>
<span id="659">659</span>
<span id="660">660</span>
<span id="661">661</span>
<span id="662">662</span>
<span id="663">663</span>
<span id="664">664</span>
<span id="665">665</span>
<span id="666">666</span>
<span id="667">667</span>
<span id="668">668</span>
<span id="669">669</span>
<span id="670">670</span>
<span id="671">671</span>
<span id="672">672</span>
<span id="673">673</span>
<span id="674">674</span>
<span id="675">675</span>
<span id="676">676</span>
<span id="677">677</span>
<span id="678">678</span>
<span id="679">679</span>
<span id="680">680</span>
<span id="681">681</span>
<span id="682">682</span>
<span id="683">683</span>
<span id="684">684</span>
<span id="685">685</span>
<span id="686">686</span>
<span id="687">687</span>
<span id="688">688</span>
<span id="689">689</span>
<span id="690">690</span>
<span id="691">691</span>
<span id="692">692</span>
<span id="693">693</span>
<span id="694">694</span>
<span id="695">695</span>
<span id="696">696</span>
<span id="697">697</span>
<span id="698">698</span>
<span id="699">699</span>
<span id="700">700</span>
<span id="701">701</span>
<span id="702">702</span>
<span id="703">703</span>
<span id="704">704</span>
<span id="705">705</span>
<span id="706">706</span>
<span id="707">707</span>
<span id="708">708</span>
<span id="709">709</span>
<span id="710">710</span>
<span id="711">711</span>
<span id="712">712</span>
<span id="713">713</span>
<span id="714">714</span>
<span id="715">715</span>
<span id="716">716</span>
<span id="717">717</span>
<span id="718">718</span>
<span id="719">719</span>
<span id="720">720</span>
<span id="721">721</span>
<span id="722">722</span>
<span id="723">723</span>
<span id="724">724</span>
<span id="725">725</span>
<span id="726">726</span>
<span id="727">727</span>
<span id="728">728</span>
<span id="729">729</span>
<span id="730">730</span>
<span id="731">731</span>
<span id="732">732</span>
<span id="733">733</span>
<span id="734">734</span>
<span id="735">735</span>
<span id="736">736</span>
<span id="737">737</span>
<span id="738">738</span>
<span id="739">739</span>
<span id="740">740</span>
<span id="741">741</span>
<span id="742">742</span>
<span id="743">743</span>
<span id="744">744</span>
<span id="745">745</span>
<span id="746">746</span>
<span id="747">747</span>
<span id="748">748</span>
<span id="749">749</span>
<span id="750">750</span>
<span id="751">751</span>
<span id="752">752</span>
<span id="753">753</span>
<span id="754">754</span>
<span id="755">755</span>
<span id="756">756</span>
<span id="757">757</span>
<span id="758">758</span>
<span id="759">759</span>
<span id="760">760</span>
<span id="761">761</span>
<span id="762">762</span>
<span id="763">763</span>
<span id="764">764</span>
<span id="765">765</span>
<span id="766">766</span>
<span id="767">767</span>
<span id="768">768</span>
<span id="769">769</span>
<span id="770">770</span>
<span id="771">771</span>
<span id="772">772</span>
<span id="773">773</span>
<span id="774">774</span>
<span id="775">775</span>
<span id="776">776</span>
<span id="777">777</span>
<span id="778">778</span>
<span id="779">779</span>
<span id="780">780</span>
<span id="781">781</span>
<span id="782">782</span>
<span id="783">783</span>
<span id="784">784</span>
<span id="785">785</span>
<span id="786">786</span>
<span id="787">787</span>
<span id="788">788</span>
<span id="789">789</span>
<span id="790">790</span>
<span id="791">791</span>
<span id="792">792</span>
<span id="793">793</span>
<span id="794">794</span>
<span id="795">795</span>
<span id="796">796</span>
<span id="797">797</span>
<span id="798">798</span>
<span id="799">799</span>
<span id="800">800</span>
<span id="801">801</span>
<span id="802">802</span>
<span id="803">803</span>
<span id="804">804</span>
<span id="805">805</span>
<span id="806">806</span>
<span id="807">807</span>
<span id="808">808</span>
<span id="809">809</span>
<span id="810">810</span>
<span id="811">811</span>
<span id="812">812</span>
<span id="813">813</span>
<span id="814">814</span>
<span id="815">815</span>
<span id="816">816</span>
<span id="817">817</span>
<span id="818">818</span>
<span id="819">819</span>
<span id="820">820</span>
<span id="821">821</span>
<span id="822">822</span>
<span id="823">823</span>
<span id="824">824</span>
<span id="825">825</span>
<span id="826">826</span>
<span id="827">827</span>
<span id="828">828</span>
<span id="829">829</span>
<span id="830">830</span>
<span id="831">831</span>
<span id="832">832</span>
<span id="833">833</span>
<span id="834">834</span>
<span id="835">835</span>
<span id="836">836</span>
<span id="837">837</span>
<span id="838">838</span>
<span id="839">839</span>
<span id="840">840</span>
<span id="841">841</span>
<span id="842">842</span>
<span id="843">843</span>
<span id="844">844</span>
<span id="845">845</span>
<span id="846">846</span>
<span id="847">847</span>
<span id="848">848</span>
<span id="849">849</span>
<span id="850">850</span>
<span id="851">851</span>
<span id="852">852</span>
<span id="853">853</span>
<span id="854">854</span>
<span id="855">855</span>
<span id="856">856</span>
<span id="857">857</span>
<span id="858">858</span>
<span id="859">859</span>
<span id="860">860</span>
<span id="861">861</span>
<span id="862">862</span>
<span id="863">863</span>
<span id="864">864</span>
<span id="865">865</span>
<span id="866">866</span>
<span id="867">867</span>
<span id="868">868</span>
<span id="869">869</span>
<span id="870">870</span>
<span id="871">871</span>
<span id="872">872</span>
<span id="873">873</span>
<span id="874">874</span>
<span id="875">875</span>
<span id="876">876</span>
<span id="877">877</span>
<span id="878">878</span>
<span id="879">879</span>
<span id="880">880</span>
<span id="881">881</span>
<span id="882">882</span>
<span id="883">883</span>
<span id="884">884</span>
<span id="885">885</span>
<span id="886">886</span>
<span id="887">887</span>
<span id="888">888</span>
<span id="889">889</span>
<span id="890">890</span>
<span id="891">891</span>
<span id="892">892</span>
<span id="893">893</span>
<span id="894">894</span>
<span id="895">895</span>
<span id="896">896</span>
<span id="897">897</span>
<span id="898">898</span>
<span id="899">899</span>
<span id="900">900</span>
<span id="901">901</span>
<span id="902">902</span>
<span id="903">903</span>
<span id="904">904</span>
<span id="905">905</span>
<span id="906">906</span>
<span id="907">907</span>
<span id="908">908</span>
<span id="909">909</span>
<span id="910">910</span>
<span id="911">911</span>
<span id="912">912</span>
<span id="913">913</span>
<span id="914">914</span>
<span id="915">915</span>
<span id="916">916</span>
<span id="917">917</span>
<span id="918">918</span>
<span id="919">919</span>
<span id="920">920</span>
<span id="921">921</span>
<span id="922">922</span>
<span id="923">923</span>
<span id="924">924</span>
<span id="925">925</span>
<span id="926">926</span>
<span id="927">927</span>
<span id="928">928</span>
<span id="929">929</span>
<span id="930">930</span>
<span id="931">931</span>
<span id="932">932</span>
<span id="933">933</span>
<span id="934">934</span>
<span id="935">935</span>
<span id="936">936</span>
<span id="937">937</span>
<span id="938">938</span>
<span id="939">939</span>
<span id="940">940</span>
<span id="941">941</span>
<span id="942">942</span>
<span id="943">943</span>
<span id="944">944</span>
<span id="945">945</span>
<span id="946">946</span>
<span id="947">947</span>
<span id="948">948</span>
<span id="949">949</span>
<span id="950">950</span>
<span id="951">951</span>
<span id="952">952</span>
<span id="953">953</span>
<span id="954">954</span>
<span id="955">955</span>
<span id="956">956</span>
<span id="957">957</span>
<span id="958">958</span>
<span id="959">959</span>
<span id="960">960</span>
<span id="961">961</span>
<span id="962">962</span>
<span id="963">963</span>
<span id="964">964</span>
<span id="965">965</span>
<span id="966">966</span>
<span id="967">967</span>
<span id="968">968</span>
<span id="969">969</span>
<span id="970">970</span>
<span id="971">971</span>
<span id="972">972</span>
<span id="973">973</span>
<span id="974">974</span>
<span id="975">975</span>
<span id="976">976</span>
<span id="977">977</span>
<span id="978">978</span>
<span id="979">979</span>
<span id="980">980</span>
<span id="981">981</span>
<span id="982">982</span>
<span id="983">983</span>
<span id="984">984</span>
<span id="985">985</span>
<span id="986">986</span>
<span id="987">987</span>
<span id="988">988</span>
<span id="989">989</span>
<span id="990">990</span>
<span id="991">991</span>
<span id="992">992</span>
<span id="993">993</span>
<span id="994">994</span>
<span id="995">995</span>
<span id="996">996</span>
<span id="997">997</span>
<span id="998">998</span>
<span id="999">999</span>
<span id="1000">1000</span>
<span id="1001">1001</span>
<span id="1002">1002</span>
<span id="1003">1003</span>
<span id="1004">1004</span>
<span id="1005">1005</span>
<span id="1006">1006</span>
<span id="1007">1007</span>
<span id="1008">1008</span>
<span id="1009">1009</span>
<span id="1010">1010</span>
<span id="1011">1011</span>
<span id="1012">1012</span>
<span id="1013">1013</span>
<span id="1014">1014</span>
<span id="1015">1015</span>
<span id="1016">1016</span>
<span id="1017">1017</span>
<span id="1018">1018</span>
<span id="1019">1019</span>
<span id="1020">1020</span>
<span id="1021">1021</span>
<span id="1022">1022</span>
<span id="1023">1023</span>
<span id="1024">1024</span>
<span id="1025">1025</span>
<span id="1026">1026</span>
<span id="1027">1027</span>
<span id="1028">1028</span>
<span id="1029">1029</span>
<span id="1030">1030</span>
<span id="1031">1031</span>
<span id="1032">1032</span>
<span id="1033">1033</span>
<span id="1034">1034</span>
<span id="1035">1035</span>
<span id="1036">1036</span>
<span id="1037">1037</span>
<span id="1038">1038</span>
<span id="1039">1039</span>
<span id="1040">1040</span>
<span id="1041">1041</span>
<span id="1042">1042</span>
<span id="1043">1043</span>
<span id="1044">1044</span>
<span id="1045">1045</span>
<span id="1046">1046</span>
<span id="1047">1047</span>
<span id="1048">1048</span>
<span id="1049">1049</span>
<span id="1050">1050</span>
<span id="1051">1051</span>
<span id="1052">1052</span>
<span id="1053">1053</span>
<span id="1054">1054</span>
<span id="1055">1055</span>
<span id="1056">1056</span>
<span id="1057">1057</span>
<span id="1058">1058</span>
<span id="1059">1059</span>
<span id="1060">1060</span>
<span id="1061">1061</span>
<span id="1062">1062</span>
<span id="1063">1063</span>
<span id="1064">1064</span>
<span id="1065">1065</span>
<span id="1066">1066</span>
<span id="1067">1067</span>
<span id="1068">1068</span>
<span id="1069">1069</span>
<span id="1070">1070</span>
<span id="1071">1071</span>
<span id="1072">1072</span>
<span id="1073">1073</span>
<span id="1074">1074</span>
<span id="1075">1075</span>
<span id="1076">1076</span>
<span id="1077">1077</span>
<span id="1078">1078</span>
<span id="1079">1079</span>
<span id="1080">1080</span>
<span id="1081">1081</span>
<span id="1082">1082</span>
<span id="1083">1083</span>
<span id="1084">1084</span>
<span id="1085">1085</span>
<span id="1086">1086</span>
<span id="1087">1087</span>
<span id="1088">1088</span>
<span id="1089">1089</span>
<span id="1090">1090</span>
<span id="1091">1091</span>
<span id="1092">1092</span>
<span id="1093">1093</span>
<span id="1094">1094</span>
<span id="1095">1095</span>
<span id="1096">1096</span>
<span id="1097">1097</span>
<span id="1098">1098</span>
<span id="1099">1099</span>
<span id="1100">1100</span>
<span id="1101">1101</span>
<span id="1102">1102</span>
<span id="1103">1103</span>
<span id="1104">1104</span>
<span id="1105">1105</span>
<span id="1106">1106</span>
<span id="1107">1107</span>
<span id="1108">1108</span>
<span id="1109">1109</span>
<span id="1110">1110</span>
<span id="1111">1111</span>
<span id="1112">1112</span>
<span id="1113">1113</span>
<span id="1114">1114</span>
<span id="1115">1115</span>
<span id="1116">1116</span>
<span id="1117">1117</span>
<span id="1118">1118</span>
<span id="1119">1119</span>
<span id="1120">1120</span>
<span id="1121">1121</span>
<span id="1122">1122</span>
<span id="1123">1123</span>
<span id="1124">1124</span>
<span id="1125">1125</span>
<span id="1126">1126</span>
<span id="1127">1127</span>
<span id="1128">1128</span>
<span id="1129">1129</span>
<span id="1130">1130</span>
<span id="1131">1131</span>
<span id="1132">1132</span>
<span id="1133">1133</span>
<span id="1134">1134</span>
<span id="1135">1135</span>
<span id="1136">1136</span>
<span id="1137">1137</span>
<span id="1138">1138</span>
<span id="1139">1139</span>
<span id="1140">1140</span>
<span id="1141">1141</span>
<span id="1142">1142</span>
<span id="1143">1143</span>
<span id="1144">1144</span>
<span id="1145">1145</span>
<span id="1146">1146</span>
<span id="1147">1147</span>
<span id="1148">1148</span>
<span id="1149">1149</span>
<span id="1150">1150</span>
<span id="1151">1151</span>
<span id="1152">1152</span>
<span id="1153">1153</span>
<span id="1154">1154</span>
<span id="1155">1155</span>
<span id="1156">1156</span>
<span id="1157">1157</span>
<span id="1158">1158</span>
<span id="1159">1159</span>
<span id="1160">1160</span>
<span id="1161">1161</span>
<span id="1162">1162</span>
<span id="1163">1163</span>
<span id="1164">1164</span>
<span id="1165">1165</span>
<span id="1166">1166</span>
<span id="1167">1167</span>
<span id="1168">1168</span>
<span id="1169">1169</span>
<span id="1170">1170</span>
<span id="1171">1171</span>
<span id="1172">1172</span>
<span id="1173">1173</span>
<span id="1174">1174</span>
<span id="1175">1175</span>
<span id="1176">1176</span>
<span id="1177">1177</span>
<span id="1178">1178</span>
<span id="1179">1179</span>
<span id="1180">1180</span>
<span id="1181">1181</span>
<span id="1182">1182</span>
<span id="1183">1183</span>
<span id="1184">1184</span>
<span id="1185">1185</span>
<span id="1186">1186</span>
<span id="1187">1187</span>
<span id="1188">1188</span>
<span id="1189">1189</span>
<span id="1190">1190</span>
<span id="1191">1191</span>
<span id="1192">1192</span>
<span id="1193">1193</span>
<span id="1194">1194</span>
<span id="1195">1195</span>
<span id="1196">1196</span>
<span id="1197">1197</span>
<span id="1198">1198</span>
<span id="1199">1199</span>
<span id="1200">1200</span>
<span id="1201">1201</span>
<span id="1202">1202</span>
<span id="1203">1203</span>
<span id="1204">1204</span>
<span id="1205">1205</span>
<span id="1206">1206</span>
<span id="1207">1207</span>
<span id="1208">1208</span>
<span id="1209">1209</span>
<span id="1210">1210</span>
<span id="1211">1211</span>
<span id="1212">1212</span>
<span id="1213">1213</span>
<span id="1214">1214</span>
<span id="1215">1215</span>
<span id="1216">1216</span>
<span id="1217">1217</span>
<span id="1218">1218</span>
<span id="1219">1219</span>
<span id="1220">1220</span>
<span id="1221">1221</span>
<span id="1222">1222</span>
<span id="1223">1223</span>
<span id="1224">1224</span>
<span id="1225">1225</span>
<span id="1226">1226</span>
<span id="1227">1227</span>
<span id="1228">1228</span>
<span id="1229">1229</span>
<span id="1230">1230</span>
<span id="1231">1231</span>
<span id="1232">1232</span>
<span id="1233">1233</span>
<span id="1234">1234</span>
<span id="1235">1235</span>
<span id="1236">1236</span>
<span id="1237">1237</span>
<span id="1238">1238</span>
<span id="1239">1239</span>
<span id="1240">1240</span>
<span id="1241">1241</span>
<span id="1242">1242</span>
<span id="1243">1243</span>
<span id="1244">1244</span>
<span id="1245">1245</span>
<span id="1246">1246</span>
<span id="1247">1247</span>
<span id="1248">1248</span>
<span id="1249">1249</span>
<span id="1250">1250</span>
<span id="1251">1251</span>
<span id="1252">1252</span>
<span id="1253">1253</span>
<span id="1254">1254</span>
<span id="1255">1255</span>
<span id="1256">1256</span>
<span id="1257">1257</span>
<span id="1258">1258</span>
<span id="1259">1259</span>
<span id="1260">1260</span>
<span id="1261">1261</span>
<span id="1262">1262</span>
<span id="1263">1263</span>
<span id="1264">1264</span>
<span id="1265">1265</span>
<span id="1266">1266</span>
<span id="1267">1267</span>
<span id="1268">1268</span>
<span id="1269">1269</span>
<span id="1270">1270</span>
<span id="1271">1271</span>
<span id="1272">1272</span>
<span id="1273">1273</span>
<span id="1274">1274</span>
<span id="1275">1275</span>
<span id="1276">1276</span>
<span id="1277">1277</span>
<span id="1278">1278</span>
<span id="1279">1279</span>
<span id="1280">1280</span>
<span id="1281">1281</span>
<span id="1282">1282</span>
<span id="1283">1283</span>
<span id="1284">1284</span>
<span id="1285">1285</span>
<span id="1286">1286</span>
<span id="1287">1287</span>
<span id="1288">1288</span>
<span id="1289">1289</span>
<span id="1290">1290</span>
<span id="1291">1291</span>
<span id="1292">1292</span>
<span id="1293">1293</span>
<span id="1294">1294</span>
<span id="1295">1295</span>
<span id="1296">1296</span>
<span id="1297">1297</span>
<span id="1298">1298</span>
<span id="1299">1299</span>
<span id="1300">1300</span>
<span id="1301">1301</span>
<span id="1302">1302</span>
<span id="1303">1303</span>
<span id="1304">1304</span>
<span id="1305">1305</span>
<span id="1306">1306</span>
<span id="1307">1307</span>
<span id="1308">1308</span>
<span id="1309">1309</span>
<span id="1310">1310</span>
<span id="1311">1311</span>
<span id="1312">1312</span>
<span id="1313">1313</span>
<span id="1314">1314</span>
<span id="1315">1315</span>
<span id="1316">1316</span>
<span id="1317">1317</span>
<span id="1318">1318</span>
<span id="1319">1319</span>
<span id="1320">1320</span>
<span id="1321">1321</span>
<span id="1322">1322</span>
<span id="1323">1323</span>
<span id="1324">1324</span>
<span id="1325">1325</span>
<span id="1326">1326</span>
<span id="1327">1327</span>
<span id="1328">1328</span>
<span id="1329">1329</span>
<span id="1330">1330</span>
<span id="1331">1331</span>
<span id="1332">1332</span>
<span id="1333">1333</span>
<span id="1334">1334</span>
<span id="1335">1335</span>
<span id="1336">1336</span>
<span id="1337">1337</span>
<span id="1338">1338</span>
<span id="1339">1339</span>
<span id="1340">1340</span>
<span id="1341">1341</span>
<span id="1342">1342</span>
<span id="1343">1343</span>
<span id="1344">1344</span>
<span id="1345">1345</span>
<span id="1346">1346</span>
<span id="1347">1347</span>
<span id="1348">1348</span>
<span id="1349">1349</span>
<span id="1350">1350</span>
<span id="1351">1351</span>
<span id="1352">1352</span>
<span id="1353">1353</span>
<span id="1354">1354</span>
<span id="1355">1355</span>
<span id="1356">1356</span>
<span id="1357">1357</span>
<span id="1358">1358</span>
<span id="1359">1359</span>
<span id="1360">1360</span>
<span id="1361">1361</span>
<span id="1362">1362</span>
<span id="1363">1363</span>
<span id="1364">1364</span>
<span id="1365">1365</span>
<span id="1366">1366</span>
<span id="1367">1367</span>
<span id="1368">1368</span>
<span id="1369">1369</span>
<span id="1370">1370</span>
<span id="1371">1371</span>
<span id="1372">1372</span>
<span id="1373">1373</span>
<span id="1374">1374</span>
<span id="1375">1375</span>
<span id="1376">1376</span>
<span id="1377">1377</span>
<span id="1378">1378</span>
<span id="1379">1379</span>
<span id="1380">1380</span>
<span id="1381">1381</span>
<span id="1382">1382</span>
<span id="1383">1383</span>
<span id="1384">1384</span>
<span id="1385">1385</span>
<span id="1386">1386</span>
<span id="1387">1387</span>
<span id="1388">1388</span>
<span id="1389">1389</span>
<span id="1390">1390</span>
<span id="1391">1391</span>
<span id="1392">1392</span>
<span id="1393">1393</span>
<span id="1394">1394</span>
<span id="1395">1395</span>
<span id="1396">1396</span>
<span id="1397">1397</span>
<span id="1398">1398</span>
<span id="1399">1399</span>
<span id="1400">1400</span>
<span id="1401">1401</span>
<span id="1402">1402</span>
<span id="1403">1403</span>
<span id="1404">1404</span>
<span id="1405">1405</span>
<span id="1406">1406</span>
<span id="1407">1407</span>
<span id="1408">1408</span>
<span id="1409">1409</span>
<span id="1410">1410</span>
<span id="1411">1411</span>
<span id="1412">1412</span>
<span id="1413">1413</span>
<span id="1414">1414</span>
<span id="1415">1415</span>
<span id="1416">1416</span>
<span id="1417">1417</span>
<span id="1418">1418</span>
<span id="1419">1419</span>
<span id="1420">1420</span>
<span id="1421">1421</span>
<span id="1422">1422</span>
<span id="1423">1423</span>
<span id="1424">1424</span>
<span id="1425">1425</span>
<span id="1426">1426</span>
<span id="1427">1427</span>
<span id="1428">1428</span>
<span id="1429">1429</span>
<span id="1430">1430</span>
<span id="1431">1431</span>
<span id="1432">1432</span>
<span id="1433">1433</span>
<span id="1434">1434</span>
<span id="1435">1435</span>
<span id="1436">1436</span>
<span id="1437">1437</span>
<span id="1438">1438</span>
<span id="1439">1439</span>
<span id="1440">1440</span>
<span id="1441">1441</span>
<span id="1442">1442</span>
<span id="1443">1443</span>
<span id="1444">1444</span>
<span id="1445">1445</span>
<span id="1446">1446</span>
<span id="1447">1447</span>
<span id="1448">1448</span>
<span id="1449">1449</span>
<span id="1450">1450</span>
<span id="1451">1451</span>
<span id="1452">1452</span>
<span id="1453">1453</span>
<span id="1454">1454</span>
<span id="1455">1455</span>
<span id="1456">1456</span>
<span id="1457">1457</span>
<span id="1458">1458</span>
<span id="1459">1459</span>
<span id="1460">1460</span>
<span id="1461">1461</span>
<span id="1462">1462</span>
<span id="1463">1463</span>
<span id="1464">1464</span>
<span id="1465">1465</span>
<span id="1466">1466</span>
<span id="1467">1467</span>
<span id="1468">1468</span>
<span id="1469">1469</span>
<span id="1470">1470</span>
<span id="1471">1471</span>
<span id="1472">1472</span>
<span id="1473">1473</span>
<span id="1474">1474</span>
<span id="1475">1475</span>
<span id="1476">1476</span>
<span id="1477">1477</span>
<span id="1478">1478</span>
<span id="1479">1479</span>
<span id="1480">1480</span>
<span id="1481">1481</span>
<span id="1482">1482</span>
<span id="1483">1483</span>
<span id="1484">1484</span>
<span id="1485">1485</span>
<span id="1486">1486</span>
<span id="1487">1487</span>
<span id="1488">1488</span>
<span id="1489">1489</span>
<span id="1490">1490</span>
<span id="1491">1491</span>
<span id="1492">1492</span>
<span id="1493">1493</span>
<span id="1494">1494</span>
<span id="1495">1495</span>
<span id="1496">1496</span>
<span id="1497">1497</span>
<span id="1498">1498</span>
<span id="1499">1499</span>
<span id="1500">1500</span>
<span id="1501">1501</span>
<span id="1502">1502</span>
<span id="1503">1503</span>
<span id="1504">1504</span>
<span id="1505">1505</span>
<span id="1506">1506</span>
</pre><pre class="rust"><code><span class="comment">/*
MIT License
Copyright (c) 2021 Germán Molina
Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the &quot;Software&quot;), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:
The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.
THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
*/

</span><span class="kw">pub</span>(<span class="kw">crate</span>) <span class="kw">const </span>MAX_RS: Float = <span class="number">0.05</span>;
<span class="kw">use </span><span class="kw">crate</span>::cavity::Cavity;
<span class="kw">use </span><span class="kw">crate</span>::convection::ConvectionParams;
<span class="kw">use </span><span class="kw">crate</span>::Float;
<span class="kw">use </span>matrix::Matrix;
<span class="kw">use </span>simple_model::{Construction, SimpleModel, Substance};
<span class="kw">use </span>std::rc::Rc;

<span class="doccomment">/// Represents a thermal connection in the thermal network.
/// It can be a Cavity, a Solid, or other.
</span><span class="attribute">#[derive(Debug, Clone)]
</span><span class="kw">pub enum </span>UValue {
    <span class="doccomment">/// A normal (i.e., $`\lambda/\Delta x`$) U-value
    </span>Solid(Float),

    <span class="doccomment">/// A cavity, comprised of a gas
    </span>Cavity(Box&lt;Cavity&gt;),

    <span class="doccomment">/// The resistance is a surface coefficient.
    </span>Back,

    <span class="doccomment">/// Undefined yet
    </span><span class="prelude-val">None</span>,
}

<span class="kw">impl </span>UValue {
    <span class="doccomment">/// Gets the U-value of a `UValue` object
    </span><span class="kw">pub fn </span>u_value(<span class="kw-2">&amp;</span><span class="self">self</span>, t_before: Float, t_after: Float) -&gt; Float {
        <span class="kw">match </span><span class="self">self </span>{
            <span class="self">Self</span>::Solid(u) =&gt; <span class="kw-2">*</span>u,
            <span class="self">Self</span>::Cavity(c) =&gt; c.u_value(t_before, t_after),
            <span class="self">Self</span>::Back =&gt; <span class="number">0.</span>, <span class="comment">// This should be calculated appart
            </span><span class="self">Self</span>::None =&gt; <span class="macro">panic!</span>(<span class="string">&quot;Attempting to get the u-value of None&quot;</span>),
        }
    }
}

<span class="kw">impl </span>std::default::Default <span class="kw">for </span>UValue {
    <span class="kw">fn </span>default() -&gt; <span class="self">Self </span>{
        UValue::None
    }
}

<span class="doccomment">/// Represents the discretization of a [`Construction`] for heat transfer
/// calculation purposes.
///
/// &gt; **Note:** This object contains all the [`Cavity`] objects in it, which
/// contain information not only about their thickness but also their orientation.
/// This means that one `Discretization` should exist per `Surface`, not just by `Construction`.
</span><span class="kw">pub struct </span>Discretization {
    <span class="doccomment">/// Contains the node&#39;s mass and the `UValue` of each segment
    </span><span class="kw">pub </span>segments: Vec&lt;(Float, UValue)&gt;,

    <span class="doccomment">/// Contains the minimum number of timesteps per model timestep that
    /// this discretization requires to ensure numerical stability and accuracy.
    ///
    /// While the caller model—e.g., a Multiphysics Simulation model—may attempt
    /// to simulate at a certain timestep, some of the constructions in it may
    /// require smaller timesteps to ensure numerical stability and accuracy.
    /// This means that—on each timestep in the caller model—the thermal model needs
    /// to perform `time_subdivision` sub-timesteps.
    </span><span class="kw">pub </span>tstep_subdivision: usize,

    <span class="doccomment">/// The number of elements on each layer
    </span><span class="kw">pub </span>n_elements: Vec&lt;usize&gt;,
}

<span class="kw">impl </span>Discretization {
    <span class="doccomment">/// Creates a new `Discretization`.
    ///
    /// It first calculates the `tstep_subdivision` and the number of elements
    /// on each layer of Construction by calling `discretize_construction()`; and then builds the
    /// `Discretization` by calling `build()`.
    </span><span class="kw">pub fn </span>new(
        construction: <span class="kw-2">&amp;</span>Rc&lt;Construction&gt;,
        model: <span class="kw-2">&amp;</span>SimpleModel,
        model_dt: Float,
        max_dx: Float,
        min_dt: Float,
        height: Float,
        angle: Float,
    ) -&gt; <span class="prelude-ty">Result</span>&lt;<span class="self">Self</span>, String&gt; {
        <span class="kw">let </span>(tstep_subdivision, n_elements) =
            <span class="self">Self</span>::discretize_construction(construction, model, model_dt, max_dx, min_dt)<span class="question-mark">?</span>;
        <span class="self">Self</span>::build(
            construction,
            model,
            tstep_subdivision,
            n_elements,
            height,
            angle,
        )
    }

    <span class="doccomment">/// Auxiliary function for `get_chunks()` function
    </span><span class="kw">fn </span>chunk_segments(<span class="kw-2">&amp;</span><span class="self">self</span>, indexes: <span class="kw-2">&amp;</span>[usize]) -&gt; Vec&lt;(usize, usize)&gt; {
        <span class="kw">if </span>indexes.is_empty() {
            <span class="kw">return </span>Vec::with_capacity(<span class="number">0</span>);
        }
        <span class="kw">let </span><span class="kw-2">mut </span>start = indexes[<span class="number">0</span>];
        <span class="kw">let </span><span class="kw-2">mut </span>prev = start;
        <span class="kw">let </span><span class="kw-2">mut </span>ret = Vec::new();
        <span class="kw">for </span>i <span class="kw">in </span>indexes.iter().skip(<span class="number">1</span>) {
            <span class="macro">assert!</span>(<span class="kw-2">*</span>i &gt; start);
            <span class="macro">assert!</span>(<span class="kw-2">*</span>i &gt; prev);
            <span class="kw">if </span><span class="kw-2">*</span>i - prev == <span class="number">1 </span>{
                prev = <span class="kw-2">*</span>i;
            } <span class="kw">else </span>{
                ret.push((start, prev + <span class="number">1</span>));
                start = <span class="kw-2">*</span>i;
                prev = start;
            }
        }
        ret.push((start, prev + <span class="number">1</span>));
        ret
    }

    <span class="doccomment">/// Gets a a the segments that correspond to Massive and non-massive chunks.
    ///
    /// The purpose of this is that—when marching—we can know which nodes are massive
    /// and which ones are not, and thus solving them through different methods.
    </span><span class="attribute">#[allow(clippy::type_complexity)]
    </span><span class="kw">pub fn </span>get_chunks(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; (Vec&lt;(usize, usize)&gt;, Vec&lt;(usize, usize)&gt;) {
        <span class="kw">let </span>mass_nodes: Vec&lt;usize&gt; = <span class="self">self
            </span>.segments
            .iter()
            .enumerate()
            .filter_map(|(i, x)| <span class="kw">if </span>x.<span class="number">0 </span>&gt;= <span class="number">1e-5 </span>{ <span class="prelude-val">Some</span>(i) } <span class="kw">else </span>{ <span class="prelude-val">None </span>})
            .collect();
        <span class="kw">let </span>nomass_nodes: Vec&lt;usize&gt; = <span class="self">self
            </span>.segments
            .iter()
            .enumerate()
            .filter_map(|(i, x)| <span class="kw">if </span>x.<span class="number">0 </span>&lt; <span class="number">1e-5 </span>{ <span class="prelude-val">Some</span>(i) } <span class="kw">else </span>{ <span class="prelude-val">None </span>})
            .collect();
        <span class="kw">let </span>mass = <span class="self">self</span>.chunk_segments(<span class="kw-2">&amp;</span>mass_nodes);
        <span class="kw">let </span>nomass = <span class="self">self</span>.chunk_segments(<span class="kw-2">&amp;</span>nomass_nodes);
        (mass, nomass)
    }

    <span class="doccomment">/// Creates the `segments` of the `Discretization`.
    </span><span class="kw">fn </span>build(
        construction: <span class="kw-2">&amp;</span>Rc&lt;Construction&gt;,
        model: <span class="kw-2">&amp;</span>SimpleModel,
        tstep_subdivision: usize,
        n_elements: Vec&lt;usize&gt;,
        height: Float,
        angle: Float,
    ) -&gt; <span class="prelude-ty">Result</span>&lt;<span class="self">Self</span>, String&gt; {
        <span class="macro">debug_assert_eq!</span>(n_elements.len(), construction.materials.len());

        <span class="comment">// Let&#39;s start with an empty set of segments
        </span><span class="kw">let </span><span class="kw-2">mut </span>n_nodes: usize = n_elements.iter().sum();
        <span class="comment">// Add those that are Zero
        </span>n_nodes += n_elements.iter().filter(|x| <span class="kw-2">**</span>x == <span class="number">0</span>).count() + <span class="number">1</span>;
        <span class="comment">// n_nodes = n_nodes.max(construction.materials.len() + 1); // At least one per layer... but Zero means  &quot;no_mass wall&quot;

        </span><span class="kw">let </span><span class="kw-2">mut </span>segments: Vec&lt;(Float, UValue)&gt; = <span class="macro">vec!</span>[(<span class="number">0.0</span>, UValue::default()); n_nodes];

        <span class="kw">let </span><span class="kw-2">mut </span>n_segment = <span class="number">0</span>;
        <span class="kw">for </span>(n_layer, n) <span class="kw">in </span>n_elements.iter().enumerate() {
            <span class="kw">let </span><span class="kw-2">mut </span>n = <span class="kw-2">*</span>n;

            <span class="kw">let </span>mat_name = <span class="kw-2">&amp;</span>construction.materials[n_layer];
            <span class="kw">let </span>material = model.get_material(mat_name)<span class="question-mark">?</span>;
            <span class="kw">let </span>substance = model.get_substance(<span class="kw-2">&amp;</span>material.substance)<span class="question-mark">?</span>;

            <span class="comment">// get the mass of each segment.
            </span><span class="kw">let </span>mass = <span class="kw">if </span>n == <span class="number">0 </span>{
                <span class="number">0.0
            </span>} <span class="kw">else </span>{
                <span class="kw">match </span><span class="kw-2">&amp;</span>substance {
                    Substance::Normal(s) =&gt; {
                        <span class="kw">let </span>dx = material.thickness / n <span class="kw">as </span>Float;
                        <span class="kw">let </span>rho = s.density()<span class="question-mark">?</span>;
                        <span class="kw">let </span>cp = s.specific_heat_capacity()<span class="question-mark">?</span>;
                        rho * cp * dx
                    }
                    Substance::Gas(_s) =&gt; <span class="number">0.0</span>, <span class="comment">// should be zero... so should have been captured earlier
                </span>}
            };

            <span class="kw">if </span>n == <span class="number">0 </span>{
                n = <span class="number">1</span>;
            }
            <span class="comment">// Now iterate all segments...
            </span><span class="kw">for _ in </span><span class="number">0</span>..n {
                <span class="kw">match </span><span class="kw-2">&amp;</span>substance {
                    Substance::Normal(s) =&gt; {
                        <span class="comment">// Add mass to this and next nodes (if it is NoMass, it is Zero)
                        </span>segments[n_segment].<span class="number">0 </span>+= mass / <span class="number">2.</span>;
                        segments[n_segment + <span class="number">1</span>].<span class="number">0 </span>+= mass / <span class="number">2.</span>;

                        <span class="comment">// Add resistance
                        </span><span class="kw">let </span>dx = material.thickness / n <span class="kw">as </span>Float;
                        <span class="kw">let </span>k = s.thermal_conductivity()<span class="question-mark">?</span>;
                        <span class="comment">// Push U-value
                        </span>segments[n_segment].<span class="number">1 </span>= UValue::Solid(k / dx);
                    }
                    Substance::Gas(s) =&gt; {
                        <span class="kw">let </span>gas = <span class="kw">match </span>s.gas() {
                            <span class="prelude-val">Ok</span>(simple_model::substance::gas::GasSpecification::Air) =&gt; {
                                <span class="kw">crate</span>::gas::AIR
                            }
                            <span class="prelude-val">Ok</span>(simple_model::substance::gas::GasSpecification::Argon) =&gt; {
                                <span class="kw">crate</span>::gas::ARGON
                            }
                            <span class="prelude-val">Ok</span>(simple_model::substance::gas::GasSpecification::Xenon) =&gt; {
                                <span class="kw">crate</span>::gas::XENON
                            }
                            <span class="prelude-val">Ok</span>(simple_model::substance::gas::GasSpecification::Krypton) =&gt; {
                                <span class="kw">crate</span>::gas::KRYPTON
                            }
                            <span class="kw">_ </span>=&gt; {
                                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(
                                    <span class="string">&quot;Substance &#39;{}&#39; does not have a standard gas.&quot;</span>,
                                    substance.name()
                                ))
                            }
                        };
                        <span class="kw">if </span>n_layer == <span class="number">0 </span>{
                            <span class="macro">dbg!</span>(<span class="string">&quot;This should be checked earlier.&quot;</span>);
                            <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(
                                <span class="string">&quot;Construction &#39;{}&#39; has a Gas as its first layer&quot;</span>,
                                construction.name
                            ));
                        }
                        <span class="kw">let </span>prev_mat_name = construction.materials.get(n_layer - <span class="number">1</span>).unwrap(); <span class="comment">// we already checked this
                                                                                              // let prev_mat = model.get_material(prev_mat_name)?;

                        </span><span class="kw">let </span>next_mat_name = <span class="kw">match </span>construction.materials.get(n_layer + <span class="number">1</span>) {
                            <span class="prelude-val">Some</span>(v) =&gt; v,
                            <span class="prelude-val">None </span>=&gt; {
                                <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(
                                    <span class="string">&quot;Construction &#39;{}&#39; has a Gas as its last layer&quot;</span>,
                                    construction.name
                                ))
                            }
                        };
                        <span class="comment">// let next_mat = model.get_material(next_mat_name)?;
                        </span><span class="kw">let </span>next_substance = model.get_material_substance(next_mat_name)<span class="question-mark">?</span>;
                        <span class="kw">let </span>prev_substance = model.get_material_substance(prev_mat_name)<span class="question-mark">?</span>;

                        <span class="kw">const </span>DEFAULT_EM: Float = <span class="number">0.84</span>;
                        <span class="kw">let </span>ein = <span class="kw">match </span><span class="kw-2">&amp;</span>next_substance{
                            Substance::Normal(s)=&gt;s.front_thermal_absorbtance_or(<span class="kw">crate</span>::model::MODULE_NAME,DEFAULT_EM),
                            Substance::Gas(<span class="kw">_</span>)=&gt;<span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;Construction &#39;{}&#39; has two gases without a solid layer between them&quot;</span>, construction.name))
                        };

                        <span class="kw">let </span>eout = <span class="kw">match </span><span class="kw-2">&amp;</span>prev_substance {
                            Substance::Normal(s)=&gt;s.back_thermal_absorbtance_or(<span class="kw">crate</span>::model::MODULE_NAME,DEFAULT_EM),
                            Substance::Gas(<span class="kw">_</span>)=&gt;<span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;Construction &#39;{}&#39; has two gases without a solid layer between them&quot;</span>, construction.name))
                        };

                        <span class="kw">let </span>c = Cavity {
                            gas,
                            thickness: material.thickness,
                            height,
                            angle,
                            eout,
                            ein,
                        };
                        segments[n_segment].<span class="number">1 </span>= UValue::Cavity(Box::new(c));
                    }
                }
                n_segment += <span class="number">1</span>;
            }
            <span class="comment">// Process last one
            </span>segments[n_nodes - <span class="number">1</span>].<span class="number">1 </span>= UValue::Back;
        }

        <span class="prelude-val">Ok</span>(<span class="self">Self </span>{
            segments,
            tstep_subdivision,
            n_elements,
        })
    }

    <span class="doccomment">/// Calculates the R value of the whole system
    ///
    /// # Panics
    /// Panics if the calculated R value is Zero (i.e., if there are no
    /// layers or something like that)
    </span><span class="kw">pub fn </span>r_value(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; Float {
        <span class="kw">let </span><span class="kw-2">mut </span>r = <span class="number">0.0</span>;

        <span class="kw">for </span>(<span class="kw">_</span>, u_value) <span class="kw">in </span><span class="kw-2">&amp;</span><span class="self">self</span>.segments {
            r += <span class="kw">match </span>u_value {
                UValue::Cavity(_c) =&gt; <span class="macro">todo!</span>(), <span class="comment">//c.u_value(t_front, t_back),
                </span>UValue::Solid(v) =&gt; <span class="number">1. </span>/ v,
                UValue::Back =&gt; <span class="number">0.0</span>,
                UValue::None =&gt; <span class="macro">unreachable!</span>(),
            }
        }

        <span class="macro">assert!</span>(r &gt; <span class="number">0.0</span>, <span class="string">&quot;Found Zero r-value&quot;</span>);
        r
    }

    <span class="doccomment">/// Given a Maximum element thickness ($`\Delta x_{max}`$) and a minimum timestep ($`\Delta t_{min}`$), this function
    /// will find an arguibly good (i.e., stable and accurate) combination of $`\Delta t`$ and number of elements in each
    /// layer of the construction.
    ///
    /// This function recursively increases the model&#39;s timestep subdivisions (`n`) in order to reduce $`\Delta t`$ to numbers
    /// that respect the restrictions of (1) stability, (2) $`\Delta x_{max}`$, and (3) $`\Delta t_{min}`$. In other words,
    /// it searches (by testing $`\Delta t_{model}/1`$, $`\Delta t_{model}/2`$, $`\Delta t_{model}/3`$, ... $`\Delta t_{model}/n`$)
    /// for the minimum `n` that respects this restrictions
    ///
    /// # The math behind it
    ///
    /// &gt; *I am not sure how correct this is... seems to work, but there is room for improvements and optimizations, surely*
    ///
    /// The first thing to know is that the walls in this module march
    /// through time using a 4th order [Runga-Kutte](https://en.wikipedia.org/wiki/Runge%E2%80%93Kutta_methods)
    /// (a.k.a., RK4). The second thing to know is that the RK4 method is
    /// more stable than the [Euler method](https://en.wikipedia.org/wiki/Euler_method),
    /// and thus the restrictions of stability for the Euler method can be considered
    /// to be a conservative restriction for the RK4. Hence, this function uses the
    /// Euler method restrictions.
    ///
    /// We are solving the following equation:
    ///
    /// ```math
    /// \dot{T} = \overline{C}^{-1} \overline{K}  T + \overline{C}^{-1} q
    /// ```
    ///
    /// And thus the stability of the numerical method will depend on the matrix:
    ///
    /// ```math
    /// \overline{K}^{\star} =\Delta t \overline{C}^{-1} \overline{K}
    /// ```
    ///
    /// Specifically, we don&#39;t want any of its [eigenvalues](https://en.wikipedia.org/wiki/Eigenvalues_and_eigenvectors)
    /// $`\xi_1, \xi_2,\xi_3, ...`$ to be outside of the Euler method&#39;s stability region. Since this
    /// matrix has only Real eigenvalues, this is equivalent to saying:
    ///
    /// ```math
    /// -2 &lt; \xi_i &lt; 0 ; \forall i
    /// ```
    ///
    /// However, finding the eigenvalues for $`\overline{K}^{\star}`$ is far from trivial. So there is
    /// yet another heuristic I am using: I am treating the case of a wall with 1 layer that is subdivided
    /// into a single element as the limit case. I am not sure if this is correct, but most of the instabilities
    /// I identified through Trial and Error corresponded to this case.
    ///
    /// For this limit case:
    /// * $`R = \frac{\Delta x}{\lambda}`$
    /// * $`C = \rho  c_p  \Delta x`$
    ///
    /// thus the value of $`\overline{K}^{\star}`$ is:
    ///
    /// ```math
    /// \overline{K}^{\star}=\begin{bmatrix}
    /// -\frac{\Delta t}{C\times R} - \frac{\Delta t}{C\times R_s} &amp; \frac{\Delta t}{C\times R} \\
    ///  \frac{\Delta t}{C\times R} &amp; -\frac{\Delta t}{C\times R} - \frac{\Delta t}{C\times R_s}\\
    /// \end{bmatrix}   
    ///```
    /// Note that, in that equation, $`R_{si} = R_{so}`$. The reason for this is that, at the point of using this method,
    /// we do not not know waht the values of $`R_{si}`$ and $`R_{so}`$ will be. TO overcome this, I use a
    /// value low enough to cover most general cases (`0.05`).
    ///
    /// Then, it can be found that the eigenvalues of this case—which we are treating as the limit case—are:
    /// ```math
    /// \xi_1 = -\frac{\Delta t} { R_s \rho c_p \Delta x }
    /// ```
    /// ```math
    /// \xi_2 = \xi_1 - 2 \frac{\Delta t \lambda}{ \rho  c_p  {\Delta x}^2}
    /// ```
    /// Both these values are always negative, so we don&#39;t need to worry about
    /// $`\xi_i &lt; 0 `$. Also, it can be noticed that $`\xi_2 &lt; \xi_1`$, meaning that
    /// what we need to comply with for Euler&#39;s stability criteria is:
    /// ```math
    /// -\frac{\Delta t} { R_s \rho c_p \Delta x } - 2 \frac{\Delta t \lambda}{ \rho  c_p  {\Delta x}^2} &gt; -1
    /// ```
    ///
    /// Which means that the chosen $`\Delta x`$ must be greater than the (I am pretty sure, only) positive
    /// solution to equation:
    ///
    /// ```math
    /// 0 = {\Delta x}^2 - \left( \frac{\Delta t}{\rho c_p R_s} \right) \Delta x - \frac{2 \Delta t \lambda}{\rho c_p}
    /// ```
    ///
    /// So, this method will identify a combination of $`\Delta t`$ and $`\Delta x`$ that
    /// allows complying with this
    ///
    /// All that said, the value for $`\Delta t`$ actually used by the final model is
    /// actually half of what these equations use. This is because what we are using
    /// is a heuristic and I want to be safe... ish
    </span><span class="kw">fn </span>discretize_construction(
        construction: <span class="kw-2">&amp;</span>Rc&lt;Construction&gt;,
        model: <span class="kw-2">&amp;</span>SimpleModel,
        model_dt: Float,
        max_dx: Float,
        min_dt: Float,
    ) -&gt; <span class="prelude-ty">Result</span>&lt;(usize, Vec&lt;usize&gt;), String&gt; {
        <span class="comment">// I could only think of how to make this recursively... so I did this.
        </span><span class="kw">fn </span>aux(
            construction: <span class="kw-2">&amp;</span>Rc&lt;Construction&gt;,
            model: <span class="kw-2">&amp;</span>SimpleModel,
            main_dt: Float,
            n: usize,
            max_dx: Float,
            min_dt: Float,
        ) -&gt; <span class="prelude-ty">Result</span>&lt;(usize, Vec&lt;usize&gt;), String&gt; {
            <span class="kw">let </span>dt = main_dt / (n <span class="kw">as </span>Float);

            <span class="comment">// So, for each layer
            </span><span class="kw">let </span>n_layers = construction.materials.len();
            <span class="kw">let </span><span class="kw-2">mut </span>n_elements: Vec&lt;usize&gt; = Vec::with_capacity(n_layers);

            <span class="kw">for </span>n_layer <span class="kw">in </span><span class="number">0</span>..n_layers {
                <span class="kw">let </span>mat_name = <span class="kw-2">&amp;</span>construction.materials[n_layer];
                <span class="kw">let </span>material = model.get_material(mat_name)<span class="question-mark">?</span>;
                <span class="kw">let </span>sub_name = <span class="kw-2">&amp;</span>material.substance;
                <span class="kw">let </span>substance = model.get_substance(sub_name)<span class="question-mark">?</span>;

                <span class="comment">// Calculate the minimum_dx
                </span><span class="kw">let </span>thickness = material.thickness;
                <span class="kw">let </span>(k, rho, cp) = <span class="kw">match </span>substance {
                    Substance::Normal(s) =&gt; {
                        <span class="kw">let </span>k = s.thermal_conductivity().map_err(|_x| <span class="string">&quot;Trying to discretize a construction that contains a Normal Substance without a &#39;thermal conductivity&#39;&quot;</span>)<span class="question-mark">?</span>;
                        <span class="kw">let </span>rho = s.density().map_err(|_x| <span class="string">&quot;Trying to discretize a construction that contains a Normal Substance without a &#39;density&#39;&quot;</span>)<span class="question-mark">?</span>;
                        <span class="kw">let </span>cp = s.specific_heat_capacity().map_err(|_x| <span class="string">&quot;Trying to discretize a construction that contains a Normal Substance without a &#39;specific heat capacity&#39;&quot;</span>)<span class="question-mark">?</span>;
                        (<span class="kw-2">*</span>k, <span class="kw-2">*</span>rho, <span class="kw-2">*</span>cp)
                    }
                    Substance::Gas(<span class="kw">_</span>) =&gt; {
                        n_elements.push(<span class="number">0</span>);
                        <span class="kw">continue</span>;
                    }
                };

                <span class="kw">let </span>a_coef = <span class="number">1.</span>;
                <span class="kw">let </span>b_coef = -dt / (rho * cp * MAX_RS);
                <span class="kw">let </span>c_coef = -<span class="number">2. </span>* dt * k / (rho * cp);
                <span class="kw">let </span>disc = b_coef * b_coef - <span class="number">4. </span>* a_coef * c_coef;
                <span class="comment">// this should never happen...?
                </span><span class="macro">debug_assert!</span>(disc &gt;= <span class="number">0.</span>);

                <span class="comment">// One solution is apparently always negative...
                // i.e. it is meaningless
                </span><span class="macro">debug_assert!</span>((-b_coef - disc.sqrt()) / (<span class="number">2. </span>* a_coef) &lt; <span class="number">0.</span>);

                <span class="comment">// The positive solution is the one we care about
                </span><span class="kw">let </span>min_dx = (-b_coef + disc.sqrt()) / (<span class="number">2. </span>* a_coef);

                <span class="kw">if </span>min_dx &gt; thickness {
                    <span class="comment">// This means that this layer cannot comply with the
                    // given timestep because its thickness leads to a dx that
                    // does not ensure convergence...
                    // check if there is room for reducing dt (hence reducing min_dx)
                    </span><span class="kw">let </span>next_dt = main_dt / ((n + <span class="number">1</span>) <span class="kw">as </span>Float);
                    <span class="kw">if </span>next_dt &gt; min_dt {
                        <span class="comment">// If there is room for that, do it.
                        </span><span class="kw">return </span>aux(construction, model, main_dt, n + <span class="number">1</span>, max_dx, min_dt);
                    } <span class="kw">else </span>{
                        <span class="comment">// otherwise, mark this layer as no-mass
                        </span>n_elements.push(<span class="number">0</span>);
                    }
                } <span class="kw">else </span>{
                    <span class="comment">// subdivide the layer, making all the elements of equal thickness
                    </span><span class="kw">let </span>m = (thickness / min_dx).floor();
                    <span class="comment">// this case belongs to the other branch of this if/else
                    </span><span class="macro">debug_assert!</span>(m <span class="kw">as </span>usize != <span class="number">0</span>);
                    <span class="kw">let </span>dx = thickness / m;
                    <span class="kw">if </span>dx &gt; max_dx {
                        <span class="comment">// If the found dx is larger than the max allowed d_x, try to change timestep
                        // check if there is room for reducing dt...
                        </span><span class="kw">let </span>next_dt = main_dt / ((n + <span class="number">1</span>) <span class="kw">as </span>Float);
                        <span class="kw">if </span>next_dt &gt; min_dt {
                            <span class="comment">// If there is room for that, do it.
                            </span><span class="kw">return </span>aux(construction, model, main_dt, n + <span class="number">1</span>, max_dx, min_dt);
                        } <span class="kw">else </span>{
                            <span class="comment">// otherwise, mark this layer as no-mass
                            </span>n_elements.push(<span class="number">0</span>);
                        }
                    } <span class="kw">else </span>{
                        <span class="comment">// &quot;dx&quot; is smaller than max_dx, and thus this works
                        // fine.
                        </span>n_elements.push(m <span class="kw">as </span>usize)
                    }
                }
            }

            <span class="comment">// Check stability requirements...
            // stability is assured by (alpha * dt / dx^2 &lt;= 1/2 )
            </span><span class="attribute">#[cfg(debug_assertions)]
            </span>{
                <span class="kw">for </span>(n_layer, <span class="kw">_</span>) <span class="kw">in </span>n_elements.iter().enumerate() {
                    <span class="kw">let </span>mat_name = <span class="kw-2">&amp;</span>construction.materials[n_layer];
                    <span class="kw">let </span>material = model.get_material(mat_name)<span class="question-mark">?</span>;
                    <span class="kw">let </span>sub_name = <span class="kw-2">&amp;</span>material.substance;
                    <span class="kw">let </span>substance = model.get_substance(sub_name)<span class="question-mark">?</span>;

                    <span class="comment">// Calculate the optimum_dx
                    </span><span class="kw">let </span>thickness = material.thickness;
                    <span class="kw">let </span>(k, rho, cp) = <span class="kw">match </span>substance {
                        Substance::Normal(s) =&gt; {
                            <span class="kw">let </span>k = s.thermal_conductivity().unwrap();
                            <span class="kw">let </span>rho = s.density().unwrap();
                            <span class="kw">let </span>cp = s.specific_heat_capacity().unwrap();
                            (<span class="kw-2">*</span>k, <span class="kw-2">*</span>rho, <span class="kw-2">*</span>cp)
                        }
                        Substance::Gas(<span class="kw">_</span>) =&gt; <span class="kw">continue</span>,
                    };
                    <span class="kw">let </span>dt = main_dt / n <span class="kw">as </span>Float;
                    <span class="kw">let </span>dx = thickness / n_elements[n_layer] <span class="kw">as </span>Float;

                    <span class="comment">// assert!(alpha * dt / dx / dx &lt;= 0.5);
                    </span><span class="kw">let </span>lambda1 = -dt / (MAX_RS * rho * cp * dx);
                    <span class="kw">let </span>r = dx / k;
                    <span class="kw">let </span>lambda2 = lambda1 - <span class="number">2. </span>* dt / (r * rho * cp * dx);
                    <span class="macro">assert!</span>(lambda1 &gt;= -<span class="number">2.</span>);
                    <span class="macro">assert!</span>(lambda1 &lt;= <span class="number">0.</span>);
                    <span class="macro">assert!</span>(lambda2 &gt;= -<span class="number">2.</span>);
                    <span class="macro">assert!</span>(lambda2 &lt;= <span class="number">0.</span>);
                }
            }

            <span class="comment">// return
            </span><span class="prelude-val">Ok</span>((n, n_elements))
        }
        aux(construction, model, model_dt, <span class="number">1</span>, max_dx, min_dt)
    }

    <span class="doccomment">/// Produces $`\overline{K}`$ and $`\vec{q}`$ (as in the equation $`\overline{C} \dot{\vec{T}} =  \overline{K} \vec{T} + \vec{q}`$),
    /// allowing to update the node temperatures in a surface. This method returns the matrix $`\overline{k}`$
    /// representing the thermal network, and the vector $`\vec{q}`$), accounting for the heat flows induced by the
    /// environment.
    ///
    /// # How it works
    ///
    /// This matrix is constructed based ona discretization of the layers of the
    /// construction; that is, each layer is subdivided into `n` elements all of equal
    /// thickness. One node is placed at the beginning and end of each elements. Each element can
    /// be represented by the 2x2 matrix
    ///
    /// ```math
    /// \overline{K}=\begin{bmatrix} -U &amp; U \\
    /// U &amp; -U
    /// \end{bmatrix}   
    ///```
    ///
    /// Then—ignoring all external inputs (i.e., a system disconnected from the environment—the K matrix
    /// for a construction subdivided into 3 elements (i.e., 4 nodes) can be written as follows:
    ///
    /// ```math
    /// \overline{K}=\begin{bmatrix}
    /// -U_{1\rightarrow2} &amp; U_{1\rightarrow2} &amp; 0 &amp; 0 \\
    /// U_{1\rightarrow2} &amp; -U_{1\rightarrow2} - U_{2\rightarrow3} &amp; U_{2\rightarrow3} &amp; 0 \\
    /// 0 &amp; U_{2\rightarrow3} &amp; -U_{2\rightarrow3} - U_{3\rightarrow4} &amp; U_{3\rightarrow4} \\
    /// 0 &amp; 0 &amp; U_{3\rightarrow4} &amp; -U_{3\rightarrow4} \\
    /// \end{bmatrix}   
    /// ```
    ///
    /// Now, these nodes are also connected to a front and back border conditions.
    /// This means that the Matrix $`\overline{K}`$ needs to become:
    ///
    /// ```math
    /// \overline{K}=\begin{bmatrix}
    /// -U_{1\rightarrow2} - h_{so} &amp; U_{1\rightarrow2} &amp; 0 &amp; 0 \\
    /// U_{1\rightarrow2} &amp; -U_{1\rightarrow2} - U_{2\rightarrow3} &amp; U_{2\rightarrow3} &amp; 0 \\
    /// 0 &amp; U_{2\rightarrow3} &amp; -U_{2\rightarrow3} - U_{3\rightarrow4} &amp; U_{3\rightarrow4} \\
    /// 0 &amp; 0 &amp; U_{3\rightarrow4} &amp; -U_{3\rightarrow4}- h_{si} \\
    /// \end{bmatrix}   
    /// ```
    ///
    /// Additionally, the vector $`\vec{q}`$ will have to account for the border conditions. How this is done depends
    /// on the border condition. If the border leads to a zone, a value of $`  T_{env} h_s + E_{ir}\epsilon_s - \epsilon_s \sigma {T_s}^4`$
    /// should be added to $`\vec{q}`$.  Note that $`T_{env}`$ is the temparture of the air in the environment,
    /// $`h_s`$ is the convection coefficient, $`E_{ir}`$ is the incident infrared radiation and $`\epsilon_s`$ is the
    /// emissivity of the surface. On the contrary, if the border condition is a cavity, then a value of $`T_{pane} U_{cavity}`$
    /// should be added. $`T_{pane}`$ is the temperature of the surface before or after.
    ///         
    </span><span class="attribute">#[allow(clippy::too_many_arguments)]
    </span><span class="kw">pub</span>(<span class="kw">crate</span>) <span class="kw">fn </span>get_k_q(
        <span class="kw-2">&amp;</span><span class="self">self</span>,
        ini: usize,
        fin: usize,
        temperatures: <span class="kw-2">&amp;</span>Matrix,
        front_env: <span class="kw-2">&amp;</span>ConvectionParams,
        front_hs: Float,
        front_rad_hs: Float,
        back_env: <span class="kw-2">&amp;</span>ConvectionParams,
        back_hs: Float,
        back_rad_hs: Float,
    ) -&gt; (Matrix, Matrix) {
        <span class="kw">let </span>(nrows, ncols) = temperatures.size();
        <span class="macro">assert_eq!</span>(
            ncols, <span class="number">1</span>,
            <span class="string">&quot;Expecting `temperatures` to be a Column matrix... but found {} columns&quot;</span>,
            ncols
        );
        <span class="macro">assert_eq!</span>(
            nrows,
            <span class="self">self</span>.segments.len(),
            <span class="string">&quot;Expecting `temperatures` to have {} elements... found {}&quot;</span>,
            <span class="self">self</span>.segments.len(),
            nrows
        );
        <span class="kw">let </span>nnodes = fin - ini;

        <span class="kw">let </span><span class="kw-2">mut </span>k = Matrix::new(<span class="number">0.0</span>, nnodes, nnodes);
        <span class="kw">let </span><span class="kw-2">mut </span>q = Matrix::new(<span class="number">0.0</span>, nnodes, <span class="number">1</span>);

        <span class="comment">// this is just quite helpful
        </span><span class="kw">let </span>get_t_after = |i: usize| -&gt; Float {
            <span class="kw">match </span>temperatures.get(i + <span class="number">1</span>, <span class="number">0</span>) {
                <span class="prelude-val">Ok</span>(v) =&gt; v,
                <span class="prelude-val">Err</span>(<span class="kw">_</span>) =&gt; back_env.air_temperature,
            }
        };

        <span class="kw">for </span>local_i <span class="kw">in </span><span class="number">0</span>..nnodes - <span class="number">1 </span>{
            <span class="kw">let </span>global_i = ini + local_i;
            <span class="kw">let </span>t_this = temperatures.get(global_i, <span class="number">0</span>).unwrap();
            <span class="kw">let </span>t_next = get_t_after(global_i);
            <span class="kw">let </span>(.., uvalue) = <span class="kw-2">&amp;</span><span class="self">self</span>.segments[global_i];
            <span class="kw">let </span>u = uvalue.u_value(t_this, t_next);

            <span class="comment">// Top left... should be there
            </span>k.add_to_element(local_i, local_i, -u).unwrap();
            <span class="comment">// Bottom right, only if within range.
            </span><span class="kw">if let </span><span class="prelude-val">Ok</span>(old_value) = k.get(local_i + <span class="number">1</span>, local_i + <span class="number">1</span>) {
                k.set(local_i + <span class="number">1</span>, local_i + <span class="number">1</span>, old_value - u).unwrap();
            }
            <span class="comment">// Top right, only if within range.
            </span><span class="kw">if let </span><span class="prelude-val">Ok</span>(old_value) = k.get(local_i, local_i + <span class="number">1</span>) {
                k.set(local_i, local_i + <span class="number">1</span>, old_value + u).unwrap();
            }
            <span class="comment">// Bottom left, only if within range.
            </span><span class="kw">if let </span><span class="prelude-val">Ok</span>(old_value) = k.get(local_i + <span class="number">1</span>, local_i) {
                k.set(local_i + <span class="number">1</span>, local_i, old_value + u).unwrap();
            }
        }

        <span class="comment">// Add front border conditions
        </span><span class="kw">let </span>(hs_front, front_q) = <span class="kw">if </span>ini == <span class="number">0 </span>{
            <span class="kw">let </span>ts = temperatures.get(<span class="number">0</span>, <span class="number">0</span>).unwrap();
            <span class="comment">// Solar radiation is added later because it also depends
            // on the solar absorption of different layers.

            </span><span class="kw">let </span>front_q = front_env.air_temperature * front_hs  <span class="comment">// convection
                </span>+ front_rad_hs * (front_env.rad_temperature - ts);

            (front_hs, front_q)
        } <span class="kw">else </span>{
            <span class="kw">let </span>(.., uvalue) = <span class="kw-2">&amp;</span><span class="self">self</span>.segments[ini - <span class="number">1</span>];
            <span class="kw">let </span>t_before = temperatures.get(ini - <span class="number">1</span>, <span class="number">0</span>).unwrap(); <span class="comment">// this should NEVER fail
            </span><span class="kw">let </span>t_after = temperatures.get(ini, <span class="number">0</span>).unwrap(); <span class="comment">// this should NEVER fail
            </span><span class="kw">let </span>u = uvalue.u_value(t_before, t_after);

            (u, u * t_before)
        };

        q.add_to_element(<span class="number">0</span>, <span class="number">0</span>, front_q).unwrap();
        k.add_to_element(<span class="number">0</span>, <span class="number">0</span>, -hs_front).unwrap();

        <span class="comment">// Add back border conditions
        </span><span class="kw">let </span>(hs_back, back_q) = <span class="kw">if </span>fin == nrows {
            <span class="kw">let </span>ts = temperatures.get(fin - <span class="number">1</span>, <span class="number">0</span>).unwrap();
            <span class="comment">// Solar radiation is added later because it also depends
            // on the solar absorption of different layers.
            </span><span class="kw">let </span>back_q = back_env.air_temperature * back_hs  <span class="comment">// convection
                </span>+ back_rad_hs * (back_env.rad_temperature - ts);

            (back_hs, back_q)
        } <span class="kw">else </span>{
            <span class="kw">let </span>(.., uvalue) = <span class="kw-2">&amp;</span><span class="self">self</span>.segments[fin - <span class="number">1</span>];
            <span class="kw">let </span>t_before = temperatures.get(fin - <span class="number">1</span>, <span class="number">0</span>).unwrap(); <span class="comment">// this should NEVER fail
            </span><span class="kw">let </span>t_after = get_t_after(fin - <span class="number">1</span>);
            <span class="kw">let </span>u = uvalue.u_value(t_before, t_after);

            (u, u * t_after)
        };
        q.add_to_element(nnodes - <span class="number">1</span>, <span class="number">0</span>, back_q).unwrap();
        k.add_to_element(nnodes - <span class="number">1</span>, nnodes - <span class="number">1</span>, -hs_back).unwrap();

        (k, q)
    }
}

<span class="comment">/***********/
/* TESTING */
/***********/

</span><span class="attribute">#[cfg(test)]
</span><span class="kw">mod </span>testing {
    <span class="kw">use super</span>::<span class="kw-2">*</span>;

    <span class="kw">impl </span>std::default::Default <span class="kw">for </span>ConvectionParams {
        <span class="kw">fn </span>default() -&gt; <span class="self">Self </span>{
            <span class="comment">// const DEFAULT_ENV_EMISSIVITY: Float = 1.;
            </span><span class="kw">const </span>DEFAULT_AIR_TEMP: Float = <span class="number">22.</span>;
            ConvectionParams {
                air_temperature: DEFAULT_AIR_TEMP,
                surface_temperature: DEFAULT_AIR_TEMP,
                air_speed: <span class="number">0.</span>,
                rad_temperature: DEFAULT_AIR_TEMP,
                roughness_index: <span class="number">1</span>,
                cos_surface_tilt: <span class="number">0.0</span>,
            }
        }
    }

    <span class="doccomment">/// Creates a Construction with a single layer of Material, of a certain Substance.
    /// Returns a model containing them and also an Rc to the construction
    </span><span class="kw">fn </span>get_normal(
        thermal_cond: Float,
        density: Float,
        cp: Float,
        thickness: Float,
    ) -&gt; (SimpleModel, Rc&lt;Construction&gt;) {
        <span class="kw">let </span><span class="kw-2">mut </span>model = SimpleModel::default();

        <span class="kw">let </span><span class="kw-2">mut </span>s = simple_model::substance::Normal::new(<span class="string">&quot;the substance&quot;</span>);
        s.set_thermal_conductivity(thermal_cond)
            .set_density(density)
            .set_specific_heat_capacity(cp);
        <span class="kw">let </span>s = s.wrap();
        <span class="kw">let </span>s = model.add_substance(s);

        <span class="kw">let </span>material = simple_model::Material::new(
            <span class="string">&quot;the mat&quot;</span>.to_string(), <span class="comment">// mat name
            </span>s.name().clone(),      <span class="comment">// substance name
            </span>thickness,             <span class="comment">// thickness
        </span>);
        <span class="kw">let </span>material = model.add_material(material);

        <span class="kw">let </span><span class="kw-2">mut </span>construction = Construction::new(<span class="string">&quot;the construction&quot;</span>);
        construction.materials.push(material.name().clone());
        <span class="kw">let </span>construction = model.add_construction(construction);
        (model, construction)
    }

    <span class="attribute">#[test]
    </span><span class="kw">fn </span>build_normal_mass() {
        <span class="kw">let </span>thermal_cond = <span class="number">1.</span>;
        <span class="kw">let </span>density = <span class="number">2.1</span>;
        <span class="kw">let </span>cp = <span class="number">1.312</span>;
        <span class="kw">let </span>thickness = <span class="number">12.5 </span>/ <span class="number">1000.</span>;
        <span class="kw">let </span>tstep_sub = <span class="number">10</span>;

        <span class="kw">let </span>(model, construction) = get_normal(thermal_cond, density, cp, thickness);
        <span class="kw">let </span>d = Discretization::build(<span class="kw-2">&amp;</span>construction, <span class="kw-2">&amp;</span>model, tstep_sub, <span class="macro">vec!</span>[<span class="number">1</span>], <span class="number">1.</span>, <span class="number">0.</span>).unwrap();
        <span class="comment">// normal --&gt; linear

        </span><span class="macro">assert_eq!</span>(d.tstep_subdivision, tstep_sub);
        <span class="macro">assert_eq!</span>(d.segments.len(), <span class="number">2</span>);

        <span class="comment">// mass of node 0
        </span><span class="kw">let </span>exp_mass = thickness * density * cp / <span class="number">2.</span>;
        <span class="kw">let </span>mass = d.segments[<span class="number">0</span>].<span class="number">0</span>;
        <span class="macro">assert!</span>(
            (exp_mass - mass).abs() &lt; <span class="number">1e-17</span>,
            <span class="string">&quot;Expecting mass to be {exp_mass}... found {mass}&quot;
        </span>);
        <span class="kw">if let </span>UValue::Solid(u) = d.segments[<span class="number">0</span>].<span class="number">1 </span>{
            <span class="macro">assert!</span>((u - thermal_cond / thickness).abs() &lt; <span class="number">1e-16</span>)
        } <span class="kw">else </span>{
            <span class="macro">panic!</span>(<span class="string">&quot;Expecting Solid!&quot;</span>)
        }

        <span class="kw">let </span>mass = d.segments[<span class="number">1</span>].<span class="number">0</span>;
        <span class="macro">assert!</span>(
            (exp_mass - mass).abs() &lt; <span class="number">1e-17</span>,
            <span class="string">&quot;Expecting mass to be {exp_mass}... found {mass}&quot;
        </span>);
        <span class="macro">assert!</span>(<span class="macro">matches!</span>(d.segments[<span class="number">1</span>].<span class="number">1</span>, UValue::Back));
    }

    <span class="attribute">#[test]
    </span><span class="kw">fn </span>test_build_normal_no_mass() {
        <span class="kw">let </span>thermal_cond = <span class="number">1.</span>;
        <span class="kw">let </span>density = <span class="number">2.1</span>;
        <span class="kw">let </span>cp = <span class="number">1.312</span>;
        <span class="kw">let </span>thickness = <span class="number">12.5 </span>/ <span class="number">1000.</span>;
        <span class="kw">let </span>tstep_sub = <span class="number">10</span>;

        <span class="kw">let </span>(model, construction) = get_normal(thermal_cond, density, cp, thickness);

        <span class="kw">let </span>d = Discretization::build(<span class="kw-2">&amp;</span>construction, <span class="kw-2">&amp;</span>model, tstep_sub, <span class="macro">vec!</span>[<span class="number">0</span>], <span class="number">1.</span>, <span class="number">0.</span>).unwrap();

        <span class="comment">// normal --&gt; linear
        </span><span class="macro">assert_eq!</span>(d.tstep_subdivision, tstep_sub);
        <span class="macro">assert_eq!</span>(d.segments.len(), <span class="number">2</span>);
        <span class="comment">// mass of node 0
        </span><span class="kw">let </span>exp_mass = <span class="number">0.0</span>;
        <span class="kw">let </span>mass = d.segments[<span class="number">0</span>].<span class="number">0</span>;
        <span class="macro">assert!</span>(
            (exp_mass - mass).abs() &lt; <span class="number">1e-17</span>,
            <span class="string">&quot;Expecting mass to be {exp_mass}... found {mass}&quot;
        </span>);
        <span class="kw">if let </span>UValue::Solid(u) = d.segments[<span class="number">0</span>].<span class="number">1 </span>{
            <span class="macro">assert!</span>((u - thermal_cond / thickness).abs() &lt; <span class="number">1e-16</span>)
        } <span class="kw">else </span>{
            <span class="macro">panic!</span>(<span class="string">&quot;Expecting Solid!&quot;</span>)
        }

        <span class="kw">let </span>mass = d.segments[<span class="number">1</span>].<span class="number">0</span>;
        <span class="macro">assert!</span>(
            (exp_mass - mass).abs() &lt; <span class="number">1e-17</span>,
            <span class="string">&quot;Expecting mass to be {exp_mass}... found {mass}&quot;
        </span>);
        <span class="kw">if let </span>UValue::Back = d.segments[<span class="number">1</span>].<span class="number">1 </span>{
            <span class="macro">assert!</span>(<span class="bool-val">true</span>)
        } <span class="kw">else </span>{
            <span class="macro">panic!</span>(<span class="string">&quot;Expecting Back!&quot;</span>)
        }
    }

    <span class="attribute">#[test]
    </span><span class="kw">fn </span>build_normal_gas_normal_mass() {
        <span class="kw">let </span>thermal_cond = <span class="number">1.</span>;
        <span class="kw">let </span>density = <span class="number">2.1</span>;
        <span class="kw">let </span>cp = <span class="number">1.312</span>;
        <span class="kw">let </span>thickness = <span class="number">12.5 </span>/ <span class="number">1000.</span>;
        <span class="kw">let </span><span class="kw-2">mut </span>model = SimpleModel::default();

        <span class="kw">let </span>tstep_sub = <span class="number">10</span>;

        <span class="comment">// Create normal substance
        ///////////////////////////
        </span><span class="kw">let </span><span class="kw-2">mut </span>substance = simple_model::substance::Normal::new(<span class="string">&quot;the substance&quot;</span>);
        substance
            .set_thermal_conductivity(thermal_cond)
            .set_density(density)
            .set_front_thermal_absorbtance(<span class="number">0.9</span>)
            .set_back_thermal_absorbtance(<span class="number">0.8</span>)
            .set_specific_heat_capacity(cp);
        <span class="kw">let </span>substance = substance.wrap();
        <span class="kw">let </span>substance = model.add_substance(substance); <span class="comment">// push to model

        // Create normal Material
        ///////////////////////////
        </span><span class="kw">let </span>normal =
            simple_model::Material::new(<span class="string">&quot;the mat&quot;</span>.to_string(), substance.name().clone(), thickness);
        <span class="kw">let </span>normal = model.add_material(normal);

        <span class="comment">// Create Gas substance
        ///////////////////////////
        </span><span class="kw">let </span><span class="kw-2">mut </span>gas = simple_model::substance::Gas::new(<span class="string">&quot;the gas&quot;</span>);
        gas.set_gas(simple_model::substance::gas::GasSpecification::Air);
        <span class="kw">let </span>gas = gas.wrap();
        <span class="kw">let </span>gas = model.add_substance(gas);

        <span class="comment">// Create Gas Material
        ///////////////////////////
        </span><span class="kw">let </span>gas = simple_model::Material::new(
            <span class="string">&quot;the_gas&quot;</span>.to_string(), <span class="comment">// name of gas
            </span>gas.name().clone(),    <span class="comment">// name of substance
            </span>thickness,
        );
        <span class="kw">let </span>gas = model.add_material(gas);

        <span class="comment">// Assemble construction
        ///////////////////////////
        </span><span class="kw">let </span><span class="kw-2">mut </span>construction = simple_model::Construction::new(<span class="string">&quot;the construction&quot;</span>);
        construction.materials.push(normal.name().clone());
        construction.materials.push(gas.name().clone());
        construction.materials.push(normal.name().clone());
        <span class="kw">let </span>construction = model.add_construction(construction);

        <span class="comment">// Test
        ///////////////////////////
        </span><span class="kw">let </span>d =
            Discretization::build(<span class="kw-2">&amp;</span>construction, <span class="kw-2">&amp;</span>model, tstep_sub, <span class="macro">vec!</span>[<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>], <span class="number">1.</span>, <span class="number">0.</span>).unwrap();

        <span class="comment">// has gas --&gt; linear
        </span><span class="macro">assert_eq!</span>(d.tstep_subdivision, tstep_sub);
        <span class="macro">assert_eq!</span>(d.segments.len(), <span class="number">4</span>); <span class="comment">// normal, gas, normal, back

        // node 0
        </span><span class="kw">let </span>exp_mass = thickness * density * cp / <span class="number">2.</span>;
        <span class="kw">let </span>mass = d.segments[<span class="number">0</span>].<span class="number">0</span>;
        <span class="macro">assert!</span>(
            (exp_mass - mass).abs() &lt; <span class="number">1e-17</span>,
            <span class="string">&quot;Expecting mass to be {exp_mass}... found {mass}&quot;
        </span>);
        <span class="kw">if let </span>UValue::Solid(u) = d.segments[<span class="number">0</span>].<span class="number">1 </span>{
            <span class="macro">assert!</span>((u - thermal_cond / thickness).abs() &lt; <span class="number">1e-16</span>)
        } <span class="kw">else </span>{
            <span class="macro">panic!</span>(<span class="string">&quot;Expecting Solid!&quot;</span>)
        }

        <span class="comment">// node 1
        </span><span class="kw">let </span>mass = d.segments[<span class="number">1</span>].<span class="number">0</span>;
        <span class="macro">assert!</span>(
            (exp_mass - mass).abs() &lt; <span class="number">1e-17</span>,
            <span class="string">&quot;Expecting mass to be {exp_mass}... found {mass}&quot;
        </span>);
        <span class="kw">if let </span>UValue::Cavity(c) = <span class="kw-2">&amp;</span>d.segments[<span class="number">1</span>].<span class="number">1 </span>{
            <span class="kw">let </span>u = c.u_value(<span class="number">10.</span>, <span class="number">10.</span>);
            <span class="macro">dbg!</span>(u);
        } <span class="kw">else </span>{
            <span class="macro">panic!</span>(<span class="string">&quot;Expecting a Cavity!&quot;</span>)
        }

        <span class="comment">// node 2
        </span><span class="kw">let </span>mass = d.segments[<span class="number">2</span>].<span class="number">0</span>;
        <span class="macro">assert!</span>(
            (exp_mass - mass).abs() &lt; <span class="number">1e-17</span>,
            <span class="string">&quot;Expecting mass to be {exp_mass}... found {mass}&quot;
        </span>);
        <span class="kw">if let </span>UValue::Solid(u) = d.segments[<span class="number">2</span>].<span class="number">1 </span>{
            <span class="macro">assert!</span>((u - thermal_cond / thickness).abs() &lt; <span class="number">1e-16</span>)
        } <span class="kw">else </span>{
            <span class="macro">panic!</span>(<span class="string">&quot;Expecting Solid!&quot;</span>)
        }

        <span class="comment">// node 3
        </span><span class="kw">let </span>mass = d.segments[<span class="number">3</span>].<span class="number">0</span>;
        <span class="macro">assert!</span>(
            (exp_mass - mass).abs() &lt; <span class="number">1e-17</span>,
            <span class="string">&quot;Expecting mass to be {exp_mass}... found {mass}&quot;
        </span>);
        <span class="kw">if let </span>UValue::Back = d.segments[<span class="number">3</span>].<span class="number">1 </span>{
            <span class="macro">assert!</span>(<span class="bool-val">true</span>)
        } <span class="kw">else </span>{
            <span class="macro">panic!</span>(<span class="string">&quot;Expecting Solid!&quot;</span>)
        }
    }

    <span class="attribute">#[test]
    </span><span class="kw">fn </span>build_normal_gas_normal_no_mass() {
        <span class="kw">let </span>thermal_cond = <span class="number">1.</span>;
        <span class="kw">let </span>density = <span class="number">2.1</span>;
        <span class="kw">let </span>cp = <span class="number">1.312</span>;
        <span class="kw">let </span>thickness = <span class="number">12.5 </span>/ <span class="number">1000.</span>;

        <span class="kw">let </span><span class="kw-2">mut </span>model = SimpleModel::default();

        <span class="kw">let </span>tstep_sub = <span class="number">10</span>;

        <span class="comment">// Create normal Substance
        ///////////////////////////
        </span><span class="kw">let </span><span class="kw-2">mut </span>normal = simple_model::substance::Normal::new(<span class="string">&quot;the substance&quot;</span>);
        normal
            .set_thermal_conductivity(thermal_cond)
            .set_density(density)
            .set_specific_heat_capacity(cp);
        <span class="kw">let </span>normal = normal.wrap();
        <span class="kw">let </span>normal = model.add_substance(normal); <span class="comment">// push to model

        // Create normal Material
        ///////////////////////////
        </span><span class="kw">let </span>normal = simple_model::Material::new(
            <span class="string">&quot;the mat&quot;</span>.to_string(), <span class="comment">// name of material
            </span>normal.name().clone(), <span class="comment">// name of substance
            </span>thickness,
        );
        <span class="kw">let </span>normal = model.add_material(normal); <span class="comment">// push to model

        // Create gas substance
        ///////////////////////////
        </span><span class="kw">let </span><span class="kw-2">mut </span>gas = simple_model::substance::Gas::new(<span class="string">&quot;the gas&quot;</span>);
        gas.set_gas(simple_model::substance::gas::GasSpecification::Air);
        <span class="kw">let </span>gas = gas.wrap();
        <span class="kw">let </span>gas = model.add_substance(gas); <span class="comment">// push to model

        // Create gas Material
        ///////////////////////////
        </span><span class="kw">let </span>gas = simple_model::Material::new(<span class="string">&quot;the_gas&quot;</span>.to_string(), gas.name().clone(), thickness);
        <span class="kw">let </span>gas = model.add_material(gas); <span class="comment">// push to model

        // Assemble Construction
        ///////////////////////////
        </span><span class="kw">let </span><span class="kw-2">mut </span>construction = simple_model::Construction::new(<span class="string">&quot;the construction&quot;</span>);
        construction.materials.push(normal.name().clone());
        construction.materials.push(gas.name().clone());
        construction.materials.push(normal.name().clone());
        <span class="kw">let </span>construction = model.add_construction(construction); <span class="comment">// push to model

        // Test
        ///////////////////////////
        </span><span class="kw">let </span>d =
            Discretization::build(<span class="kw-2">&amp;</span>construction, <span class="kw-2">&amp;</span>model, tstep_sub, <span class="macro">vec!</span>[<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>], <span class="number">1.</span>, <span class="number">0.</span>).unwrap();

        <span class="comment">// has gas --&gt; linear
        </span><span class="macro">assert_eq!</span>(d.tstep_subdivision, tstep_sub);
        <span class="macro">assert_eq!</span>(d.segments.len(), <span class="number">4</span>); <span class="comment">// normal, gas, normal, back

        // node 0
        </span><span class="kw">let </span>exp_mass = <span class="number">0.0</span>;
        <span class="kw">let </span>mass = d.segments[<span class="number">0</span>].<span class="number">0</span>;
        <span class="macro">assert!</span>(
            (exp_mass - mass).abs() &lt; <span class="number">1e-17</span>,
            <span class="string">&quot;Expecting mass to be {exp_mass}... found {mass}&quot;
        </span>);
        <span class="kw">if let </span>UValue::Solid(u) = d.segments[<span class="number">0</span>].<span class="number">1 </span>{
            <span class="macro">assert!</span>((u - thermal_cond / thickness).abs() &lt; <span class="number">1e-16</span>)
        } <span class="kw">else </span>{
            <span class="macro">panic!</span>(<span class="string">&quot;Expecting Solid!&quot;</span>)
        }

        <span class="comment">// node 1
        </span><span class="kw">let </span>mass = d.segments[<span class="number">1</span>].<span class="number">0</span>;
        <span class="macro">assert!</span>(
            (exp_mass - mass).abs() &lt; <span class="number">1e-17</span>,
            <span class="string">&quot;Expecting mass to be {exp_mass}... found {mass}&quot;
        </span>);
        <span class="kw">if let </span>UValue::Cavity(c) = <span class="kw-2">&amp;</span>d.segments[<span class="number">1</span>].<span class="number">1 </span>{
            <span class="comment">// assert!( (r - thickness/thermal_cond).abs() &lt; 1e-16 )
            </span><span class="kw">let </span>u = c.u_value(<span class="number">10.</span>, <span class="number">20.</span>);
            <span class="macro">dbg!</span>(u);
        } <span class="kw">else </span>{
            <span class="macro">panic!</span>(<span class="string">&quot;Expecting Solid!&quot;</span>)
        }

        <span class="comment">// node 2
        </span><span class="kw">let </span>mass = d.segments[<span class="number">2</span>].<span class="number">0</span>;
        <span class="macro">assert!</span>(
            (exp_mass - mass).abs() &lt; <span class="number">1e-17</span>,
            <span class="string">&quot;Expecting mass to be {exp_mass}... found {mass}&quot;
        </span>);
        <span class="kw">if let </span>UValue::Solid(u) = d.segments[<span class="number">2</span>].<span class="number">1 </span>{
            <span class="macro">assert!</span>(
                (u - thermal_cond / thickness).abs() &lt; <span class="number">1e-16</span>,
                <span class="string">&quot;u = {} | exp = {}&quot;</span>,
                u,
                thermal_cond / thickness
            )
        } <span class="kw">else </span>{
            <span class="macro">panic!</span>(<span class="string">&quot;Expecting Solid!&quot;</span>)
        }

        <span class="comment">// node 3
        </span><span class="kw">let </span>mass = d.segments[<span class="number">3</span>].<span class="number">0</span>;
        <span class="macro">assert!</span>(
            (exp_mass - mass).abs() &lt; <span class="number">1e-17</span>,
            <span class="string">&quot;Expecting mass to be {exp_mass}... found {mass}&quot;
        </span>);
        <span class="kw">if let </span>UValue::Back = d.segments[<span class="number">3</span>].<span class="number">1 </span>{
            <span class="macro">assert!</span>(<span class="bool-val">true</span>)
        } <span class="kw">else </span>{
            <span class="macro">panic!</span>(<span class="string">&quot;Expecting Solid!&quot;</span>)
        }
    }

    <span class="kw">fn </span>get_solid_test_system(
        thickness: Float,
        thermal_cond: Float,
    ) -&gt; (
        Discretization,
        Matrix,
        ConvectionParams,
        <span class="comment">// Float,
        </span>Float,
        ConvectionParams,
        <span class="comment">// Float,
        </span>Float,
    ) {
        <span class="kw">let </span>n = <span class="number">5</span>;
        <span class="kw">let </span>dx = thickness / n <span class="kw">as </span>Float;
        <span class="kw">let </span>u = thermal_cond / dx;

        <span class="kw">let </span><span class="kw-2">mut </span>segments = Vec::with_capacity(n + <span class="number">1</span>);
        <span class="kw">for </span>mass <span class="kw">in </span><span class="number">0</span>..n {
            segments.push((mass <span class="kw">as </span>Float, UValue::Solid(u)));
        }
        segments.push((n <span class="kw">as </span>Float, UValue::Back));
        <span class="macro">assert_eq!</span>(segments.len(), n + <span class="number">1</span>);

        <span class="kw">let </span>d = Discretization {
            segments,
            tstep_subdivision: <span class="number">1</span>,
            n_elements: <span class="macro">vec!</span>[n],
        };

        <span class="kw">let </span>front_env = ConvectionParams {
            air_temperature: <span class="number">0.</span>,
            air_speed: <span class="number">0.</span>,
            rad_temperature: <span class="number">0.0</span>,
            ..ConvectionParams::default()
        };

        <span class="kw">let </span>back_env = ConvectionParams {
            air_temperature: <span class="number">7.</span>,
            air_speed: <span class="number">0.</span>,
            rad_temperature: <span class="number">5.</span>,
            ..ConvectionParams::default()
        };

        <span class="kw">let </span>temperatures = Matrix::from_data(n + <span class="number">1</span>, <span class="number">1</span>, <span class="macro">vec!</span>[<span class="number">1.</span>, <span class="number">2.</span>, <span class="number">3.</span>, <span class="number">4.</span>, <span class="number">5.</span>, <span class="number">6.</span>]);
        <span class="kw">let </span>front_hs = front_env.get_tarp_natural_convection_coefficient();
        <span class="kw">let </span>back_hs = back_env.get_tarp_convection_coefficient(<span class="number">1.</span>, <span class="number">4.</span>, <span class="bool-val">false</span>);

        <span class="kw">return </span>(d, temperatures, front_env, front_hs, back_env, back_hs);
    }

    <span class="attribute">#[test]
    </span><span class="kw">fn </span>test_get_q_k_solid() {
        <span class="kw">let </span>n = <span class="number">5</span>;
        <span class="kw">let </span>thickness = <span class="number">0.5</span>;
        <span class="kw">let </span>thermal_cond = <span class="number">2.12</span>;

        <span class="kw">let </span>dx = thickness / n <span class="kw">as </span>Float;
        <span class="kw">let </span>u = thermal_cond / dx;
        <span class="kw">let </span>(d, temperatures, front_env, front_hs, back_env, back_hs) =
            get_solid_test_system(thickness, thermal_cond);

        <span class="kw">let </span>front_rad_hs = <span class="number">1.0</span>;
        <span class="kw">let </span>back_rad_hs = <span class="number">1.0</span>;
        <span class="kw">let </span>(k, q) = d.get_k_q(
            <span class="number">0</span>,
            n + <span class="number">1</span>,
            <span class="kw-2">&amp;</span>temperatures,
            <span class="kw-2">&amp;</span>front_env,
            front_hs,
            front_rad_hs,
            <span class="kw-2">&amp;</span>back_env,
            back_hs,
            back_rad_hs,
        );
        <span class="macro">println!</span>(<span class="string">&quot;k = {}&quot;</span>, k);
        <span class="macro">println!</span>(<span class="string">&quot;heat_flows = {}&quot;</span>, q);

        <span class="kw">for </span>r <span class="kw">in </span><span class="number">0</span>..n + <span class="number">1 </span>{
            <span class="comment">// Check q
            </span><span class="kw">let </span>heat_flow = q.get(r, <span class="number">0</span>).unwrap();
            <span class="kw">if </span>r == <span class="number">0 </span>{
                <span class="comment">// exterior temp is lower, so heat flow is negative
                </span><span class="macro">assert!</span>(heat_flow &lt; -<span class="number">1e-5</span>);
            } <span class="kw">else if </span>r == n {
                <span class="macro">assert!</span>(heat_flow &gt; <span class="number">1e-5</span>);
            } <span class="kw">else </span>{
                <span class="comment">// it is Zero
                </span><span class="macro">assert!</span>(heat_flow.abs() &lt; <span class="number">1e-29</span>);
            }

            <span class="kw">for </span>c <span class="kw">in </span><span class="number">0</span>..n + <span class="number">1 </span>{
                <span class="kw">let </span>v = k.get(r, c).unwrap();

                <span class="kw">if </span>c == r {
                    <span class="comment">// Diagonal
                    </span><span class="kw">if </span>c == <span class="number">0 </span>{
                        <span class="comment">// Exterior node...
                        </span><span class="macro">assert!</span>((v - (-front_hs - u)).abs() &lt; <span class="number">1e-20</span>);
                    } <span class="kw">else if </span>c == n {
                        <span class="comment">// interior node
                        </span><span class="macro">assert!</span>((v - (-back_hs - u)).abs() &lt; <span class="number">1e-20</span>);
                    } <span class="kw">else </span>{
                        <span class="comment">// Any other node.
                        </span><span class="macro">assert!</span>((v - (-<span class="number">2. </span>* u)).abs() &lt; <span class="number">1e-20</span>);
                    }
                } <span class="kw">else </span>{
                    <span class="comment">// Not diagonal
                    </span><span class="kw">let </span>r = r <span class="kw">as </span>i32;
                    <span class="kw">let </span>c = c <span class="kw">as </span>i32;
                    <span class="kw">if </span>(c - r).abs() &lt;= <span class="number">1 </span>{
                        <span class="comment">// if it is within tri-diagonal
                        </span><span class="macro">assert!</span>((v - u).abs() &lt; <span class="number">1e-20</span>);
                    } <span class="kw">else </span>{
                        <span class="comment">// if not
                        </span><span class="macro">assert!</span>(v.abs() &lt; <span class="number">1e-29</span>);
                    }
                }
            }
        }
    }

    <span class="attribute">#[test]
    </span><span class="kw">fn </span>test_get_q_k_solid_partial() {
        <span class="kw">let </span>n = <span class="number">5</span>;
        <span class="kw">let </span>thickness = <span class="number">0.5</span>;
        <span class="kw">let </span>thermal_cond = <span class="number">2.12</span>;

        <span class="kw">let </span>dx = thickness / n <span class="kw">as </span>Float;
        <span class="kw">let </span>u = thermal_cond / dx;
        <span class="kw">let </span>(d, temperatures, front_env, front_hs, back_env, back_hs) =
            get_solid_test_system(thickness, thermal_cond);

        <span class="kw">let </span>front_rad_hs = <span class="number">1.0</span>;
        <span class="kw">let </span>back_rad_hs = <span class="number">1.0</span>;

        <span class="kw">let </span>(k, q) = d.get_k_q(
            <span class="number">0</span>,
            <span class="number">3</span>,
            <span class="kw-2">&amp;</span>temperatures,
            <span class="kw-2">&amp;</span>front_env,
            front_hs,
            front_rad_hs,
            <span class="kw-2">&amp;</span>back_env,
            back_hs,
            back_rad_hs,
        );
        <span class="macro">println!</span>(<span class="string">&quot;k = {}&quot;</span>, k);
        <span class="macro">println!</span>(<span class="string">&quot;heat_flows = {}&quot;</span>, q);

        <span class="kw">for </span>r <span class="kw">in </span><span class="number">0</span>..<span class="number">3 </span>{
            <span class="comment">// Check q
            </span><span class="kw">let </span>heat_flow = q.get(r, <span class="number">0</span>).unwrap();
            <span class="kw">if </span>r == <span class="number">0 </span>{
                <span class="comment">// exterior temp is lower, so heat flow is negative
                </span><span class="macro">assert!</span>(heat_flow &lt; -<span class="number">1e-5</span>);
            } <span class="kw">else if </span>r == <span class="number">2 </span>{
                <span class="macro">assert!</span>(heat_flow &gt; <span class="number">1e-5</span>);
            } <span class="kw">else </span>{
                <span class="comment">// it is Zero
                </span><span class="macro">assert!</span>(heat_flow.abs() &lt; <span class="number">1e-29</span>);
            }

            <span class="kw">for </span>c <span class="kw">in </span><span class="number">0</span>..<span class="number">3 </span>{
                <span class="kw">let </span>v = k.get(r, c).unwrap();

                <span class="kw">if </span>c == r {
                    <span class="comment">// Diagonal
                    </span><span class="kw">if </span>c == <span class="number">0 </span>{
                        <span class="comment">// Exterior node...
                        </span><span class="macro">assert!</span>((v - (-front_hs - u)).abs() &lt; <span class="number">1e-20</span>);
                    } <span class="kw">else if </span>c == n {
                        <span class="comment">// interior node
                        </span><span class="macro">assert!</span>((v - (-back_hs - u)).abs() &lt; <span class="number">1e-20</span>);
                    } <span class="kw">else </span>{
                        <span class="comment">// Any other node.
                        </span><span class="macro">assert!</span>((v - (-<span class="number">2. </span>* u)).abs() &lt; <span class="number">1e-20</span>);
                    }
                } <span class="kw">else </span>{
                    <span class="comment">// Not diagonal
                    </span><span class="kw">let </span>r = r <span class="kw">as </span>i32;
                    <span class="kw">let </span>c = c <span class="kw">as </span>i32;
                    <span class="kw">if </span>(c - r).abs() &lt;= <span class="number">1 </span>{
                        <span class="comment">// if it is within tri-diagonal
                        </span><span class="macro">assert!</span>((v - u).abs() &lt; <span class="number">1e-20</span>);
                    } <span class="kw">else </span>{
                        <span class="comment">// if not
                        </span><span class="macro">assert!</span>(v.abs() &lt; <span class="number">1e-29</span>);
                    }
                }
            }
        }
    }

    <span class="attribute">#[test]
    </span><span class="kw">fn </span>test_get_q_k_solid_partial_2() {
        <span class="kw">let </span>n = <span class="number">5</span>;
        <span class="kw">let </span>thickness = <span class="number">0.5</span>;
        <span class="kw">let </span>thermal_cond = <span class="number">0.1</span>;

        <span class="kw">let </span>dx = thickness / n <span class="kw">as </span>Float;
        <span class="kw">let </span>u = thermal_cond / dx;
        <span class="kw">let </span>(d, temperatures, front_env, front_hs, back_env, back_hs) =
            get_solid_test_system(thickness, thermal_cond);

        <span class="kw">let </span>front_rad_hs = <span class="number">1.0</span>;
        <span class="kw">let </span>back_rad_hs = <span class="number">1.0</span>;
        <span class="kw">let </span>(k, q) = d.get_k_q(
            <span class="number">2</span>,
            <span class="number">5</span>,
            <span class="kw-2">&amp;</span>temperatures,
            <span class="kw-2">&amp;</span>front_env,
            front_hs,
            front_rad_hs,
            <span class="kw-2">&amp;</span>back_env,
            back_hs,
            back_rad_hs,
        );
        <span class="macro">println!</span>(<span class="string">&quot;k = {}&quot;</span>, k);
        <span class="macro">println!</span>(<span class="string">&quot;heat_flows = {}&quot;</span>, q);

        <span class="kw">for </span>r <span class="kw">in </span><span class="number">0</span>..<span class="number">3 </span>{
            <span class="comment">// Check q
            </span><span class="kw">let </span>heat_flow = q.get(r, <span class="number">0</span>).unwrap();
            <span class="kw">if </span>r == <span class="number">1 </span>{
                <span class="comment">// This element is Zero
                </span><span class="macro">assert!</span>(heat_flow.abs() &lt; <span class="number">1e-29</span>);
            } <span class="kw">else </span>{
                <span class="comment">// This should not be Zero
                </span><span class="macro">assert!</span>(heat_flow.abs() &gt; <span class="number">1e-3</span>);
            }

            <span class="kw">for </span>c <span class="kw">in </span><span class="number">0</span>..<span class="number">3 </span>{
                <span class="kw">let </span>v = k.get(r, c).unwrap();

                <span class="kw">if </span>c == r {
                    <span class="comment">// Diagonal
                    </span><span class="kw">if </span>c == <span class="number">0 </span>{
                        <span class="comment">// Exterior node...
                        </span><span class="macro">assert!</span>((v - (-<span class="number">2. </span>* u)).abs() &lt; <span class="number">1e-20</span>);
                    } <span class="kw">else if </span>c == n {
                        <span class="comment">// interior node
                        </span><span class="macro">assert!</span>((v - (-<span class="number">2. </span>* u)).abs() &lt; <span class="number">1e-20</span>);
                    } <span class="kw">else </span>{
                        <span class="comment">// Any other node.
                        </span><span class="macro">assert!</span>((v - (-<span class="number">2. </span>* u)).abs() &lt; <span class="number">1e-20</span>);
                    }
                } <span class="kw">else </span>{
                    <span class="comment">// Not diagonal
                    </span><span class="kw">let </span>r = r <span class="kw">as </span>i32;
                    <span class="kw">let </span>c = c <span class="kw">as </span>i32;
                    <span class="kw">if </span>(c - r).abs() &lt;= <span class="number">1 </span>{
                        <span class="comment">// if it is within tri-diagonal
                        </span><span class="macro">assert!</span>((v - u).abs() &lt; <span class="number">1e-20</span>);
                    } <span class="kw">else </span>{
                        <span class="comment">// if not
                        </span><span class="macro">assert!</span>(v.abs() &lt; <span class="number">1e-29</span>);
                    }
                }
            }
        }
    }

    <span class="attribute">#[test]
    </span><span class="kw">fn </span>test_get_q_k_partial() {
        <span class="kw">let </span>thickness = <span class="number">0.5</span>;
        <span class="kw">let </span>n = <span class="number">5</span>;
        <span class="kw">let </span>dx = thickness / n <span class="kw">as </span>Float;
        <span class="kw">let </span>thermal_cond = <span class="number">1.</span>;
        <span class="kw">let </span>u = thermal_cond / dx;

        <span class="kw">let </span><span class="kw-2">mut </span>segments = Vec::with_capacity(n + <span class="number">1</span>);
        <span class="kw">for _ in </span><span class="number">0</span>..n {
            segments.push((<span class="number">0.0</span>, UValue::Solid(u)));
        }
        segments.push((<span class="number">0.0</span>, UValue::Back));
        <span class="macro">assert_eq!</span>(segments.len(), n + <span class="number">1</span>);

        <span class="kw">let </span>d = Discretization {
            segments,
            tstep_subdivision: <span class="number">1</span>,
            n_elements: <span class="macro">vec!</span>[n],
        };

        <span class="kw">let </span>front_env = ConvectionParams {
            air_temperature: <span class="number">1.</span>,
            air_speed: <span class="number">0.</span>,
            rad_temperature: <span class="number">0.</span>,
            ..ConvectionParams::default()
        };

        <span class="kw">let </span>back_env = ConvectionParams {
            air_temperature: <span class="number">6.</span>,
            air_speed: <span class="number">0.</span>,
            rad_temperature: <span class="number">5.</span>,
            ..ConvectionParams::default()
        };

        <span class="kw">let </span>temperatures = Matrix::from_data(n + <span class="number">1</span>, <span class="number">1</span>, <span class="macro">vec!</span>[<span class="number">1.</span>, <span class="number">2.</span>, <span class="number">3.</span>, <span class="number">4.</span>, <span class="number">5.</span>, <span class="number">6.</span>]);
        <span class="kw">let </span>front_hs = <span class="number">1.739658084820765</span>;
        <span class="kw">let </span>back_hs = <span class="number">1.739658084820765</span>;
        <span class="kw">let </span>front_rad_hs = <span class="number">1.0</span>;
        <span class="kw">let </span>back_rad_hs = <span class="number">1.0</span>;
        <span class="kw">let </span>(k, q) = d.get_k_q(
            <span class="number">1</span>,
            n,
            <span class="kw-2">&amp;</span>temperatures,
            <span class="kw-2">&amp;</span>front_env,
            front_hs,
            front_rad_hs,
            <span class="kw-2">&amp;</span>back_env,
            back_hs,
            back_rad_hs,
        );
        <span class="macro">println!</span>(<span class="string">&quot;k = {}&quot;</span>, k);
        <span class="macro">println!</span>(<span class="string">&quot;heat_flows = {}&quot;</span>, q);

        <span class="kw">for </span>r <span class="kw">in </span><span class="number">0</span>..n - <span class="number">1 </span>{
            <span class="comment">// Check q
            </span><span class="kw">let </span>heat_flow = q.get(r, <span class="number">0</span>).unwrap();
            <span class="kw">if </span>r == <span class="number">0 </span>{
                <span class="macro">assert!</span>(heat_flow &gt; <span class="number">1e-5</span>);
            } <span class="kw">else if </span>r == n - <span class="number">2 </span>{
                <span class="macro">assert!</span>(heat_flow &gt; <span class="number">1e-5</span>);
            } <span class="kw">else </span>{
                <span class="macro">assert!</span>(heat_flow.abs() &lt; <span class="number">1e-29</span>);
            }

            <span class="kw">for </span>c <span class="kw">in </span><span class="number">0</span>..n - <span class="number">1 </span>{
                <span class="kw">let </span>v = k.get(r, c).unwrap();

                <span class="kw">if </span>c == r {
                    <span class="comment">// Diagonal
                    </span><span class="kw">if </span>c == <span class="number">0 </span>{
                        <span class="comment">// Exterior node
                        </span><span class="macro">assert!</span>((v + <span class="number">2. </span>* u).abs() &lt; <span class="number">1e-20</span>, <span class="string">&quot;v = {} | found = {}&quot;</span>, v, <span class="number">2. </span>* u);
                    } <span class="kw">else if </span>c == n - <span class="number">2 </span>{
                        <span class="comment">// interior node
                        </span><span class="macro">assert!</span>((v - (-<span class="number">2. </span>* u)).abs() &lt; <span class="number">1e-20</span>);
                    } <span class="kw">else </span>{
                        <span class="comment">// Any other node.
                        </span><span class="macro">assert!</span>((v - (-<span class="number">2. </span>* u)).abs() &lt; <span class="number">1e-20</span>);
                    }
                } <span class="kw">else </span>{
                    <span class="comment">// Not diagonal
                    </span><span class="kw">let </span>r = r <span class="kw">as </span>i32;
                    <span class="kw">let </span>c = c <span class="kw">as </span>i32;
                    <span class="kw">if </span>(c - r).abs() &lt;= <span class="number">1 </span>{
                        <span class="comment">// if it is within tri-diagonal
                        </span><span class="macro">assert!</span>((v - u).abs() &lt; <span class="number">1e-20</span>);
                    } <span class="kw">else </span>{
                        <span class="comment">// if not
                        </span><span class="macro">assert!</span>(v.abs() &lt; <span class="number">1e-29</span>);
                    }
                }
            }
        }
    }

    <span class="attribute">#[test]
    </span><span class="kw">fn </span>test_get_chunks() {
        <span class="comment">// Single node, massive
        </span><span class="kw">let </span>d = Discretization {
            tstep_subdivision: <span class="number">1</span>,
            segments: <span class="macro">vec!</span>[(<span class="number">1.</span>, UValue::None)],
            n_elements: <span class="macro">vec!</span>[<span class="number">1</span>], <span class="comment">// Does not matter for this test
        </span>};

        <span class="kw">let </span>(mass_chunks, nomass_chunks) = d.get_chunks();
        <span class="macro">assert!</span>(nomass_chunks.is_empty());
        <span class="macro">assert_eq!</span>(mass_chunks.len(), <span class="number">1</span>);
        <span class="macro">assert_eq!</span>(mass_chunks, <span class="macro">vec!</span>[(<span class="number">0</span>, <span class="number">1</span>)]);

        <span class="comment">// Single node, no-mass
        </span><span class="kw">let </span>d = Discretization {
            tstep_subdivision: <span class="number">1</span>,
            segments: <span class="macro">vec!</span>[(<span class="number">0.</span>, UValue::None)],
            n_elements: <span class="macro">vec!</span>[<span class="number">1</span>], <span class="comment">// Does not matter for this test
        </span>};

        <span class="kw">let </span>(mass_chunks, nomass_chunks) = d.get_chunks();
        <span class="macro">assert!</span>(mass_chunks.is_empty());
        <span class="macro">assert_eq!</span>(nomass_chunks.len(), <span class="number">1</span>);
        <span class="macro">assert_eq!</span>(nomass_chunks, <span class="macro">vec!</span>[(<span class="number">0</span>, <span class="number">1</span>)]);

        <span class="comment">// Several nodes, massive
        </span><span class="kw">let </span>d = Discretization {
            tstep_subdivision: <span class="number">1</span>,
            segments: <span class="macro">vec!</span>[(<span class="number">1.</span>, UValue::None); <span class="number">10</span>],
            n_elements: <span class="macro">vec!</span>[<span class="number">1</span>], <span class="comment">// Does not matter for this test
        </span>};

        <span class="kw">let </span>(mass_chunks, nomass_chunks) = d.get_chunks();
        <span class="macro">assert!</span>(nomass_chunks.is_empty());
        <span class="macro">assert_eq!</span>(mass_chunks.len(), <span class="number">1</span>);
        <span class="macro">assert_eq!</span>(mass_chunks, <span class="macro">vec!</span>[(<span class="number">0</span>, <span class="number">10</span>)]);

        <span class="comment">// Several nodes, no-mass
        </span><span class="kw">let </span>d = Discretization {
            tstep_subdivision: <span class="number">1</span>,
            segments: <span class="macro">vec!</span>[(<span class="number">0.</span>, UValue::None); <span class="number">10</span>],
            n_elements: <span class="macro">vec!</span>[<span class="number">1</span>], <span class="comment">// Does not matter for this test
        </span>};

        <span class="kw">let </span>(mass_chunks, nomass_chunks) = d.get_chunks();
        <span class="macro">assert!</span>(mass_chunks.is_empty());
        <span class="macro">assert_eq!</span>(nomass_chunks.len(), <span class="number">1</span>);
        <span class="macro">assert_eq!</span>(nomass_chunks, <span class="macro">vec!</span>[(<span class="number">0</span>, <span class="number">10</span>)]);

        <span class="comment">// Mixed 1
        </span><span class="kw">let </span>d = Discretization {
            tstep_subdivision: <span class="number">1</span>,
            segments: <span class="macro">vec!</span>[
                (<span class="number">0.</span>, UValue::None),
                (<span class="number">1.</span>, UValue::None),
                (<span class="number">1.</span>, UValue::None),
                (<span class="number">0.</span>, UValue::None),
                (<span class="number">0.</span>, UValue::None),
            ],
            n_elements: <span class="macro">vec!</span>[<span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>], <span class="comment">// Does not matter for this test
        </span>};

        <span class="kw">let </span>(mass_chunks, nomass_chunks) = d.get_chunks();
        <span class="macro">assert_eq!</span>(mass_chunks.len(), <span class="number">1</span>);
        <span class="macro">assert_eq!</span>(mass_chunks, <span class="macro">vec!</span>[(<span class="number">1</span>, <span class="number">3</span>)]);
        <span class="macro">assert_eq!</span>(nomass_chunks.len(), <span class="number">2</span>);
        <span class="macro">assert_eq!</span>(nomass_chunks, <span class="macro">vec!</span>[(<span class="number">0</span>, <span class="number">1</span>), (<span class="number">3</span>, <span class="number">5</span>)]);

        <span class="comment">// Mixed 2
        </span><span class="kw">let </span>d = Discretization {
            tstep_subdivision: <span class="number">1</span>,
            segments: <span class="macro">vec!</span>[
                (<span class="number">1.</span>, UValue::None),
                (<span class="number">1.</span>, UValue::None),
                (<span class="number">1.</span>, UValue::None),
                (<span class="number">0.</span>, UValue::None),
                (<span class="number">0.</span>, UValue::None),
            ],
            n_elements: <span class="macro">vec!</span>[<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>], <span class="comment">// Does not matter for this test
        </span>};

        <span class="kw">let </span>(mass_chunks, nomass_chunks) = d.get_chunks();
        <span class="macro">assert_eq!</span>(mass_chunks.len(), <span class="number">1</span>);
        <span class="macro">assert_eq!</span>(mass_chunks, <span class="macro">vec!</span>[(<span class="number">0</span>, <span class="number">3</span>)]);
        <span class="macro">assert_eq!</span>(nomass_chunks.len(), <span class="number">1</span>);
        <span class="macro">assert_eq!</span>(nomass_chunks, <span class="macro">vec!</span>[(<span class="number">3</span>, <span class="number">5</span>)]);
    }
}
</code></pre></div>
</section></div></main><div id="rustdoc-vars" data-root-path="../../" data-current-crate="heat" data-themes="ayu,dark,light" data-resource-suffix="" data-rustdoc-version="1.65.0 (897e37553 2022-11-02)" ></div></body></html>